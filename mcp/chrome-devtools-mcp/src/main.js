/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import"./polyfill.js";import e from"node:process";import{ensureBrowserConnected as r,ensureBrowserLaunched as o}from"./browser.js";import{launchNativeChrome as t,isNativeChromeRunning as a,killNativeChrome as s}from"./BrowserManager_utils.js";import{parseArguments as n}from"./cli.js";import{loadIssueDescriptions as i}from"./issue-descriptions.js";import{logger as c,saveLogsToFile as l}from"./logger.js";import{McpContext as g}from"./McpContext.js";import{McpResponse as d}from"./McpResponse.js";import{Mutex as p}from"./Mutex.js";import{McpServer as m,StdioServerTransport as u,SetLevelRequestSchema as h}from"./third_party/index.js";import{ToolCategory as w}from"./tools/categories.js";import{tools as v}from"./tools/tools.js";const f="0.12.1";export const args=n(f);const x=args.logFile?l(args.logFile):void 0;e.on("unhandledRejection",(e,r)=>{c("Unhandled promise rejection",r,e)}),c(`Starting Chrome DevTools MCP Server v${f}`);const y=new m({name:"chrome_devtools",title:"Chrome DevTools MCP server",version:f},{capabilities:{logging:{}}});let C;y.server.setRequestHandler(h,()=>({}));let D=null;async function P(){const e=(args.chromeArg??[]).map(String),o=args.experimentalDevtools??!1,s=9222;await a(s)?c("Chrome already running on port 9222, connecting..."):(c("Launching native Chrome with CDP (reduced detection mode)..."),D=await t({cdpPort:s,userDataDir:args.userDataDir,headless:args.headless,additionalArgs:e,devtools:o,proxyServer:args.proxyServer,noSandbox:args.noSandbox}),c(`Native Chrome launched, CDP available at ${D.cdpUrl}`));return await r({browserURL:"http://127.0.0.1:9222",devtools:o})}async function b(){const e=(args.chromeArg??[]).map(String);args.proxyServer&&e.push(`--proxy-server=${args.proxyServer}`);const t=args.experimentalDevtools??!1,a=!1!==args.nativeLaunch,s={headless:args.headless,executablePath:args.executablePath,channel:args.channel,isolated:args.isolated??!1,userDataDir:args.userDataDir,logFile:x,viewport:args.viewport,args:e,acceptInsecureCerts:args.acceptInsecureCerts,devtools:t};let n;if(args.browserUrl||args.wsEndpoint||args.autoConnect)n=await r({...s,browserURL:args.browserUrl,wsEndpoint:args.wsEndpoint,wsHeaders:args.wsHeaders,channel:args.autoConnect?args.channel:void 0});else if(a&&args.cdpUrl)try{c(`Trying CDP connection to ${args.cdpUrl} (CDP-first mode for reduced detection)`),n=await r({...s,browserURL:args.cdpUrl}),c("Successfully connected via CDP to existing Chrome")}catch(e){c(`CDP connection failed: ${e instanceof Error?e.message:String(e)}`),c("Launching native Chrome with CDP..."),n=await P()}else a?n=await P():(c("Native launch disabled, using Puppeteer launch..."),n=await o(s));return C?.browser!==n&&(C=await g.from(n,c,{experimentalDevToolsDebugging:t,experimentalIncludeAllPages:args.experimentalIncludeAllPages,proxyAuth:args.proxyUsername&&args.proxyPassword?{username:args.proxyUsername,password:args.proxyPassword}:void 0,launchOptions:s})),C}e.on("exit",()=>{s()}),e.on("SIGINT",()=>{s(),e.exit(0)}),e.on("SIGTERM",()=>{s(),e.exit(0)});const S=new p;function j(e){e.annotations&&e.annotations.category&&(e.annotations.category===w.EMULATION&&!1===args.categoryEmulation||e.annotations.category===w.NETWORK&&!1===args.categoryNetwork||y.registerTool(e.name,{description:e.description,inputSchema:e.schema,annotations:e.annotations},async r=>{const o=await S.acquire();try{c(`${e.name} request: ${JSON.stringify(r,null,"  ")}`);const o=await b();c(`${e.name} context: resolved`),await o.detectOpenDevToolsWindows();const t=new d;await e.handler({params:r},t,o);return{content:await t.handle(e.name,o)}}catch(r){c(`${e.name} error:`,r,r?.stack);let o=r&&"message"in r?r.message:String(r);return"cause"in r&&r.cause&&(o+=`\nCause: ${r.cause.message}`),{content:[{type:"text",text:o}],isError:!0}}finally{o.dispose()}}))}for(const e of v)j(e);await i();const U=new u;await y.connect(U),c("Chrome DevTools MCP Server connected"),console.error("chrome-devtools-mcp exposes content of the browser instance to the MCP clients allowing them to inspect,\ndebug, and modify any data in the browser or DevTools.\nAvoid sharing sensitive or personal information that you do not want to share with MCP clients.");