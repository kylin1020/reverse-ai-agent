/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import e from"node:fs";import o from"node:os";import t from"node:path";import{logger as r}from"./logger.js";const n="0.12.1";let s;export function getUserAgent(){if(s)return s;const e=`${o.platform()} ${o.arch()}`;return s=`ChromeDevToolsMCP/${n} (${e})`,s}export function getVersion(){return n}export class BrowserStatusManager{status={type:"disconnected"};listeners=new Set;getStatus(){return this.status}setStatus(e){this.status=e;for(const o of this.listeners)try{o(e)}catch(e){r(`Error in status listener: ${e}`)}}onStatusChange(e){return this.listeners.add(e),()=>this.listeners.delete(e)}isConnected(){return"connected"===this.status.type}}export const browserStatusManager=new BrowserStatusManager;export async function getSelfCdpUrl(e=9222){for(let o=0;o<=2;o++){const t=new AbortController,n=setTimeout(()=>t.abort(),3e3);try{const o=await fetch(`http://localhost:${e}/json/version`,{signal:t.signal});if(!o.ok)throw new Error(`Failed to fetch CDP version info: ${o.status} ${o.statusText}`);const r=await o.json();if("object"==typeof r&&null!==r&&"webSocketDebuggerUrl"in r&&"string"==typeof r.webSocketDebuggerUrl)return r.webSocketDebuggerUrl;throw new Error("`webSocketDebuggerUrl` is missing or not a string in response")}catch(e){const t=2===o,n=e instanceof Error?e.message:String(e);if(r(`Attempt ${o+1} to fetch CDP URL failed: ${n}`),t)throw r(`Failed to retrieve CDP URL after retries: ${e}`),e;await new Promise(e=>setTimeout(e,500))}finally{clearTimeout(n)}}throw new Error("Unexpected error fetching CDP URL")}export async function getCdpTargets(e=9222){try{const o=await fetch(`http://localhost:${e}/json/list`);if(!o.ok)throw new Error(`Failed to fetch CDP targets: ${o.status}`);return await o.json()}catch(e){return r(`Error listing CDP targets: ${e}`),[]}}export function expandPath(e,r){if(!e)return e;if(e.startsWith("~"))return t.join(o.homedir(),e.slice(1));if(e.startsWith("./")||"."===e){const o=r??process.cwd();return t.join(o,e.replace(/^\./,""))}return e}export function expandCommandPath(e,o){const t=e.split(" ");for(let e=0;e<t.length;e++)t[e]=expandPath(t[e],o)??t[e];return t.join(" ")}export async function getChromeExecutablePath(){const n=o.platform(),s=[];switch(n){case"darwin":s.push("/Applications/Google Chrome.app/Contents/MacOS/Google Chrome","/Applications/Google Chrome Beta.app/Contents/MacOS/Google Chrome Beta","/Applications/Google Chrome Dev.app/Contents/MacOS/Google Chrome Dev","/Applications/Google Chrome Canary.app/Contents/MacOS/Google Chrome Canary","/Applications/Chromium.app/Contents/MacOS/Chromium");break;case"win32":{const e=process.env.PROGRAMFILES||"C:\\Program Files",r=process.env["PROGRAMFILES(X86)"]||"C:\\Program Files (x86)",n=process.env.LOCALAPPDATA||t.join(o.homedir(),"AppData","Local");s.push(t.join(e,"Google","Chrome","Application","chrome.exe"),t.join(r,"Google","Chrome","Application","chrome.exe"),t.join(n,"Google","Chrome","Application","chrome.exe"),t.join(e,"Google","Chrome Beta","Application","chrome.exe"),t.join(r,"Google","Chrome Beta","Application","chrome.exe"),t.join(n,"Google","Chrome Beta","Application","chrome.exe"),t.join(e,"Google","Chrome Dev","Application","chrome.exe"),t.join(r,"Google","Chrome Dev","Application","chrome.exe"),t.join(n,"Google","Chrome Dev","Application","chrome.exe"),t.join(e,"Google","Chrome SxS","Application","chrome.exe"),t.join(r,"Google","Chrome SxS","Application","chrome.exe"),t.join(n,"Google","Chrome SxS","Application","chrome.exe"),t.join(e,"Chromium","Application","chrome.exe"),t.join(r,"Chromium","Application","chrome.exe"),t.join(n,"Chromium","Application","chrome.exe"));break}case"linux":s.push("/usr/bin/google-chrome","/usr/bin/google-chrome-stable","/usr/bin/google-chrome-beta","/usr/bin/google-chrome-unstable","/usr/bin/chromium-browser","/usr/bin/chromium","/snap/bin/chromium","/var/lib/snapd/snap/bin/chromium","/usr/local/bin/chrome","/usr/local/bin/google-chrome");break;default:return void r(`Unsupported platform: ${n}`)}for(const o of s)try{return await e.promises.access(o),r(`Found Chrome executable at: ${o}`),o}catch{continue}r(`No Chrome executable found on ${n}. Checked paths: ${s.join(", ")}`)}const i=[{width:1920,height:1080},{width:1440,height:900},{width:1366,height:768},{width:1536,height:864},{width:1280,height:720}];export function getRandomViewport(){return i[Math.floor(Math.random()*i.length)]}export async function randomDelay(e=100,o=500){const t=Math.random()*(o-e)+e;await new Promise(e=>setTimeout(e,t))}export function getTypingDelay(e=50,o=100){return e+Math.random()*o}export function getDefaultPersistentContextDir(){return t.join(o.homedir(),".cache","chrome-devtools-mcp","browser-session")}export async function createTempPersistentContextDir(){const n=t.join(o.tmpdir(),`chrome-devtools-mcp-session-${Date.now()}`);return await e.promises.mkdir(n,{recursive:!0}),r(`Created temporary persistent context directory: ${n}`),n}export async function cleanupPersistentContextDir(t,n=!1){if(n||t.startsWith(o.tmpdir()))try{await e.promises.rm(t,{recursive:!0,force:!0}),r(`Cleaned up persistent context directory: ${t}`)}catch(e){r(`Error cleaning up persistent context directory: ${e}`)}else r(`Preserving persistent context directory: ${t}`)}export function getDefaultBrowserArgs(){return["--enable-extensions","--disable-infobars","--disable-popup-blocking","--hide-crash-restore-bubble","--disable-background-timer-throttling","--disable-backgrounding-occluded-windows","--disable-renderer-backgrounding"]}export function getHeadlessBrowserArgs(){const e=["--screen-info={3840x2160}","--disable-gpu","--disable-software-rasterizer"];return"linux"===o.platform()&&e.push("--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-zygote","--font-render-hinting=none"),e}export function getDevToolsArgs(){return["--auto-open-devtools-for-tabs"]}export function getNoSandboxArgs(){return["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage"]}export function buildBrowserArgs(e){const o=[...getDefaultBrowserArgs()];return e.headless&&o.push(...getHeadlessBrowserArgs()),e.noSandbox&&!e.headless&&o.push(...getNoSandboxArgs()),e.devtools&&o.push(...getDevToolsArgs()),e.additionalArgs&&o.push(...e.additionalArgs),o}const a=t.join(o.homedir(),".cursor","browser-logs");export async function writeSnapshotToFile(o){await e.promises.mkdir(a,{recursive:!0});const n=`snapshot-${(new Date).toISOString().replace(/[:.]/g,"-")}.log`,s=t.join(a,n),i=o.split("\n"),c=i.length,l=i.slice(0,Math.min(50,c));return await e.promises.writeFile(s,o,"utf8"),r(`Large snapshot written to: ${s} (${c} lines, ${l.length} preview lines)`),{filePath:s,previewLines:l,totalLines:c}}export async function cleanupOldLogFiles(){try{if(!await e.promises.access(a).then(()=>!0).catch(()=>!1))return;const o=await e.promises.readdir(a),n=Date.now(),s=6048e5;for(const i of o)if(i.endsWith(".log")){const o=t.join(a,i);try{n-(await e.promises.stat(o)).mtimeMs>s&&(await e.promises.unlink(o),r(`Cleaned up old log file: ${i}`))}catch(e){r(`Failed to clean up log file ${i}: ${e}`)}}}catch(e){r(`Failed to cleanup old log files: ${e}`)}}export function isSnapshotTooLarge(e,o=204800){return Buffer.byteLength(e,"utf8")>o}export function getTempLogDir(){return a}export async function checkBrowserStatus(){const e=await getChromeExecutablePath();return{platform:o.platform(),chromeFound:!!e,chromePath:e||"bundled",nodeVersion:process.version}}import{spawn as c}from"node:child_process";let l=null;export async function launchNativeChrome(n={}){const{cdpPort:s=9222,userDataDir:i,headless:a=!1,additionalArgs:h=[],devtools:p=!1,proxyServer:u,noSandbox:d=!1}=n,m=await getChromeExecutablePath();if(!m)throw new Error("Chrome executable not found. Please install Chrome or specify executablePath.");const g=[`--remote-debugging-port=${s}`,"--no-first-run","--no-default-browser-check","--disable-default-apps","--hide-crash-restore-bubble"],f=i||t.join(o.homedir(),".cache","chrome-devtools-mcp","native-profile");await e.promises.mkdir(f,{recursive:!0}),g.push(`--user-data-dir=${f}`),a&&(g.push("--headless=new"),g.push("--disable-gpu"),g.push("--disable-software-rasterizer"),"linux"===o.platform()&&g.push("--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-zygote","--font-render-hinting=none")),d&&!a&&g.push("--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage"),p&&g.push("--auto-open-devtools-for-tabs"),u&&g.push(`--proxy-server=${u}`),g.push(...h),r(`Launching native Chrome: ${m}`),r(`Chrome args: ${g.join(" ")}`);const b=c(m,g,{detached:!1,stdio:["ignore","pipe","pipe"]});l=b,b.on("error",e=>{r(`Chrome process error: ${e.message}`)}),b.stderr?.on("data",e=>{const o=e.toString();(o.includes("DevTools listening")||o.includes("ERROR")||o.includes("FATAL"))&&r(`Chrome stderr: ${o}`)});const x=`http://127.0.0.1:${s}`;let w="";for(let e=0;e<30;e++)try{w=await getSelfCdpUrl(s),r(`Chrome CDP ready at ${x}, WebSocket: ${w}`);break}catch{if(29===e)throw b.kill(),new Error("Failed to get CDP URL after 30 attempts. Chrome may have failed to start.");await new Promise(e=>setTimeout(e,500))}const C=()=>{l===b&&(l=null)};return b.on("exit",C),b.on("close",C),{process:b,cdpUrl:x,wsUrl:w,kill:()=>{try{b.kill("SIGTERM"),r("Native Chrome process terminated")}catch(e){r(`Error killing Chrome: ${e}`)}}}}export async function isNativeChromeRunning(e=9222){try{return await getSelfCdpUrl(e),!0}catch{return!1}}export function killNativeChrome(){if(l){try{l.kill("SIGTERM"),r("Native Chrome process killed")}catch(e){r(`Error killing native Chrome: ${e}`)}l=null}}export function getNativeChromeProcess(){return l}