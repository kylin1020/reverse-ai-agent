/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{zod as e}from"../third_party/index.js";import{getDebuggerState as a,initializeDebuggerForPage as n}from"../utils/debuggerUtils.js";import{SmartNavigator as o}from"../utils/smartNavigator.js";import{ToolCategory as r}from"./categories.js";import{CLOSE_PAGE_ERROR as t,defineTool as s,timeoutSchema as i}from"./ToolDefinition.js";export const listPages=s({name:"list_pages",description:"Get a list of pages open in the browser.",annotations:{category:r.NAVIGATION,readOnlyHint:!0},schema:{},handler:async(e,a)=>{a.setIncludePages(!0)}});export const selectPage=s({name:"select_page",description:"Select a page as a context for future tool calls.",annotations:{category:r.NAVIGATION,readOnlyHint:!0},schema:{pageIdx:e.number().describe(`The index of the page to select. Call ${listPages.name} to get available pages.`),bringToFront:e.boolean().optional().describe("Whether to focus the page and bring it to the top.")},handler:async(e,a,n)=>{const o=n.getPageByIdx(e.params.pageIdx);n.selectPage(o),a.setIncludePages(!0),e.params.bringToFront&&await o.bringToFront()}});export const closePage=s({name:"close_page",description:"Closes the page by its index. The last open page cannot be closed.",annotations:{category:r.NAVIGATION,readOnlyHint:!1},schema:{pageIdx:e.number().describe("The index of the page to close. Call list_pages to list pages.")},handler:async(e,a,n)=>{try{await n.closePage(e.params.pageIdx)}catch(e){if(e.message!==t)throw e;a.appendResponseLine(e.message)}a.setIncludePages(!0)}});export const newPage=s({name:"new_page",description:"Creates a new page",annotations:{category:r.NAVIGATION,readOnlyHint:!1},schema:{url:e.string().describe("URL to load in a new page."),incognito:e.boolean().optional().describe("Whether to open the page in a new incognito window."),newWindow:e.boolean().optional().describe("Whether to open the page in a new window."),userDataDir:e.string().optional().describe("Optional independent resource directory (user data directory). If provided, a new browser instance with its own window will be started."),enableDebugger:e.boolean().optional().describe("Whether to enable the JavaScript debugger for the new page. Default is true."),...i},handler:async(e,a,n)=>{const r=await n.newPage({incognito:e.params.incognito,newWindow:e.params.newWindow,userDataDir:e.params.userDataDir,enableDebugger:e.params.enableDebugger}),t=new o(r);let s;switch(await n.waitForEventsAfterAction(async()=>{s=await t.navigateToUrl(e.params.url,{timeout:e.params.timeout,debuggerEnabled:!1!==e.params.enableDebugger})}),s.status){case"loaded":a.appendResponseLine(`Successfully created new page and navigated to ${s.url??e.params.url}.`);break;case"paused":if(a.appendResponseLine(`Created new page and navigated to ${e.params.url}. Debugger is paused.`),s.callFrames&&s.callFrames.length>0){const e=s.callFrames[0];a.appendResponseLine(`Paused at: ${e.functionName||"(anonymous)"} (${e.url}:${e.location.lineNumber+1})`)}break;case"timeout":a.appendResponseLine(`Created new page but navigation to ${e.params.url} timed out: ${s.error}`);break;case"error":a.appendResponseLine(`Created new page but unable to navigate to ${e.params.url}: ${s.error}`)}a.setIncludePages(!0)}});export const navigatePage=s({name:"navigate_page",description:"Navigates the currently selected page to a URL.",annotations:{category:r.NAVIGATION,readOnlyHint:!1},schema:{type:e.enum(["url","back","forward","reload"]).optional().describe("Navigate the page by URL, back or forward in history, or reload."),url:e.string().optional().describe("Target URL (only type=url)"),ignoreCache:e.boolean().optional().describe("Whether to ignore cache on reload."),enableDebugger:e.boolean().optional().describe("Whether to enable the JavaScript debugger after navigation. Default is true."),...i},handler:async(e,r,t)=>{const s=t.getSelectedPage();if(!e.params.type&&!e.params.url)throw new Error("Either URL or a type is required.");if(e.params.type||(e.params.type="url"),!1===e.params.enableDebugger){a(s).userDisabled=!0}else!0===e.params.enableDebugger&&await n(s,{forceEnable:!0});const i=new o(s);await t.waitForEventsAfterAction(async()=>{switch(e.params.type){case"url":{if(!e.params.url)throw new Error("A URL is required for navigation of type=url.");const a=await i.navigateToUrl(e.params.url,{timeout:e.params.timeout,debuggerEnabled:!1!==e.params.enableDebugger});switch(a.status){case"loaded":r.appendResponseLine(`Successfully navigated to ${a.url??e.params.url}.`);break;case"paused":if(r.appendResponseLine(`Navigated to ${e.params.url}. Debugger is paused.`),a.callFrames&&a.callFrames.length>0){const e=a.callFrames[0];r.appendResponseLine(`Paused at: ${e.functionName||"(anonymous)"} (${e.url}:${e.location.lineNumber+1})`)}break;case"timeout":r.appendResponseLine(`Navigation to ${e.params.url} timed out: ${a.error}`);break;case"error":r.appendResponseLine(`Unable to navigate to ${e.params.url}: ${a.error}.`)}break}case"back":{const a=await i.navigateBack({timeout:e.params.timeout,debuggerEnabled:!1!==e.params.enableDebugger});switch(a.status){case"loaded":r.appendResponseLine(`Successfully navigated back to ${a.url??s.url()}.`);break;case"paused":if(r.appendResponseLine("Navigated back. Debugger is paused."),a.callFrames&&a.callFrames.length>0){const e=a.callFrames[0];r.appendResponseLine(`Paused at: ${e.functionName||"(anonymous)"} (${e.url}:${e.location.lineNumber+1})`)}break;case"timeout":r.appendResponseLine(`Navigate back timed out: ${a.error}`);break;case"error":r.appendResponseLine(`Unable to navigate back in the selected page: ${a.error}.`)}break}case"forward":{const a=await i.navigateForward({timeout:e.params.timeout,debuggerEnabled:!1!==e.params.enableDebugger});switch(a.status){case"loaded":r.appendResponseLine(`Successfully navigated forward to ${a.url??s.url()}.`);break;case"paused":if(r.appendResponseLine("Navigated forward. Debugger is paused."),a.callFrames&&a.callFrames.length>0){const e=a.callFrames[0];r.appendResponseLine(`Paused at: ${e.functionName||"(anonymous)"} (${e.url}:${e.location.lineNumber+1})`)}break;case"timeout":r.appendResponseLine(`Navigate forward timed out: ${a.error}`);break;case"error":r.appendResponseLine(`Unable to navigate forward in the selected page: ${a.error}.`)}break}case"reload":{const a=await i.reload({timeout:e.params.timeout,ignoreCache:e.params.ignoreCache,debuggerEnabled:!1!==e.params.enableDebugger});switch(a.status){case"loaded":r.appendResponseLine("Successfully reloaded the page.");break;case"paused":if(r.appendResponseLine("Reloaded the page. Debugger is paused."),a.callFrames&&a.callFrames.length>0){const e=a.callFrames[0];r.appendResponseLine(`Paused at: ${e.functionName||"(anonymous)"} (${e.url}:${e.location.lineNumber+1})`)}break;case"timeout":r.appendResponseLine(`Reload timed out: ${a.error}`);break;case"error":r.appendResponseLine(`Unable to reload the selected page: ${a.error}.`)}break}}}),r.setIncludePages(!0)}});export const clearCookies=s({name:"clear_cookies",description:"Clear browser cookies for all sites or a specific domain.",annotations:{category:r.NAVIGATION,readOnlyHint:!1},schema:{url:e.string().optional().describe("Optional URL to clear cookies for a specific domain. If not provided, clears all cookies.")},handler:async(e,a,n)=>{const o=n.getSelectedPage(),r=o.browserContext();if(e.params.url){let n;try{const a=new URL(e.params.url);n=a.hostname}catch{return void a.appendResponseLine(`Failed to clear cookies: Invalid URL format "${e.params.url}".`)}try{const e=(await r.cookies()).filter(e=>e.domain===n||e.domain===`.${n}`||n.endsWith(e.domain.replace(/^\./,"")));if(0===e.length)return void a.appendResponseLine(`No cookies found for domain ${n}.`);for(const a of e)await o.deleteCookie(a);a.appendResponseLine(`Cleared ${e.length} cookie(s) for domain ${n}.`)}catch(e){a.appendResponseLine(`Failed to clear cookies: ${e.message}`)}}else try{const e=await r.cookies(),n=e.length;for(const a of e)await o.deleteCookie(a);a.appendResponseLine(`Cleared ${n} cookie(s) from browser.`)}catch(e){a.appendResponseLine(`Failed to clear cookies: ${e.message}`)}}});