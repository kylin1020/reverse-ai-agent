/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import*as e from"node:fs/promises";import*as t from"node:path";import{zod as n}from"../third_party/index.js";import{getCdpSession as r}from"../utils/cdp.js";import{getScriptCache as i}from"../utils/smartBreakpointUtils.js";import{ToolCategory as a}from"./categories.js";import{defineTool as s}from"./ToolDefinition.js";async function o(e,t){const{type:n,subtype:r,objectId:a,value:s,description:o,unserializableValue:u,preview:l}=t;if("undefined"===n)return{value:"undefined"};if("null"===r)return{value:"null"};if(u)return{value:u};if("boolean"===n||"number"===n||"bigint"===n)return{value:String(s)};if("string"===n)return{value:JSON.stringify(s)};if("symbol"===n)return{value:o||"Symbol()"};if("function"===n&&a){const t=await async function(e,t){try{const n=await e.send("Runtime.getProperties",{objectId:t,ownProperties:!1}),r=n.internalProperties?.find(e=>"[[FunctionLocation]]"===e.name);if(r?.value?.value){const{scriptId:t,lineNumber:n,columnNumber:a}=r.value.value,s=i(e).get(t);return`${s?.url||`VM${t}`}:${n+1}:${a+1}`}}catch{}return}(e,a);return{value:o||"[Function]",location:t}}if("node"===r&&a){const t=await async function(e,t){try{return(await e.send("Runtime.callFunctionOn",{objectId:t,functionDeclaration:"function() {\n        const el = this;\n        if (el.nodeType === 1) {\n          let s = '<' + el.tagName.toLowerCase();\n          if (el.id) s += ' id=\"' + el.id + '\"';\n          if (el.className) s += ' class=\"' + el.className + '\"';\n          s += '>';\n          return s;\n        }\n        return el.nodeName;\n      }",returnByValue:!0})).result.value}catch{return}}(e,a);return{value:t||o||"[Node]"}}if("array"===r&&a){return{value:await c(e,a)||o||"[]"}}if("regexp"===r||"date"===r||"map"===r||"set"===r||"error"===r)return{value:o||`[${r}]`};if("promise"===r&&l)return{value:o||"Promise"};if("object"===n&&a){return{value:await c(e,a)||o||"[Object]"}}return{value:o||`[${n}]`}}async function c(e,t){try{return(await e.send("Runtime.callFunctionOn",{objectId:t,functionDeclaration:"function() {\n        try {\n          return JSON.stringify(this, null, 2);\n        } catch {\n          return null;\n        }\n      }",returnByValue:!0})).result.value??void 0}catch{return}}export const saveScriptSource=s({name:"save_script_source",description:"Save a script source to a local file. Use VM<id> pattern to match by scriptId, otherwise matches by URL substring.",annotations:{category:a.DEBUGGING,readOnlyHint:!1},schema:{pattern:n.string().describe('Pattern to match script. If starts with "VM" (e.g., "VM123"), matches by scriptId. Otherwise matches by URL substring. Saves the first match.'),filePath:n.string().describe("Path to save the script file.")},handler:async(n,a,s)=>{const{pattern:o,filePath:c}=n.params,u=s.getSelectedPage(),l=await r(u);try{let n,r;const s=o.match(/^VM(\d+)$/i);if(s)n=s[1];else{const e=i(l);for(const[t,i]of e.entries())if(i.url&&i.url.includes(o)){n=t,r=i.url;break}}if(!n)return void a.appendResponseLine(`Error: No script found matching pattern "${o}".`);const u=(await l.send("Debugger.getScriptSource",{scriptId:n})).scriptSource;if(!u)return void a.appendResponseLine(`Error: Script ${n} has no source available.`);const p=t.resolve(c);await e.mkdir(t.dirname(p),{recursive:!0}),await e.writeFile(p,u,"utf-8"),a.appendResponseLine(`Saved script to ${p}`),r&&a.appendResponseLine(`Matched URL: ${r}`),a.appendResponseLine(`ScriptId: ${n}, Size: ${u.length} bytes`)}catch(e){a.appendResponseLine(`Error: ${e instanceof Error?e.message:String(e)}`)}}});export const evaluateScript=s({name:"evaluate_script",description:"Evaluate JavaScript code inside the currently selected page, similar to DevTools Console.\nSupports any valid JavaScript: expressions, statements, async/await, etc.\nReturns the result value or error message. Output is limited by maxOutputChars to prevent context overflow.",annotations:{category:a.DEBUGGING,readOnlyHint:!1},schema:{script:n.string().describe("JavaScript code to execute in the page context (like DevTools Console).\nExamples:\n- `document.title`\n- `document.querySelectorAll('a').length`\n- `await fetch('/api').then(r => r.json())`\n- `const x = 1; const y = 2; x + y`"),maxOutputChars:n.number().int().positive().optional().describe("Maximum number of characters in the output. Default is 10000. Output exceeding this limit will be truncated.")},handler:async(e,t,n)=>{const i=n.getSelectedPage(),a=e.params.script,s=e.params.maxOutputChars??1e4,c=await r(i);await n.waitForEventsAfterAction(async()=>{const e=await c.send("Runtime.evaluate",{expression:a,awaitPromise:!0,returnByValue:!1,generatePreview:!0,userGesture:!0,replMode:!0});if(e.exceptionDetails){const n=u(function(e){if(e.exception?.description)return e.exception.description;if(e.text){const t=void 0!==e.lineNumber?` at line ${e.lineNumber+1}:${(e.columnNumber??0)+1}`:"";return`${e.text}${t}`}return"Unknown error"}(e.exceptionDetails),s);return t.appendResponseLine("‚ùå Error: "+n.text),void(n.truncated&&t.appendResponseLine(`‚ö†Ô∏è Output truncated: ${n.originalLength} chars ‚Üí ${s} chars`))}const n=await o(c,e.result),r=u(n.value,s);t.appendResponseLine(r.text),r.truncated&&(t.appendResponseLine(`‚ö†Ô∏è Output truncated: ${r.originalLength} chars ‚Üí ${s} chars`),t.appendResponseLine("üí° Increase maxOutputChars parameter to see more output.")),n.location&&t.appendResponseLine(`üìç ${n.location}`)})}});function u(e,t){const n=e.length;return n<=t?{text:e,truncated:!1,originalLength:n}:{text:e.substring(0,t)+"\n... <truncated>",truncated:!0,originalLength:n}}