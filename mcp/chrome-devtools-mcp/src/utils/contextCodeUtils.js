/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
export function isMinified(e){if(!e||e.length<100)return!1;const t=e.split("\n").filter(e=>e.trim().length>0);if(0===t.length)return!1;if(t.reduce((e,t)=>e+t.length,0)/t.length>500)return!0;return e.length/t.length>500&&t.length<=5}import*as e from"acorn";export function formatMinifiedCode(t){const n=[];let r;try{r=e.parse(t,{ecmaVersion:"latest",sourceType:"module",allowHashBang:!0,allowAwaitOutsideFunction:!0,allowImportExportEverywhere:!0,allowReserved:!0,locations:!0})}catch(e){return{formattedCode:t,mappings:[],success:!1,error:`AST parsing failed: ${e.message||String(e)}`}}let a="",o=1,s=0,i=0;function l(e){const r=function(e){let n=1,r=-1;for(let a=0;a<e&&a<t.length;a++)"\n"===t[a]&&(n++,r=a);return{line:n,column:e-r-1}}(e);n.push({original:r,formatted:{line:o,column:s}})}function c(e){a+=e;for(const t of e)"\n"===t?(o++,s=0):s++}function u(){c("\n"),c("  ".repeat(i))}function p(e){if(e)switch(l(e.start),e.type){case"Program":f(e.body);break;case"BlockStatement":c("{"),i++,Array.isArray(e.body)&&e.body.length>0&&(u(),f(e.body)),i--,u(),c("}");break;case"ExpressionStatement":p(e.expression),c(";");break;case"VariableDeclaration":if(c(e.kind||"var"),c(" "),e.declarations)for(let t=0;t<e.declarations.length;t++){t>0&&c(", ");const n=e.declarations[t];l(n.start),p(n.id),n.init&&(c(" = "),p(n.init))}c(";");break;case"FunctionDeclaration":case"FunctionExpression":e.async&&c("async "),c("function"),e.generator&&c("*"),e.id&&(c(" "),p(e.id)),c("("),m(e.params),c(") "),p(e.body);break;case"ArrowFunctionExpression":e.async&&c("async "),1===e.params?.length&&"Identifier"===e.params[0].type?p(e.params[0]):(c("("),m(e.params),c(")")),c(" => "),p(e.body);break;case"ReturnStatement":c("return"),e.argument&&(c(" "),p(e.argument)),c(";");break;case"IfStatement":c("if ("),p(e.test),c(") "),p(e.consequent),e.alternate&&(c(" else "),p(e.alternate));break;case"ForStatement":c("for ("),p(e.init),c(" "),p(e.test),c("; "),p(e.update),c(") "),p(e.body);break;case"WhileStatement":c("while ("),p(e.test),c(") "),p(e.body);break;case"DoWhileStatement":c("do "),p(e.body),c(" while ("),p(e.test),c(");");break;case"SwitchStatement":if(c("switch ("),p(e.discriminant),c(") {"),i++,e.cases)for(const t of e.cases)u(),p(t);i--,u(),c("}");break;case"SwitchCase":if(e.test?(c("case "),p(e.test),c(":")):c("default:"),i++,e.consequent&&Array.isArray(e.consequent))for(const t of e.consequent)u(),p(t);i--;break;case"TryStatement":c("try "),p(e.block),e.handler&&(c(" catch"),e.handler.param&&(c(" ("),p(e.handler.param),c(")")),c(" "),p(e.handler.body)),e.finalizer&&(c(" finally "),p(e.finalizer));break;case"ThrowStatement":c("throw "),p(e.argument),c(";");break;case"BreakStatement":c("break"),e.label&&(c(" "),p(e.label)),c(";");break;case"ContinueStatement":c("continue"),e.label&&(c(" "),p(e.label)),c(";");break;case"CallExpression":p(e.callee),c("("),d(e.arguments),c(")");break;case"NewExpression":c("new "),p(e.callee),c("("),d(e.arguments),c(")");break;case"MemberExpression":p(e.object),e.computed?(c("["),p(e.property),c("]")):(c("."),p(e.property));break;case"BinaryExpression":case"LogicalExpression":case"AssignmentExpression":p(e.left),c(` ${e.operator} `),p(e.right);break;case"UpdateExpression":e.prefix?(c(e.operator||""),p(e.argument)):(p(e.argument),c(e.operator||""));break;case"UnaryExpression":c(e.operator||""),e.operator&&e.operator.length>1&&c(" "),p(e.argument);break;case"ConditionalExpression":p(e.test),c(" ? "),p(e.consequent),c(" : "),p(e.alternate);break;case"ObjectExpression":if(e.properties&&0!==e.properties.length){c("{"),i++;for(let t=0;t<e.properties.length;t++)u(),p(e.properties[t]),t<e.properties.length-1&&c(",");i--,u(),c("}")}else c("{}");break;case"Property":e.method?(e.value?.async&&c("async "),e.value?.generator&&c("*"),p(e.key),c("("),m(e.value?.params),c(") "),p(e.value?.body)):e.shorthand?p(e.key):(e.computed?(c("["),p(e.key),c("]")):p(e.key),c(": "),p(e.value));break;case"ArrayExpression":if(c("["),e.elements)for(let t=0;t<e.elements.length;t++)t>0&&c(", "),e.elements[t]&&p(e.elements[t]);c("]");break;case"Identifier":c(e.name||"");break;case"Literal":c(e.raw||String(e.value));break;case"TemplateLiteral":if(c("`"),e.quasis&&e.expressions)for(let t=0;t<e.quasis.length;t++)c(e.quasis[t].value?.raw||""),t<e.expressions.length&&(c("${"),p(e.expressions[t]),c("}"));c("`");break;case"ThisExpression":c("this");break;case"SequenceExpression":if(e.expressions)for(let t=0;t<e.expressions.length;t++)t>0&&c(", "),p(e.expressions[t]);break;case"ClassDeclaration":case"ClassExpression":c("class"),e.id&&(c(" "),p(e.id)),e.superClass&&(c(" extends "),p(e.superClass)),c(" "),p(e.body);break;case"ClassBody":if(c("{"),i++,e.body&&Array.isArray(e.body))for(const t of e.body)u(),p(t);i--,u(),c("}");break;case"MethodDefinition":e.static&&c("static "),"get"===e.kind&&c("get "),"set"===e.kind&&c("set "),e.value?.async&&c("async "),e.value?.generator&&c("*"),e.computed?(c("["),p(e.key),c("]")):p(e.key),c("("),m(e.value?.params),c(") "),p(e.value?.body);break;case"ImportDeclaration":if(c("import "),e.specifiers&&e.specifiers.length>0){const t=e.specifiers.find(e=>"ImportDefaultSpecifier"===e.type),n=e.specifiers.find(e=>"ImportNamespaceSpecifier"===e.type),r=e.specifiers.filter(e=>"ImportSpecifier"===e.type);if(t&&(p(t.local),(n||r.length>0)&&c(", ")),n&&(c("* as "),p(n.local)),r.length>0){c("{");for(let e=0;e<r.length;e++){e>0&&c(", ");const t=r[e];p(t.imported),t.local?.name!==t.imported?.name&&(c(" as "),p(t.local))}c("}")}c(" from ")}p(e.source),c(";");break;case"ExportNamedDeclaration":if(c("export "),e.declaration)p(e.declaration);else if(e.specifiers&&e.specifiers.length>0){c("{");for(let t=0;t<e.specifiers.length;t++){t>0&&c(", ");const n=e.specifiers[t];p(n.local),n.exported?.name!==n.local?.name&&(c(" as "),p(n.exported))}c("}"),e.source&&(c(" from "),p(e.source)),c(";")}break;case"ExportDefaultDeclaration":c("export default "),p(e.declaration),"FunctionDeclaration"!==e.declaration?.type&&"ClassDeclaration"!==e.declaration?.type&&c(";");break;case"ExportAllDeclaration":c("export * from "),p(e.source),c(";");break;case"AwaitExpression":c("await "),p(e.argument);break;case"YieldExpression":c("yield"),e.delegate&&c("*"),e.argument&&(c(" "),p(e.argument));break;case"SpreadElement":case"RestElement":c("..."),p(e.argument);break;case"ForInStatement":c("for ("),p(e.left),c(" in "),p(e.right),c(") "),p(e.body);break;case"ForOfStatement":c("for "),e.await&&c("await "),c("("),p(e.left),c(" of "),p(e.right),c(") "),p(e.body);break;case"EmptyStatement":c(";");break;case"DebuggerStatement":c("debugger;");break;case"LabeledStatement":p(e.label),c(": "),p(e.body);break;case"WithStatement":c("with ("),p(e.object),c(") "),p(e.body);break;default:c(t.slice(e.start,e.end))}}function f(e){for(let t=0;t<e.length;t++)t>0&&u(),p(e[t])}function m(e){if(e)for(let t=0;t<e.length;t++)t>0&&c(", "),p(e[t])}function d(e){if(e)for(let t=0;t<e.length;t++)t>0&&c(", "),p(e[t])}return p(r),{formattedCode:a,mappings:n,success:!0}}export function mapOriginalToFormatted(e,t,n){if(0===e.length)return null;let r=0,a=e.length-1,o=null;for(;r<=a;){const s=Math.floor((r+a)/2),i=e[s],l=i.original.line,c=i.original.column;if(l===t&&c===n)return i.formatted;l<t||l===t&&c<n?(o=i,r=s+1):a=s-1}return o?o.formatted:e[0].formatted}export function mapFormattedToOriginal(e,t,n){if(0===e.length)return null;let r=0,a=e.length-1,o=null;for(;r<=a;){const s=Math.floor((r+a)/2),i=e[s],l=i.formatted.line,c=i.formatted.column;if(l===t&&c===n)return i.original;l<t||l===t&&c<n?(o=i,r=s+1):a=s-1}return o?o.original:e[0].original}export function extractContextCode(e,t){const{lineNumber:n,columnNumber:r,contextLines:a,formatMinified:o,maxLineLength:s=500}=t;if(0===a)return{lines:[],wasFormatted:!1,warnings:[]};if(!e||0===e.length)return{lines:[],wasFormatted:!1,warnings:["Script has no source content"]};const i=t.lineOffsets||buildLineOffsets(e),l=i.length,c=Math.max(0,n-1-a),u=Math.min(l-1,n-1+a),p=[];for(let t=c;t<=u;t++){const a=t+1,o=a===n,l=i[t],c=t+1<i.length?i[t+1]-1:e.length;let u=e.slice(l,c);if(u.length>s)if(o){const e=Math.floor(s/2),t=Math.max(0,r-e),n=Math.min(u.length,r+e);u=(t>0?"... ":"")+u.substring(t,n)+(n<u.length?" ...":"")}else u=u.substring(0,s)+"... [truncated]";p.push({displayLineNumber:a,originalLineNumber:a,content:u,isCurrentLine:o,annotations:[]})}return{lines:p,wasFormatted:!1,warnings:[]}}export function formatContextCodeOutput(e,t,n,r,a){if(0===e.lines.length)return e.warnings.length>0?`âš ï¸ ${e.warnings.join(", ")}`:"No context code available";const o=[],s=a?` (${a})`:"";o.push(`ðŸ“ Code Context${s}:`),r&&o.push(`   Script: ${r}`),o.push(`   Original position: line ${t}, column ${n}`);e.lines.some(e=>e.content.length>500)&&o.push("   â„¹ï¸ Code is from minified source");for(const t of e.warnings)o.push(`   âš ï¸ ${t}`);o.push(""),o.push("   "+"â”€".repeat(50));const i=Math.max(...e.lines.map(e=>e.displayLineNumber)),l=String(i).length;for(const t of e.lines){const e=t.isCurrentLine?">>>":"   ",n=String(t.displayLineNumber).padStart(l," "),r=`[L:${t.originalLineNumber},C:0]`;let a=`${e}${n}  â”‚ ${t.content}`;const s=Math.max(0,60-a.length);a+=" ".repeat(s)+r,t.isCurrentLine&&(a+=" â—„ current"),o.push(a)}o.push("   "+"â”€".repeat(50));const c=e.lines.find(e=>e.isCurrentLine);return c&&(o.push(""),o.push("   ðŸ’¡ Current position:"),o.push(`      â€¢ [L:${c.originalLineNumber},C:${n}]`)),o.join("\n")}export function generatePositionAnnotations(t,n,r){const a=[];let o;try{o=e.parse(t,{ecmaVersion:"latest",sourceType:"module",allowHashBang:!0,allowAwaitOutsideFunction:!0,allowImportExportEverywhere:!0,allowReserved:!0,locations:!0})}catch{return a}function s(e,o,s){const i=function(e){let n=1,r=-1;for(let a=0;a<e&&a<t.length;a++)"\n"===t[a]&&(n++,r=a);return{line:n,column:e-r-1}}(e.start);i.line>=n&&i.line<=r&&a.push({originalColumn:i.column,formattedColumn:i.column,type:o,name:s})}function i(e){if(e)switch(e.type){case"FunctionDeclaration":case"FunctionExpression":s(e,"function",e.id?.name||"<anonymous>"),l(e.body);break;case"ArrowFunctionExpression":s(e,"function","<arrow>"),l(e.body);break;case"CallExpression":"Identifier"===e.callee?.type&&e.callee.name?s(e,"call",e.callee.name):"MemberExpression"===e.callee?.type&&e.callee.property?.name&&s(e,"call",e.callee.property.name),i(e.callee);for(const t of e.arguments||[])i(t);break;case"VariableDeclaration":s(e,"statement");for(const t of e.declarations||[])t.init&&i(t.init);break;case"ReturnStatement":s(e,"statement"),i(e.argument);break;case"IfStatement":s(e,"statement"),i(e.test),i(e.consequent),i(e.alternate);break;case"ForStatement":case"WhileStatement":case"DoWhileStatement":s(e,"statement"),i(e.init),i(e.test),i(e.update),l(e.body);break;case"ExpressionStatement":i(e.expression);break;case"BlockStatement":case"Program":l(e.body);break;default:if(e.body&&l(e.body),e.expression&&i(e.expression),e.left&&i(e.left),e.right&&i(e.right),e.argument&&i(e.argument),e.consequent&&l(e.consequent),e.alternate&&i(e.alternate),e.object&&i(e.object),e.property&&i(e.property),e.elements)for(const t of e.elements)t&&i(t);if(e.properties)for(const t of e.properties)i(t)}}function l(e){if(e)if(Array.isArray(e))for(const t of e)i(t);else i(e)}return i(o),a}export function formatPositionAnnotation(e,t){return`[L:${e},C:${t}]`}export function buildLineOffsets(e){const t=[0];if(!e)return t;for(let n=0;n<e.length;n++)"\n"===e[n]&&t.push(n+1);return t}export function lineColumnToIndex(e,t,n,r){if(!e||t<1)return 0;if(r&&r.length>0){const a=t-1;if(a>=r.length)return e.length;const o=r[a]+n;return Math.min(o,e.length)}let a=1,o=0;for(let r=0;r<e.length;r++){if(a===t){const t=o+n;return Math.min(t,e.length)}"\n"===e[r]&&(a++,o=r+1)}if(a===t){const t=o+n;return Math.min(t,e.length)}return e.length}