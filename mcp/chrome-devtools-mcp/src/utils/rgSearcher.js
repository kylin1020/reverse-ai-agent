/**
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{spawn as t}from"child_process";import{ScriptCacheRegistry as r}from"./scriptCacheRegistry.js";import{getScriptCache as e,getScriptSource as n}from"./smartBreakpointUtils.js";export async function searchInScriptsWithRg(o,s,c=!1,i,a=!1){const u={pattern:s,isRegex:c,totalMatches:0,matches:[]},l=e(o);if(!l||0===l.size)return u;const m=r.getOrCreate(o),p=[],h=i?new RegExp(i):null;for(const[t,r]of l){const e=r.url;e&&(h&&!h.test(e)||p.push({scriptId:t,url:e}))}if(0===p.length)return u;const f=[],g=new Map;for(const{scriptId:t,url:r}of p){const e=await n(o,t);if(!e)continue;const s=await m.cacheScript(t,r,e);s&&(f.push(s),g.set(s,{scriptId:t,url:r}))}if(0===f.length)return u;const d=await async function(r,e,n,o){return new Promise(s=>{const c=["--json","--line-number","--column"];o||c.push("--ignore-case"),n||c.push("--fixed-strings"),c.push(e,r);const i=t("rg",c);let a="",u="";i.stdout.on("data",t=>{a+=t.toString()}),i.stderr.on("data",t=>{u+=t.toString()}),i.on("close",t=>{if(0!==t&&1!==t)return console.error(`ripgrep error (code ${t}): ${u}`),void s([]);const r=function(t){const r=[],e=t.split("\n").filter(t=>t.trim());for(const t of e)try{const e=JSON.parse(t);if("match"===e.type){const t=e.data,n=t.path?.text||"",o=t.line_number||1,s=t.lines?.text||"";if(t.submatches&&Array.isArray(t.submatches))for(const e of t.submatches)r.push({filePath:n,lineNumber:o,columnNumber:e.start||0,matchText:e.match?.text||"",lineContent:s.trimEnd()})}}catch{}return r}(a);s(r)}),i.on("error",t=>{console.error(`Failed to spawn ripgrep: ${t}`),s([])})})}(m.tempDir,s,c,a);for(const t of d){const r=g.get(t.filePath);if(!r)continue;const e=m.getScriptIdFromFile(t.filePath);e&&u.matches.push({scriptId:e,scriptUrl:r.url,lineNumber:t.lineNumber,columnNumber:t.columnNumber,matchText:t.matchText,context:t.lineContent})}return u.totalMatches=u.matches.length,u}