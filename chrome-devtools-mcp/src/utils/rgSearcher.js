/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{spawn as t}from"node:child_process";import{createInterface as e}from"node:readline";import{logger as r}from"../logger.js";import{ScriptCacheRegistry as n}from"./scriptCacheRegistry.js";import{getScriptCache as c,getScriptSource as o}from"./smartBreakpointUtils.js";export function extractContext(t,e,r){if(t.length<=200)return t;const n=Math.max(0,e-60),c=Math.min(t.length,e+r+60);return(n>0?"...":"")+t.slice(n,c)+(c<t.length?"...":"")}export async function searchInScriptsWithRg(i,a,s=!1,h,p=!1){if(!a)return{pattern:a,isRegex:s,totalMatches:0,matches:[]};if(s)try{new RegExp(a)}catch{return{pattern:a,isRegex:s,totalMatches:0,matches:[]}}try{const r=await async function(t){const e=n.getOrCreate(t);if(e.getCachedScriptCount()>0)return e.getCachedScriptCount();const r=c(t);let i=0;for(const[n,c]of r){if(!c.url)continue;const r=await o(t,n);r&&(await e.cacheScript(n,c.url,r)&&i++)}return i}(i);if(0===r)return{pattern:a,isRegex:s,totalMatches:0,matches:[]};const l=n.getOrCreate(i),u=await async function(){try{return(await import("@vscode/ripgrep")).rgPath}catch{return"rg"}}(),m=h?new RegExp(h):null,g=await async function(r,n,c,o,i){return new Promise((a,s)=>{const h=[],p=["--json","--column","--line-number","--no-heading"];o||p.push("--fixed-strings"),i||p.push("--ignore-case"),p.push("--",n,c);const l=t(r,p,{stdio:["ignore","pipe","pipe"]});e({input:l.stdout,crlfDelay:1/0}).on("line",t=>{try{const e=JSON.parse(t);if("match"===e.type){const t=e.data;for(const e of t.submatches)h.push({filePath:t.path.text,lineNumber:t.line_number,column:e.start,matchText:e.match.text,lineContent:t.lines.text.replace(/\n$/,"")})}}catch{}}),l.on("error",t=>{s(t)}),l.on("close",t=>{0===t||1===t?a(h):s(new Error(`ripgrep exited with code ${t}`))})})}(u,a,l.tempDir,s,p),f=[];for(const t of g){const e=l.getScriptIdFromFile(t.filePath);if(!e)continue;const r=l.getScriptUrl(e)||"";m&&!m.test(r)||f.push({scriptId:e,scriptUrl:r,lineNumber:t.lineNumber,columnNumber:t.column,matchText:t.matchText,context:extractContext(t.lineContent,t.column,t.matchText.length)})}return{pattern:a,isRegex:s,totalMatches:f.length,matches:f}}catch(t){return r(`[search] ripgrep search failed: ${t}`),{pattern:a,isRegex:s,totalMatches:0,matches:[]}}}