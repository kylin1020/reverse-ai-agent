/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{logger as a}from"../logger.js";import{getCdpSession as e}from"./cdp.js";import{getDebuggerState as t,initializeDebuggerForPage as s}from"./debuggerUtils.js";export async function smartNavigate(e,t,s,r){return new Promise(i=>{let n,o=!1;const g=()=>{if(!o){o=!0,n&&(clearTimeout(n),n=void 0);try{e.off("Debugger.paused",u),e.off("Page.loadEventFired",d)}catch(e){a("[smart-navigation] Error during cleanup:",e)}}},u=e=>{o||(g(),a("[smart-navigation] Debugger paused during navigation"),i({status:"paused",callFrames:e.callFrames}))},d=()=>{o||(g(),a("[smart-navigation] Page loaded successfully"),i({status:"loaded"}))};!(!1===s.debuggerEnabled||r&&r.userDisabled)&&e.on("Debugger.paused",u),e.on("Page.loadEventFired",d);const l=s.timeout??3e4;n=setTimeout(()=>{o||(g(),a("[smart-navigation] Navigation timeout"),i({status:"timeout",error:`Navigation timeout after ${l}ms`}))},l),t().catch(e=>{o||(g(),a("[smart-navigation] Navigation error:",e),i({status:"error",error:e.message||String(e)}))})})}export class SmartNavigator{page;session;constructor(a,e){this.page=a,this.session=e}async getSession(){return this.session||(this.session=await e(this.page)),this.session}async navigateToUrl(a,e){const r=await this.getSession(),i=t(this.page);!1===e?.debuggerEnabled||i.userDisabled||await s(this.page);const n=await smartNavigate(r,async()=>{await r.send("Page.navigate",{url:a})},e??{},i);return"loaded"===n.status&&(n.url=this.page.url()),"paused"===n.status&&n.callFrames&&(i.isPaused=!0,i.pausedCallFrames=n.callFrames),n}async navigateBack(a){const e=await this.getSession(),r=t(this.page);!1===a?.debuggerEnabled||r.userDisabled||await s(this.page);const i=await e.send("Page.getNavigationHistory");if(i.currentIndex<=0)return{status:"error",error:"Cannot navigate back: already at the beginning of history"};const n=i.entries[i.currentIndex-1],o=await smartNavigate(e,async()=>{await e.send("Page.navigateToHistoryEntry",{entryId:n.id})},a??{},r);return"loaded"===o.status&&(o.url=this.page.url()),"paused"===o.status&&o.callFrames&&(r.isPaused=!0,r.pausedCallFrames=o.callFrames),o}async navigateForward(a){const e=await this.getSession(),r=t(this.page);!1===a?.debuggerEnabled||r.userDisabled||await s(this.page);const i=await e.send("Page.getNavigationHistory");if(i.currentIndex>=i.entries.length-1)return{status:"error",error:"Cannot navigate forward: already at the end of history"};const n=i.entries[i.currentIndex+1],o=await smartNavigate(e,async()=>{await e.send("Page.navigateToHistoryEntry",{entryId:n.id})},a??{},r);return"loaded"===o.status&&(o.url=this.page.url()),"paused"===o.status&&o.callFrames&&(r.isPaused=!0,r.pausedCallFrames=o.callFrames),o}async reload(a){const e=await this.getSession(),r=t(this.page);!1===a?.debuggerEnabled||r.userDisabled||await s(this.page);const i=await smartNavigate(e,async()=>{await e.send("Page.reload",{ignoreCache:a?.ignoreCache??!1})},a??{},r);return"loaded"===i.status&&(i.url=this.page.url()),"paused"===i.status&&i.callFrames&&(r.isPaused=!0,r.pausedCallFrames=i.callFrames),i}}