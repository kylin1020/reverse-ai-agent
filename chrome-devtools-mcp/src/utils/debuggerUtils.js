/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{logger as e}from"../logger.js";import{getCdpSession as t}from"./cdp.js";import{cacheScript as r,clearScriptCache as a}from"./smartBreakpointUtils.js";import{clearParseResultCache as n}from"../tools/analysis.js";import{ScriptCacheRegistry as i}from"./scriptCacheRegistry.js";const o=new WeakMap;export function getDebuggerState(e){let t=o.get(e);return t||(t={enabled:!1,breakpoints:new Map,isPaused:!1},o.set(e,t)),t}const s=new WeakSet;export async function restoreBreakpointsAfterNavigation(t,r){const a=getDebuggerState(t);try{await r.send("Debugger.enable")}catch{}let n=!1;try{await r.send("Debugger.setSkipAllPauses",{skip:!0}),n=!0,e("[debugger] Temporarily skipping all pauses during breakpoint restoration")}catch{}for(const[t,n]of a.breakpoints)try{const a={lineNumber:n.resolvedLineNumber-1,urlRegex:n.urlPattern,columnNumber:n.resolvedColumnNumber};n.condition&&(a.condition=n.condition);const i=await r.send("Debugger.setBreakpointByUrl",a);n.breakpointId=i.breakpointId,e(`[debugger] Restored breakpoint "${t}" after navigation`)}catch(r){e(`[debugger] Failed to restore breakpoint "${t}": ${r}`)}if(n)try{await r.send("Debugger.setSkipAllPauses",{skip:!1}),e("[debugger] Pausing re-enabled after breakpoint restoration")}catch{}}export async function initializeDebuggerForPage(o){const c=await t(o),g=getDebuggerState(o);if(g.enabled||(await c.send("Debugger.enable"),g.enabled=!0,c.on("Debugger.scriptParsed",async t=>{const a=t.scriptId,n=t.url||"";if(r(c,{scriptId:a,url:n,startLine:t.startLine,startColumn:t.startColumn,endLine:t.endLine,endColumn:t.endColumn}),n)try{const e=(await c.send("Debugger.getScriptSource",{scriptId:a})).scriptSource;if(e){const t=i.getOrCreate(c);await t.cacheScript(a,n,e)}}catch(t){e(`[debugger] Failed to cache script source for ${a}: ${t}`)}e(`[debugger] Script parsed: ${n||a}`)}),c.on("Debugger.paused",t=>{g.isPaused=!0,g.pausedCallFrames=t.callFrames?.map(e=>({callFrameId:e.callFrameId,functionName:e.functionName||"(anonymous)",location:{scriptId:e.location.scriptId,lineNumber:e.location.lineNumber,columnNumber:e.location.columnNumber},url:e.url||"",scopeChain:e.scopeChain?.map(e=>({type:e.type,object:{type:e.object?.type,objectId:e.object?.objectId},name:e.name}))||[]})),e("[debugger] Execution paused at breakpoint")}),c.on("Debugger.resumed",()=>{g.isPaused=!1,g.pausedCallFrames=void 0,e("[debugger] Execution resumed")})),!s.has(o)){let t;s.add(o);try{const e=await c.send("Page.getFrameTree");t=e.frameTree?.frame?.id}catch{}c.on("Page.frameStartedLoading",async r=>{let i=!t||r.frameId===t;if(!i)try{const e=await c.send("Page.getFrameTree"),a=e.frameTree?.frame?.id;r.frameId===a&&(i=!0,t=a)}catch{i=!0}if(i){a(c),n(c),e("[debugger] Script cache and parse result cache cleared on navigation"),e("[debugger] Main frame started loading, initializing debugger/breakpoints...");try{await restoreBreakpointsAfterNavigation(o,c)}catch(t){e(`[debugger] Error restoring breakpoints: ${t}`)}try{const e=await c.send("Page.getFrameTree");t=e.frameTree?.frame?.id}catch{}}});try{await c.send("Page.enable")}catch{}}return c}