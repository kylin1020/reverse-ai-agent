/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{logger as e}from"../logger.js";import{getCdpSession as t}from"./cdp.js";import{cacheScript as a,clearScriptCache as r}from"./smartBreakpointUtils.js";import{clearParseResultCache as n}from"../tools/analysis.js";import{ScriptCacheRegistry as i}from"./scriptCacheRegistry.js";const o=new WeakMap;export function getDebuggerState(e){let t=o.get(e);return t||(t={enabled:!1,breakpoints:new Map,isPaused:!1},o.set(e,t)),t}const c=new WeakSet;export async function restoreBreakpointsAfterNavigation(t,a){const r=getDebuggerState(t);try{await a.send("Emulation.setScriptExecutionDisabled",{value:!0}),e("[debugger] Script execution disabled temporarily")}catch{}try{await a.send("Debugger.enable")}catch{}for(const[t,n]of r.breakpoints)try{const r={lineNumber:n.resolvedLineNumber-1,urlRegex:n.urlPattern,columnNumber:n.resolvedColumnNumber};n.condition&&(r.condition=n.condition);const i=await a.send("Debugger.setBreakpointByUrl",r);n.breakpointId=i.breakpointId,e(`[debugger] Restored breakpoint "${t}" after navigation`)}catch(a){e(`[debugger] Failed to restore breakpoint "${t}": ${a}`)}try{await a.send("Emulation.setScriptExecutionDisabled",{value:!1}),e("[debugger] Script execution re-enabled")}catch{}}export async function initializeDebuggerForPage(o){const s=await t(o),d=getDebuggerState(o);if(d.enabled||(await s.send("Debugger.enable"),d.enabled=!0,s.on("Debugger.scriptParsed",async t=>{const r=t.scriptId,n=t.url||"";if(a(s,{scriptId:r,url:n,startLine:t.startLine,startColumn:t.startColumn,endLine:t.endLine,endColumn:t.endColumn}),n)try{const e=(await s.send("Debugger.getScriptSource",{scriptId:r})).scriptSource;if(e){const t=i.getOrCreate(s);await t.cacheScript(r,n,e)}}catch(t){e(`[debugger] Failed to cache script source for ${r}: ${t}`)}e(`[debugger] Script parsed: ${n||r}`)}),s.on("Debugger.paused",t=>{d.isPaused=!0,d.pausedCallFrames=t.callFrames?.map(e=>({callFrameId:e.callFrameId,functionName:e.functionName||"(anonymous)",location:{scriptId:e.location.scriptId,lineNumber:e.location.lineNumber,columnNumber:e.location.columnNumber},url:e.url||"",scopeChain:e.scopeChain?.map(e=>({type:e.type,object:{type:e.object?.type,objectId:e.object?.objectId},name:e.name}))||[]})),e("[debugger] Execution paused at breakpoint")}),s.on("Debugger.resumed",()=>{d.isPaused=!1,d.pausedCallFrames=void 0,e("[debugger] Execution resumed")})),!c.has(o)){let t;c.add(o);try{const e=await s.send("Page.getFrameTree");t=e.frameTree?.frame?.id}catch{}s.on("Page.frameStartedLoading",async a=>{let i=!t||a.frameId===t;if(!i)try{const e=await s.send("Page.getFrameTree"),r=e.frameTree?.frame?.id;a.frameId===r&&(i=!0,t=r)}catch{i=!0}if(i){r(s),n(s),e("[debugger] Script cache and parse result cache cleared on navigation"),e("[debugger] Main frame started loading, initializing debugger/breakpoints...");try{await restoreBreakpointsAfterNavigation(o,s)}catch(t){e(`[debugger] Error restoring breakpoints: ${t}`)}try{const e=await s.send("Page.getFrameTree");t=e.frameTree?.frame?.id}catch{}}});try{await s.send("Page.enable")}catch{}}return s}