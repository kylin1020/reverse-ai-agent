/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{mkdir as t,rm as r,writeFile as i}from"node:fs/promises";import{tmpdir as e}from"node:os";import{join as s}from"node:path";import{logger as c}from"../logger.js";export class ScriptCacheManager{tempDir;scriptIdToFile=new Map;fileToScriptId=new Map;scriptIdToUrl=new Map;dirCreated=!1;constructor(){const t=Date.now(),r=Math.random().toString(36).slice(2);this.tempDir=s(e(),`mcp-scripts-${t}-${r}`)}async ensureTempDir(){this.dirCreated||(await t(this.tempDir,{recursive:!0}),this.dirCreated=!0)}async cacheScript(t,r,e){if(r)try{await this.ensureTempDir();const c=`script_${t}.js`,a=s(this.tempDir,c);return await i(a,e,"utf-8"),this.scriptIdToFile.set(t,a),this.fileToScriptId.set(a,t),this.scriptIdToUrl.set(t,r),a}catch(r){return void c(`[ScriptCacheManager] Failed to cache script ${t}: ${r}`)}}getScriptIdFromFile(t){return this.fileToScriptId.get(t)}getFileFromScriptId(t){return this.scriptIdToFile.get(t)}getScriptUrl(t){return this.scriptIdToUrl.get(t)}getAllCachedScripts(){const t=new Map;for(const[r,i]of this.scriptIdToFile){const e=this.scriptIdToUrl.get(r)||"";t.set(r,{filePath:i,url:e})}return t}async cleanup(){if(this.dirCreated)try{await r(this.tempDir,{recursive:!0,force:!0})}catch(t){c(`[ScriptCacheManager] Failed to cleanup temp directory: ${t}`)}this.scriptIdToFile.clear(),this.fileToScriptId.clear(),this.scriptIdToUrl.clear(),this.dirCreated=!1}isDirCreated(){return this.dirCreated}getCachedScriptCount(){return this.scriptIdToFile.size}}