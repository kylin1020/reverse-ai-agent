/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import*as e from"node:fs/promises";import*as t from"node:path";import{zod as n}from"../third_party/index.js";import{getCdpSession as r}from"../utils/cdp.js";import{getConfig as i}from"../utils/config.js";import{getScriptCache as a}from"../utils/smartBreakpointUtils.js";import{ToolCategory as s}from"./categories.js";import{defineTool as o}from"./ToolDefinition.js";function c(e){const t=i().maxBodySize;return e.length>t?e.substring(0,t)+"\n... <truncated>":e}async function u(e,t){const{type:n,subtype:r,objectId:i,value:s,description:o,unserializableValue:c,preview:u}=t;if("undefined"===n)return{value:"undefined"};if("null"===r)return{value:"null"};if(c)return{value:c};if("boolean"===n||"number"===n||"bigint"===n)return{value:String(s)};if("string"===n)return{value:JSON.stringify(s)};if("symbol"===n)return{value:o||"Symbol()"};if("function"===n&&i){const t=await async function(e,t){try{const n=await e.send("Runtime.getProperties",{objectId:t,ownProperties:!1}),r=n.internalProperties?.find(e=>"[[FunctionLocation]]"===e.name);if(r?.value?.value){const{scriptId:t,lineNumber:n,columnNumber:i}=r.value.value,s=a(e).get(t);return`${s?.url||`VM${t}`}:${n+1}:${i+1}`}}catch{}return}(e,i);return{value:o||"[Function]",location:t}}if("node"===r&&i){const t=await async function(e,t){try{return(await e.send("Runtime.callFunctionOn",{objectId:t,functionDeclaration:"function() {\n        const el = this;\n        if (el.nodeType === 1) {\n          let s = '<' + el.tagName.toLowerCase();\n          if (el.id) s += ' id=\"' + el.id + '\"';\n          if (el.className) s += ' class=\"' + el.className + '\"';\n          s += '>';\n          return s;\n        }\n        return el.nodeName;\n      }",returnByValue:!0})).result.value}catch{return}}(e,i);return{value:t||o||"[Node]"}}if("array"===r&&i){return{value:await l(e,i)||o||"[]"}}if("regexp"===r||"date"===r||"map"===r||"set"===r||"error"===r)return{value:o||`[${r}]`};if("promise"===r&&u)return{value:o||"Promise"};if("object"===n&&i){return{value:await l(e,i)||o||"[Object]"}}return{value:o||`[${n}]`}}async function l(e,t){try{return(await e.send("Runtime.callFunctionOn",{objectId:t,functionDeclaration:"function() {\n        try {\n          return JSON.stringify(this, null, 2);\n        } catch {\n          return null;\n        }\n      }",returnByValue:!0})).result.value??void 0}catch{return}}export const saveScriptSource=o({name:"save_script_source",description:"Save a script source to a local file. Use VM<id> pattern to match by scriptId, otherwise matches by URL substring.",annotations:{category:s.DEBUGGING,readOnlyHint:!1},schema:{pattern:n.string().describe('Pattern to match script. If starts with "VM" (e.g., "VM123"), matches by scriptId. Otherwise matches by URL substring. Saves the first match.'),filePath:n.string().describe("Path to save the script file.")},handler:async(n,i,s)=>{const{pattern:o,filePath:c}=n.params,u=s.getSelectedPage(),l=await r(u);try{let n,r;const s=o.match(/^VM(\d+)$/i);if(s)n=s[1];else{const e=a(l);for(const[t,i]of e.entries())if(i.url&&i.url.includes(o)){n=t,r=i.url;break}}if(!n)return void i.appendResponseLine(`Error: No script found matching pattern "${o}".`);const u=(await l.send("Debugger.getScriptSource",{scriptId:n})).scriptSource;if(!u)return void i.appendResponseLine(`Error: Script ${n} has no source available.`);const p=t.resolve(c);await e.mkdir(t.dirname(p),{recursive:!0}),await e.writeFile(p,u,"utf-8"),i.appendResponseLine(`Saved script to ${p}`),r&&i.appendResponseLine(`Matched URL: ${r}`),i.appendResponseLine(`ScriptId: ${n}, Size: ${u.length} bytes`)}catch(e){i.appendResponseLine(`Error: ${e instanceof Error?e.message:String(e)}`)}}});export const evaluateScript=o({name:"evaluate_script",description:"Evaluate JavaScript code inside the currently selected page, similar to DevTools Console.\nSupports any valid JavaScript: expressions, statements, async/await, etc.\nReturns the result value or error message.",annotations:{category:s.DEBUGGING,readOnlyHint:!1},schema:{script:n.string().describe("JavaScript code to execute in the page context (like DevTools Console).\nExamples:\n- `document.title`\n- `document.querySelectorAll('a').length`\n- `await fetch('/api').then(r => r.json())`\n- `const x = 1; const y = 2; x + y`")},handler:async(e,t,n)=>{const i=n.getSelectedPage(),a=e.params.script,s=await r(i);await n.waitForEventsAfterAction(async()=>{const e=await s.send("Runtime.evaluate",{expression:a,awaitPromise:!0,returnByValue:!1,generatePreview:!0,userGesture:!0,replMode:!0});if(e.exceptionDetails){const n=function(e){if(e.exception?.description)return e.exception.description;if(e.text){const t=void 0!==e.lineNumber?` at line ${e.lineNumber+1}:${(e.columnNumber??0)+1}`:"";return`${e.text}${t}`}return"Unknown error"}(e.exceptionDetails);return void t.appendResponseLine("‚ùå Error: "+c(n))}const n=await u(s,e.result);t.appendResponseLine(c(n.value)),n.location&&t.appendResponseLine(`üìç ${n.location}`)})}});