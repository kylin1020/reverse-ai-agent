/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{zod as e}from"../third_party/index.js";import{getConfig as t}from"../utils/config.js";import{ToolCategory as n}from"./categories.js";import{defineTool as a}from"./ToolDefinition.js";export const evaluateScript=a({name:"evaluate_script",description:"Evaluate a JavaScript function inside the currently selected page. Returns JSON-serializable response.",annotations:{category:n.DEBUGGING,readOnlyHint:!1},schema:{function:e.string().describe("A JavaScript function declaration to be executed in the currently selected page."),args:e.array(e.object({uid:e.string().describe("The uid of an element on the page from the page content snapshot")})).optional().describe("An optional list of arguments to pass to the function.")},handler:async(e,n,a)=>{const i=[];try{const o=new Set;for(const t of e.params.args??[]){const e=await a.getElementByUid(t.uid);o.add(e.frame),i.push(e)}let s;if(o.size>1)throw new Error("Elements from different frames can't be evaluated together.");s=[...o.values()][0]??a.getSelectedPage();const r=await s.evaluateHandle(`(${e.params.function})`);i.unshift(r),await a.waitForEventsAfterAction(async()=>{const e=await s.evaluate(async(e,...t)=>JSON.stringify(await e(...t)),...i);n.appendResponseLine("Script ran on page and returned:"),n.appendResponseLine("```json"),n.appendResponseLine(function(e){const n=t().maxBodySize;return e.length>n?e.substring(0,n)+"\n... <truncated>":e}(e)),n.appendResponseLine("```")})}finally{Promise.allSettled(i.map(e=>e.dispose()))}}});