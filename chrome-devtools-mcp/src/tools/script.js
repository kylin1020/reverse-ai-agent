/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{zod as e}from"../third_party/index.js";import{getConfig as t}from"../utils/config.js";import{ToolCategory as n}from"./categories.js";import{defineTool as a}from"./ToolDefinition.js";export const evaluateScript=a({name:"evaluate_script",description:"Evaluate a JavaScript function inside the currently selected page. Returns the response as JSON\nso returned values have to JSON-serializable.",annotations:{category:n.DEBUGGING,readOnlyHint:!1},schema:{function:e.string().describe('A JavaScript function declaration to be executed by the tool in the currently selected page.\nExample without arguments: `() => {\n  return document.title\n}` or `async () => {\n  return await fetch("example.com")\n}`.\nExample with arguments: `(el) => {\n  return el.innerText;\n}`\n'),args:e.array(e.object({uid:e.string().describe("The uid of an element on the page from the page content snapshot")})).optional().describe("An optional list of arguments to pass to the function.")},handler:async(e,n,a)=>{const r=[];try{const o=new Set;for(const t of e.params.args??[]){const e=await a.getElementByUid(t.uid);o.add(e.frame),r.push(e)}let i;if(o.size>1)throw new Error("Elements from different frames can't be evaluated together.");i=[...o.values()][0]??a.getSelectedPage();const s=await i.evaluateHandle(`(${e.params.function})`);r.unshift(s),await a.waitForEventsAfterAction(async()=>{const e=await i.evaluate(async(e,...t)=>JSON.stringify(await e(...t)),...r);n.appendResponseLine("Script ran on page and returned:"),n.appendResponseLine("```json"),n.appendResponseLine(function(e){const n=t().maxBodySize;return e.length>n?e.substring(0,n)+"\n... <truncated>":e}(e)),n.appendResponseLine("```")})}finally{Promise.allSettled(r.map(e=>e.dispose()))}}});