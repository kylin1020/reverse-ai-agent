/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{zod as e}from"../third_party/index.js";import{getCdpSession as n}from"../utils/cdp.js";import{paginate as t}from"../utils/pagination.js";import{analyzeFunction as s,buildCallGraph as o}from"../utils/callGraphAnalyzer.js";import{ToolCategory as a}from"./categories.js";import{parseScript as i}from"../utils/scriptParser.js";import{searchInScriptsWithRg as r}from"../utils/scriptSearcher.js";import{getAllScriptsWithSource as p,getScriptCache as c}from"../utils/smartBreakpointUtils.js";import{defineTool as l}from"./ToolDefinition.js";const d=new WeakMap,u=new WeakMap;function f(e){let n=d.get(e);return n||(n=new Map,d.set(e,n)),n}function m(e,n,t,s){const o=f(e),a=o.get(n);if(a)return a;const r=i(n,t,s);return o.set(n,r),u.delete(e),r}export function clearParseResultCache(e){f(e).clear(),u.delete(e)}function h(e,n="",t=!0){const s=Object.entries(e);if(0===s.length)return"";let o="";return s.forEach(([e,a],i)=>{const r=i===s.length-1,p=t?"    ":"â”‚   ";o+=`${n}${t?"â””â”€â”€ ":"â”œâ”€â”€ "}${e}\n`,"Leaf"!==a&&Object.keys(a).length>0&&(o+=h(a,n+p,r))}),o}export const analyzeCallGraph=l({name:"analyze_call_graph",description:"Analyze the call graph for a specific JavaScript function to understand its callers and callees.",annotations:{category:a.DEBUGGING,readOnlyHint:!0},schema:{functionName:e.string().describe("The name of the function to analyze."),upstreamDepth:e.number().int().min(0).max(10).optional().default(3).describe("Maximum depth for upstream trace (callers). Default: 3, Max: 10."),downstreamDepth:e.number().int().min(0).max(10).optional().default(3).describe("Maximum depth for downstream trace (callees). Default: 3, Max: 10."),urlPattern:e.string().optional().describe("Optional regex pattern to filter scripts by URL.")},handler:async(e,t,a)=>{const{functionName:i,upstreamDepth:r,downstreamDepth:c,urlPattern:l}=e.params,d=a.getSelectedPage(),u=await n(d);t.appendResponseLine(`Analyzing call graph for function: ${i}`),t.appendResponseLine("");const f=await p(u,l);if(0===f.size)return t.appendResponseLine("âŒ No scripts found."),l&&t.appendResponseLine(`   URL pattern: ${l}`),t.appendResponseLine(""),t.appendResponseLine("ðŸ’¡ Suggestions:"),t.appendResponseLine("   â€¢ Ensure the page has loaded JavaScript files"),void t.appendResponseLine("   â€¢ Check that the URL pattern is correct");t.appendResponseLine(`ðŸ“œ Parsed ${f.size} script(s)`);const g=[];let R=0,L=0,x=0;for(const[e,{url:n,source:t}]of f){const s=m(u,e,n,t);g.push(s),R+=s.functions.length,L+=s.calls.length,x+=s.errors.length}t.appendResponseLine(`ðŸ“Š Found ${R} functions, ${L} call relationships`),x>0&&t.appendResponseLine(`âš ï¸ ${x} parse error(s) encountered`),t.appendResponseLine("");const $=o(g),b=s($,i,r,c);if(!b.found){if(t.appendResponseLine(`âŒ Function "${i}" not found in any script.`),t.appendResponseLine(""),b.similarFunctions&&b.similarFunctions.length>0){t.appendResponseLine("ðŸ’¡ Similar functions found:");for(const e of b.similarFunctions){const n=$.functions.get(e);n?t.appendResponseLine(`   â€¢ ${e} (${n.scriptUrl}:${n.lineNumber})`):t.appendResponseLine(`   â€¢ ${e}`)}}return}if(b.functionInfo){const e=b.functionInfo;t.appendResponseLine(`âœ… Function found: ${e.name}`),t.appendResponseLine(`   Location: ${e.scriptUrl}:${e.lineNumber}:${e.columnNumber}`),t.appendResponseLine(`   Type: ${e.type}`),t.appendResponseLine(`   Parameters: ${e.params.length>0?e.params.join(", "):"(none)"}`)}t.appendResponseLine("");const y=Object.keys(b.upstream);t.appendResponseLine(`ðŸ“¥ Upstream (who calls ${i}): ${y.length} direct caller(s)`),y.length>0?t.appendResponseLine(h(b.upstream)):t.appendResponseLine("   (no callers found)"),t.appendResponseLine("");const z=Object.keys(b.downstream);t.appendResponseLine(`ðŸ“¤ Downstream (what ${i} calls): ${z.length} direct callee(s)`),z.length>0?t.appendResponseLine(h(b.downstream)):t.appendResponseLine("   (no callees found)")}});export const searchScriptContent=l({name:"search_script_content",description:"Search for code snippets or patterns across all loaded JavaScript files using plain text or regex.",annotations:{category:a.DEBUGGING,readOnlyHint:!0},schema:{pattern:e.string().describe("The search pattern (string or regex)."),isRegex:e.boolean().optional().default(!1).describe("Whether to treat the pattern as a regular expression. Default: false."),urlPattern:e.string().optional().describe("Optional regex pattern to filter scripts by URL."),contextLength:e.number().int().min(100).max(2e3).optional().default(300).describe("Maximum characters of context to display around matches. Default: 300, Range: 100-2000."),pageSize:e.number().int().positive().optional().default(3).describe("Maximum number of matches to return per page. Default: 3."),pageIdx:e.number().int().min(0).optional().describe("Page number to return (0-based)."),maxTotalChars:e.number().int().positive().optional().default(400).describe("Maximum total characters in the response to prevent context overflow. Default: 400.")},handler:async(e,s,o)=>{const{pattern:a,isRegex:i,urlPattern:p,contextLength:l,pageSize:d,pageIdx:u,maxTotalChars:f}=e.params,m=o.getSelectedPage(),h=await n(m);if(!a)return void s.appendResponseLine("âŒ Search pattern is required.");if(i)try{new RegExp(a)}catch(e){return s.appendResponseLine(`âŒ Invalid regular expression: ${a}`),void s.appendResponseLine(`   Error: ${e instanceof Error?e.message:String(e)}`)}const R=c(h),L=p?new RegExp(p):null;let x=0;for(const[,e]of R)!e.url||L&&!L.test(e.url)||x++;if(0===x)return s.appendResponseLine("âŒ No scripts found."),void(p&&s.appendResponseLine(`   URL pattern: ${p}`));const $=await r(h,a,i,p);if(0===$.totalMatches)return s.appendResponseLine(`ðŸ” No matches found for: ${a}`),void(i&&s.appendResponseLine("   (searched as regex)"));const b=t($.matches,{pageSize:d,pageIdx:u});let y=0;const z=[],w=e=>{const n=e.length+1;return!(y+n>(f??4e4))&&(z.push(e),y+=n,!0)};if(!w(`ðŸ” Search results for: ${a}`))return void s.appendResponseLine("âš ï¸ Response too large, cannot display results.");if(i&&!w("   (regex search)"))return s.appendResponseLine(z.join("\n")),void s.appendResponseLine("âš ï¸ Response truncated due to size limit.");if(!w(`ðŸ“Š Total matches: ${$.totalMatches}`))return s.appendResponseLine(z.join("\n")),void s.appendResponseLine("âš ï¸ Response truncated due to size limit.");if(b.totalPages>1){if(!w(`ðŸ“„ Showing ${b.startIndex+1}-${b.endIndex} (Page ${b.currentPage+1} of ${b.totalPages})`))return s.appendResponseLine(z.join("\n")),void s.appendResponseLine("âš ï¸ Response truncated due to size limit.");if(b.hasNextPage&&!w(`   Next page: pageIdx=${b.currentPage+1}`))return s.appendResponseLine(z.join("\n")),void s.appendResponseLine("âš ï¸ Response truncated due to size limit.")}if(!w(""))return s.appendResponseLine(z.join("\n")),void s.appendResponseLine("âš ï¸ Response truncated due to size limit.");let S=0;for(const e of b.items){const n=[];n.push(`ðŸ“ ${e.scriptUrl}:${e.lineNumber}:${e.columnNumber}`),n.push(`   Match: "${e.matchText}"`);const t=g(e,l??300);n.push(`   Context: ${t}`),n.push("");const s=n.join("\n");if(y+s.length>(f??4e4))break;for(const e of n)if(!w(e))break;S++}s.appendResponseLine(z.join("\n")),S<b.items.length&&(s.appendResponseLine(`âš ï¸ Response truncated: Displayed ${S} of ${b.items.length} matches due to size limit (${f} chars).`),s.appendResponseLine("ðŸ’¡ Try: reduce contextLength, use pagination (pageIdx), or increase maxTotalChars."))}});function g(e,n=300){const t=n;let s;if(e.context.length>t){const n=e.columnNumber,o=n+e.matchText.length,a=Math.floor((t-e.matchText.length)/2);let i=Math.max(0,n-a),r=Math.min(e.context.length,o+a);0===i?r=Math.min(e.context.length,t):r===e.context.length&&(i=Math.max(0,e.context.length-t));const p=i>0?"...":"",c=r<e.context.length?"...":"";s=p+e.context.substring(i,r)+c}else s=e.context;return s.replace(e.matchText,`ã€${e.matchText}ã€‘`).trim()}function R(e,n){const t=e.toLowerCase(),s=n.toLowerCase();if(t===s)return 1;if(s.includes(t))return.8;if(t.includes(s))return.7;const o=new Set(t),a=new Set(s);let i=0;for(const e of o)a.has(e)&&i++;return i/Math.max(o.size,a.size)}export const searchFunctions=l({name:"search_functions",description:"Search for function definitions by name across all loaded JavaScript files. Supports exact, pattern, and fuzzy matching.",annotations:{category:a.DEBUGGING,readOnlyHint:!0},schema:{namePattern:e.string().describe("The function name or pattern to search for."),urlPattern:e.string().optional().describe("Optional regex pattern to filter scripts by URL."),fuzzy:e.boolean().optional().default(!0).describe("Whether to use fuzzy matching for similar names. Default: true."),showCode:e.boolean().optional().default(!1).describe("Whether to display the formatted function body code. Default: false."),maxCodeLines:e.number().int().positive().optional().default(20).describe("Maximum lines of code to display per function. Default: 20."),contextLength:e.number().int().min(100).max(2e3).optional().default(800).describe("Maximum characters of context to display when showCode=true. Default: 800, Range: 100-2000."),pageSize:e.number().int().positive().optional().describe("Maximum number of functions to return per page."),pageIdx:e.number().int().min(0).optional().describe("Page number to return (0-based).")},handler:async(e,s,o)=>{const{namePattern:a,urlPattern:i,fuzzy:r,showCode:c,maxCodeLines:l,contextLength:d,pageSize:h,pageIdx:g}=e.params,L=o.getSelectedPage(),x=await n(L);if(!a)return void s.appendResponseLine("âŒ Function name pattern is required.");const $=await p(x,i);if(0===$.size)return s.appendResponseLine("âŒ No scripts found."),void(i&&s.appendResponseLine(`   URL pattern: ${i}`));for(const[e,{url:n,source:t}]of $)m(x,e,n,t);const b=function(e,n){const t=new Set(n.keys()),s=f(e),o=u.get(e);if(o&&t.size===s.size)return o;const a=[];for(const e of t){const n=s.get(e);n&&a.push(...n.functions)}if(t.size===s.size&&o){const n=[];for(const e of s.values())n.push(...e.functions);return u.set(e,n),n}return a}(x,$);if(0===b.length)return void s.appendResponseLine("âŒ No functions found in loaded scripts.");let y=[],z=!1,w=null;try{/[.*+?^${}()|[\]\\]/.test(a)&&(w=new RegExp(a,"i"),z=!0)}catch{}if(z&&w)y=b.filter(e=>w.test(e.name));else{const e=a.toLowerCase();if(y=b.filter(n=>n.name.toLowerCase()===e),0===y.length&&r){y=b.map(e=>({func:e,score:R(a,e.name)})).filter(e=>e.score>=.3).sort((e,n)=>n.score-e.score).map(e=>e.func)}}if(0===y.length){s.appendResponseLine(`ðŸ” No functions found matching: ${a}`),r&&s.appendResponseLine("   (fuzzy search enabled)");const e=b.slice(0,5);if(e.length>0){s.appendResponseLine(""),s.appendResponseLine("ðŸ’¡ Sample functions in loaded scripts:");for(const n of e)s.appendResponseLine(`   â€¢ ${n.name} (${n.type})`)}return}const S=t(y,{pageSize:h,pageIdx:g});s.appendResponseLine(`ðŸ” Functions matching: ${a}`),z?s.appendResponseLine("   (regex pattern)"):r&&y.length>0&&s.appendResponseLine("   (fuzzy matching)"),s.appendResponseLine(`ðŸ“Š Total matches: ${y.length}`),S.totalPages>1&&(s.appendResponseLine(`ðŸ“„ Showing ${S.startIndex+1}-${S.endIndex} (Page ${S.currentPage+1} of ${S.totalPages})`),S.hasNextPage&&s.appendResponseLine(`   Next page: pageIdx=${S.currentPage+1}`)),s.appendResponseLine("");for(const e of S.items){if(s.appendResponseLine(`ðŸ“ ${e.name}`),s.appendResponseLine(`   Location: ${e.scriptUrl}:${e.lineNumber}:${e.columnNumber}`),s.appendResponseLine(`   Type: ${e.type}`),s.appendResponseLine(`   Parameters: ${e.params.length>0?e.params.join(", "):"(none)"}`),c){const n=$.get(e.scriptId);if(n?.source){const t=d??800,o=n.source.split("\n"),a=e.lineNumber-1,i=Math.min(a+(l??20),o.length),r=o.slice(a,i),p=o.length-a;s.appendResponseLine("   Code:"),s.appendResponseLine("   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");for(let e=0;e<r.length;e++){const n=String(a+e+1).padStart(4," ");let o=r[e];o.length>t&&(o=o.substring(0,t)+"..."),s.appendResponseLine(`   ${n} â”‚ ${o}`)}p>(l??20)&&s.appendResponseLine(`   ... (${p-(l??20)} more lines, total: ${p})`),s.appendResponseLine("   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")}}s.appendResponseLine("")}}});