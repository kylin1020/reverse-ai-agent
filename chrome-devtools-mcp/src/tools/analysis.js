/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{zod as e}from"../third_party/index.js";import{analyzeFunction as n,buildCallGraph as t}from"../utils/callGraphAnalyzer.js";import{getCdpSession as s}from"../utils/cdp.js";import{paginate as a}from"../utils/pagination.js";import{parseScript as o}from"../utils/scriptParser.js";import{searchInScriptsWithRg as r}from"../utils/rgSearcher.js";import{getAllScriptsWithSource as i,getScriptCache as p}from"../utils/smartBreakpointUtils.js";import{ToolCategory as c}from"./categories.js";import{defineTool as l}from"./ToolDefinition.js";const d=new WeakMap;function u(e){let n=d.get(e);return n||(n=new Map,d.set(e,n)),n}function m(e,n,t,s){const a=u(e),r=a.get(n);if(r)return r;const i=o(n,t,s);return a.set(n,i),i}export function clearParseResultCache(e){u(e).clear()}function h(e,n="",t=!0){const s=Object.entries(e);if(0===s.length)return"";let a="";return s.forEach(([e,o],r)=>{const i=r===s.length-1,p=t?"    ":"â”‚   ";a+=`${n}${t?"â””â”€â”€ ":"â”œâ”€â”€ "}${e}\n`,"Leaf"!==o&&Object.keys(o).length>0&&(a+=h(o,n+p,i))}),a}export const analyzeCallGraph=l({name:"analyze_call_graph",description:"Analyze the call graph for a specific JavaScript function to understand its callers and callees.",annotations:{category:c.DEBUGGING,readOnlyHint:!0},schema:{functionName:e.string().describe("The name of the function to analyze."),upstreamDepth:e.number().int().min(0).max(10).optional().default(3).describe("Maximum depth for upstream trace (callers). Default: 3, Max: 10."),downstreamDepth:e.number().int().min(0).max(10).optional().default(3).describe("Maximum depth for downstream trace (callees). Default: 3, Max: 10."),urlPattern:e.string().optional().describe("Optional regex pattern to filter scripts by URL.")},handler:async(e,a,o)=>{const{functionName:r,upstreamDepth:p,downstreamDepth:c,urlPattern:l}=e.params,d=o.getSelectedPage(),u=await s(d);a.appendResponseLine(`Analyzing call graph for function: ${r}`),a.appendResponseLine("");const f=await i(u,l);if(0===f.size)return a.appendResponseLine("âŒ No scripts found."),l&&a.appendResponseLine(`   URL pattern: ${l}`),a.appendResponseLine(""),a.appendResponseLine("ðŸ’¡ Suggestions:"),a.appendResponseLine("   â€¢ Ensure the page has loaded JavaScript files"),void a.appendResponseLine("   â€¢ Check that the URL pattern is correct");a.appendResponseLine(`ðŸ“œ Parsed ${f.size} script(s)`);const g=[];let R=0,x=0,L=0;for(const[e,{url:n,source:t}]of f){const s=m(u,e,n,t);g.push(s),R+=s.functions.length,x+=s.calls.length,L+=s.errors.length}a.appendResponseLine(`ðŸ“Š Found ${R} functions, ${x} call relationships`),L>0&&a.appendResponseLine(`âš ï¸ ${L} parse error(s) encountered`),a.appendResponseLine("");const $=t(g),b=n($,r,p,c);if(!b.found){if(a.appendResponseLine(`âŒ Function "${r}" not found in any script.`),a.appendResponseLine(""),b.similarFunctions&&b.similarFunctions.length>0){a.appendResponseLine("ðŸ’¡ Similar functions found:");for(const e of b.similarFunctions){const n=$.functions.get(e);n?a.appendResponseLine(`   â€¢ ${e} (${n.scriptUrl}:${n.lineNumber})`):a.appendResponseLine(`   â€¢ ${e}`)}}return}if(b.functionInfo){const e=b.functionInfo;a.appendResponseLine(`âœ… Function found: ${e.name}`),a.appendResponseLine(`   Location: ${e.scriptUrl}:${e.lineNumber}:${e.columnNumber}`),a.appendResponseLine(`   Type: ${e.type}`),a.appendResponseLine(`   Parameters: ${e.params.length>0?e.params.join(", "):"(none)"}`)}a.appendResponseLine("");const y=Object.keys(b.upstream);a.appendResponseLine(`ðŸ“¥ Upstream (who calls ${r}): ${y.length} direct caller(s)`),y.length>0?a.appendResponseLine(h(b.upstream)):a.appendResponseLine("   (no callers found)"),a.appendResponseLine("");const j=Object.keys(b.downstream);a.appendResponseLine(`ðŸ“¤ Downstream (what ${r} calls): ${j.length} direct callee(s)`),j.length>0?a.appendResponseLine(h(b.downstream)):a.appendResponseLine("   (no callees found)")}});export const searchScriptContent=l({name:"search_script_content",description:"Search for code snippets or patterns across all loaded JavaScript files using plain text or regex.",annotations:{category:c.DEBUGGING,readOnlyHint:!0},schema:{pattern:e.string().describe("The search pattern (string or regex)."),isRegex:e.boolean().optional().default(!1).describe("Whether to treat the pattern as a regular expression. Default: false."),urlPattern:e.string().optional().describe("Optional regex pattern to filter scripts by URL."),contextLength:e.number().int().min(100).max(2e3).optional().default(300).describe("Maximum characters of context to display around matches. Default: 300, Range: 100-2000."),pageSize:e.number().int().positive().optional().default(3).describe("Maximum number of matches to return per page. Default: 3."),pageIdx:e.number().int().min(0).optional().describe("Page number to return (0-based)."),maxTotalChars:e.number().int().positive().optional().default(400).describe("Maximum total characters in the response to prevent context overflow. Default: 400.")},handler:async(e,n,t)=>{const{pattern:o,isRegex:i,urlPattern:c,contextLength:l,pageSize:d,pageIdx:u,maxTotalChars:m}=e.params,h=t.getSelectedPage(),g=await s(h);if(!o)return void n.appendResponseLine("âŒ Search pattern is required.");if(i)try{new RegExp(o)}catch(e){return n.appendResponseLine(`âŒ Invalid regular expression: ${o}`),void n.appendResponseLine(`   Error: ${e instanceof Error?e.message:String(e)}`)}const R=p(g),x=c?new RegExp(c):null;let L=0;for(const[,e]of R)!e.url||x&&!x.test(e.url)||L++;if(0===L)return n.appendResponseLine("âŒ No scripts found."),void(c&&n.appendResponseLine(`   URL pattern: ${c}`));const $=await r(g,o,i,c);if(0===$.totalMatches)return n.appendResponseLine(`ðŸ” No matches found for: ${o}`),void(i&&n.appendResponseLine("   (searched as regex)"));const b=a($.matches,{pageSize:d,pageIdx:u});let y=0;const j=[],v=e=>{const n=e.length+1;return!(y+n>(m??4e4))&&(j.push(e),y+=n,!0)};if(!v(`ðŸ” Search results for: ${o}`))return void n.appendResponseLine("âš ï¸ Response too large, cannot display results.");if(i&&!v("   (regex search)"))return n.appendResponseLine(j.join("\n")),void n.appendResponseLine("âš ï¸ Response truncated due to size limit.");if(!v(`ðŸ“Š Total matches: ${$.totalMatches}`))return n.appendResponseLine(j.join("\n")),void n.appendResponseLine("âš ï¸ Response truncated due to size limit.");if(b.totalPages>1){if(!v(`ðŸ“„ Showing ${b.startIndex+1}-${b.endIndex} (Page ${b.currentPage+1} of ${b.totalPages})`))return n.appendResponseLine(j.join("\n")),void n.appendResponseLine("âš ï¸ Response truncated due to size limit.");if(b.hasNextPage&&!v(`   Next page: pageIdx=${b.currentPage+1}`))return n.appendResponseLine(j.join("\n")),void n.appendResponseLine("âš ï¸ Response truncated due to size limit.")}if(!v(""))return n.appendResponseLine(j.join("\n")),void n.appendResponseLine("âš ï¸ Response truncated due to size limit.");let w=0;for(const e of b.items){const n=[];n.push(`ðŸ“ ${e.scriptUrl}:${e.lineNumber}:${e.columnNumber}`),n.push(`   Match: "${e.matchText}"`);const t=f(e,l??300);n.push(`   Context: ${t}`),n.push("");const s=n.join("\n");if(y+s.length>(m??4e4))break;for(const e of n)if(!v(e))break;w++}n.appendResponseLine(j.join("\n")),w<b.items.length&&(n.appendResponseLine(`âš ï¸ Response truncated: Displayed ${w} of ${b.items.length} matches due to size limit (${m} chars).`),n.appendResponseLine("ðŸ’¡ Try: reduce contextLength, use pagination (pageIdx), or increase maxTotalChars."))}});function f(e,n=300){const t=n;let s;if(e.context.length>t){const n=e.columnNumber,a=n+e.matchText.length,o=Math.floor((t-e.matchText.length)/2);let r=Math.max(0,n-o),i=Math.min(e.context.length,a+o);0===r?i=Math.min(e.context.length,t):i===e.context.length&&(r=Math.max(0,e.context.length-t));const p=r>0?"...":"",c=i<e.context.length?"...":"";s=p+e.context.substring(r,i)+c}else s=e.context;return s.replace(e.matchText,`ã€${e.matchText}ã€‘`).trim()}