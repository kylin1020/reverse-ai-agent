/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{zod as e}from"../third_party/index.js";import{getCdpSession as n}from"../utils/cdp.js";import{paginate as t}from"../utils/pagination.js";import{analyzeFunction as s,buildCallGraph as o}from"../utils/callGraphAnalyzer.js";import{ToolCategory as a}from"./categories.js";import{parseScript as i}from"../utils/scriptParser.js";import{getAllScriptsWithSource as p}from"../utils/smartBreakpointUtils.js";import{defineTool as r}from"./ToolDefinition.js";const c=new WeakMap,l=new WeakMap;function d(e){let n=c.get(e);return n||(n=new Map,c.set(e,n)),n}function u(e,n,t,s){const o=d(e),a=o.get(n);if(a)return a;const p=i(n,t,s);return o.set(n,p),l.delete(e),p}export function clearParseResultCache(e){d(e).clear(),l.delete(e)}function f(e,n="",t=!0){const s=Object.entries(e);if(0===s.length)return"";let o="";return s.forEach(([e,a],i)=>{const p=i===s.length-1,r=t?"    ":"â”‚   ";o+=`${n}${t?"â””â”€â”€ ":"â”œâ”€â”€ "}${e}\n`,"Leaf"!==a&&Object.keys(a).length>0&&(o+=f(a,n+r,p))}),o}export const analyzeCallGraph=r({name:"analyze_call_graph",description:"Analyze the call graph for a specific JavaScript function to understand its callers and callees.",annotations:{category:a.DEBUGGING,readOnlyHint:!0},schema:{functionName:e.string().describe("The name of the function to analyze."),upstreamDepth:e.number().int().min(0).max(10).optional().default(3).describe("Maximum depth for upstream trace (callers). Default: 3, Max: 10."),downstreamDepth:e.number().int().min(0).max(10).optional().default(3).describe("Maximum depth for downstream trace (callees). Default: 3, Max: 10."),urlPattern:e.string().optional().describe("Optional regex pattern to filter scripts by URL.")},handler:async(e,t,a)=>{const{functionName:i,upstreamDepth:r,downstreamDepth:c,urlPattern:l}=e.params,d=a.getSelectedPage(),m=await n(d);t.appendResponseLine(`Analyzing call graph for function: ${i}`),t.appendResponseLine("");const h=await p(m,l);if(0===h.size)return t.appendResponseLine("âŒ No scripts found."),l&&t.appendResponseLine(`   URL pattern: ${l}`),t.appendResponseLine(""),t.appendResponseLine("ðŸ’¡ Suggestions:"),t.appendResponseLine("   â€¢ Ensure the page has loaded JavaScript files"),void t.appendResponseLine("   â€¢ Check that the URL pattern is correct");t.appendResponseLine(`ðŸ“œ Parsed ${h.size} script(s)`);const g=[];let L=0,R=0,$=0;for(const[e,{url:n,source:t}]of h){const s=u(m,e,n,t);g.push(s),L+=s.functions.length,R+=s.calls.length,$+=s.errors.length}t.appendResponseLine(`ðŸ“Š Found ${L} functions, ${R} call relationships`),$>0&&t.appendResponseLine(`âš ï¸ ${$} parse error(s) encountered`),t.appendResponseLine("");const b=o(g),y=s(b,i,r,c);if(!y.found){if(t.appendResponseLine(`âŒ Function "${i}" not found in any script.`),t.appendResponseLine(""),y.similarFunctions&&y.similarFunctions.length>0){t.appendResponseLine("ðŸ’¡ Similar functions found:");for(const e of y.similarFunctions){const n=b.functions.get(e);n?t.appendResponseLine(`   â€¢ ${e} (${n.scriptUrl}:${n.lineNumber})`):t.appendResponseLine(`   â€¢ ${e}`)}}return}if(y.functionInfo){const e=y.functionInfo;t.appendResponseLine(`âœ… Function found: ${e.name}`),t.appendResponseLine(`   Location: ${e.scriptUrl}:${e.lineNumber}:${e.columnNumber}`),t.appendResponseLine(`   Type: ${e.type}`),t.appendResponseLine(`   Parameters: ${e.params.length>0?e.params.join(", "):"(none)"}`)}t.appendResponseLine("");const x=Object.keys(y.upstream);t.appendResponseLine(`ðŸ“¥ Upstream (who calls ${i}): ${x.length} direct caller(s)`),x.length>0?t.appendResponseLine(f(y.upstream)):t.appendResponseLine("   (no callers found)"),t.appendResponseLine("");const z=Object.keys(y.downstream);t.appendResponseLine(`ðŸ“¤ Downstream (what ${i} calls): ${z.length} direct callee(s)`),z.length>0?t.appendResponseLine(f(y.downstream)):t.appendResponseLine("   (no callees found)")}});function m(e,n){const t=e.toLowerCase(),s=n.toLowerCase();if(t===s)return 1;if(s.includes(t))return.8;if(t.includes(s))return.7;if(Math.min(t.length,s.length)/Math.max(t.length,s.length)<.3)return 0;const o=new Set(t),a=new Set(s);let i=0;for(const e of o)a.has(e)&&i++;return i/Math.max(o.size,a.size)}export const searchFunctions=r({name:"search_functions",description:"Search for function definitions by name across all loaded JavaScript files. Supports exact, pattern, and fuzzy matching.",annotations:{category:a.DEBUGGING,readOnlyHint:!0},schema:{namePattern:e.string().describe("The function name or pattern to search for."),urlPattern:e.string().optional().describe("Optional regex pattern to filter scripts by URL."),fuzzy:e.boolean().optional().default(!0).describe("Whether to use fuzzy matching for similar names. Default: true."),showCode:e.boolean().optional().default(!1).describe("Whether to display the formatted function body code. Default: false."),maxCodeLines:e.number().int().positive().optional().default(20).describe("Maximum lines of code to display per function. Default: 20."),contextLength:e.number().int().min(100).max(2e3).optional().default(800).describe("Maximum characters of context to display when showCode=true. Default: 800, Range: 100-2000."),pageSize:e.number().int().positive().optional().describe("Maximum number of functions to return per page."),pageIdx:e.number().int().min(0).optional().describe("Page number to return (0-based).")},handler:async(e,s,o)=>{const{namePattern:a,urlPattern:i,fuzzy:r,showCode:c,maxCodeLines:f,contextLength:h,pageSize:g,pageIdx:L}=e.params,R=o.getSelectedPage(),$=await n(R);if(!a)return void s.appendResponseLine("âŒ Function name pattern is required.");const b=await p($,i);if(0===b.size)return s.appendResponseLine("âŒ No scripts found."),void(i&&s.appendResponseLine(`   URL pattern: ${i}`));for(const[e,{url:n,source:t}]of b)u($,e,n,t);const y=function(e,n){const t=new Set(n.keys()),s=d(e),o=l.get(e);if(o&&t.size===s.size)return o;const a=[];for(const e of t){const n=s.get(e);n&&a.push(...n.functions)}if(t.size===s.size&&o){const n=[];for(const e of s.values())n.push(...e.functions);return l.set(e,n),n}return a}($,b);if(0===y.length)return void s.appendResponseLine("âŒ No functions found in loaded scripts.");let x=[],z=!1,w=null;try{/[.*+?^${}()|[\]\\]/.test(a)&&(w=new RegExp(a,"i"),z=!0)}catch{}if(z&&w)x=y.filter(e=>w.test(e.name));else{const e=a.toLowerCase();if(x=y.filter(n=>n.name.toLowerCase()===e),0===x.length&&r){x=y.map(e=>({func:e,score:m(a,e.name)})).filter(e=>e.score>=.3).sort((e,n)=>n.score-e.score).map(e=>e.func)}}if(0===x.length){s.appendResponseLine(`ðŸ” No functions found matching: ${a}`),r&&s.appendResponseLine("   (fuzzy search enabled)");const e=y.slice(0,5);if(e.length>0){s.appendResponseLine(""),s.appendResponseLine("ðŸ’¡ Sample functions in loaded scripts:");for(const n of e)s.appendResponseLine(`   â€¢ ${n.name} (${n.type})`)}return}const P=t(x,{pageSize:g,pageIdx:L});s.appendResponseLine(`ðŸ” Functions matching: ${a}`),z?s.appendResponseLine("   (regex pattern)"):r&&x.length>0&&s.appendResponseLine("   (fuzzy matching)"),s.appendResponseLine(`ðŸ“Š Total matches: ${x.length}`),P.totalPages>1&&(s.appendResponseLine(`ðŸ“„ Showing ${P.startIndex+1}-${P.endIndex} (Page ${P.currentPage+1} of ${P.totalPages})`),P.hasNextPage&&s.appendResponseLine(`   Next page: pageIdx=${P.currentPage+1}`)),s.appendResponseLine("");for(const e of P.items){if(s.appendResponseLine(`ðŸ“ ${e.name}`),s.appendResponseLine(`   Location: ${e.scriptUrl}:${e.lineNumber}:${e.columnNumber}`),s.appendResponseLine(`   Type: ${e.type}`),s.appendResponseLine(`   Parameters: ${e.params.length>0?e.params.join(", "):"(none)"}`),c){const n=b.get(e.scriptId);if(n?.source){const t=h??800,o=n.source.split("\n"),a=e.lineNumber-1,i=Math.min(a+(f??20),o.length),p=o.slice(a,i),r=o.length-a;s.appendResponseLine("   Code:"),s.appendResponseLine("   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");for(let e=0;e<p.length;e++){const n=String(a+e+1).padStart(4," ");let o=p[e];o.length>t&&(o=o.substring(0,t)+"..."),s.appendResponseLine(`   ${n} â”‚ ${o}`)}r>(f??20)&&s.appendResponseLine(`   ... (${r-(f??20)} more lines, total: ${r})`),s.appendResponseLine("   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")}}s.appendResponseLine("")}}});