/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import*as e from"acorn";function t(e,t){let n=1,r=-1;for(let o=0;o<t&&o<e.length;o++)"\n"===e[o]&&(n++,r=o);return{line:n,column:t-r-1}}function n(e){return e?e.map((e,t)=>e.name?e.name:"RestElement"===e.type?"...rest":"ObjectPattern"===e.type?"{...}":"ArrayPattern"===e.type?"[...]":(e.type,`param${t}`)):[]}export function parseScript(r,o,a){const s=[],i=[],l=[],c=["<global>"];let p;try{p=e.parse(a,{ecmaVersion:"latest",sourceType:"module",allowHashBang:!0,allowAwaitOutsideFunction:!0,allowImportExportEverywhere:!0,allowReserved:!0})}catch(e){const t=e;return l.push({scriptId:r,scriptUrl:o,message:t.message||String(e),line:t.loc?.line,column:t.loc?.column}),{functions:s,calls:i,errors:l}}function u(e,i,l,c){const p=t(a,l.start);s.push({name:e,scriptId:r,scriptUrl:o,lineNumber:p.line,columnNumber:p.column,params:n(c),type:i})}function m(e,n){var o;if(e)switch(e.type){case"FunctionDeclaration":{const t=e.id?.name||n||`<anonymous@${e.start}>`;u(t,"declaration",e,e.params),c.push(t),f(e.body),c.pop();break}case"FunctionExpression":{const t=e.id?.name||n||`<anonymous@${e.start}>`;u(t,e.id?.name||n?"expression":"anonymous",e,e.params),c.push(t),f(e.body),c.pop();break}case"ArrowFunctionExpression":{const t=n||`<anonymous@${e.start}>`;u(t,"arrow",e,e.params),c.push(t),f(e.body),c.pop();break}case"VariableDeclaration":for(const t of e.declarations||[]){const e="Identifier"===t.id?.type?t.id.name:void 0;t.init&&m(t.init,e)}break;case"AssignmentExpression":{let t;"Identifier"===e.left?.type&&e.left.name?t=e.left.name:"MemberExpression"===e.left?.type&&e.left.property?.name&&(t=e.left.property.name),m(e.right,t);break}case"Property":{const t=e.key?.name||e.key?.value;e.value&&("FunctionExpression"===e.value.type||"ArrowFunctionExpression"===e.value.type?m(e.value,t):m(e.value));break}case"MethodDefinition":{const t=e.key?.name||e.key?.value||`<method@${e.start}>`;if(e.value){const n=e.value;u(t,"method",n,n.params),c.push(t),f(n.body),c.pop()}break}case"CallExpression":{const n="Identifier"===(o=e.callee).type&&o.name?o.name:"MemberExpression"===o.type&&o.property?.name?o.property.name:null;if(n){const o=t(a,e.start);i.push({caller:c[c.length-1],callee:n,scriptId:r,lineNumber:o.line,columnNumber:o.column})}m(e.callee);for(const t of e.arguments||[])m(t);break}case"ObjectExpression":for(const t of e.properties||[])m(t);break;case"ClassDeclaration":case"ClassExpression":{const t=e.body;if(t?.body)for(const e of t.body)m(e);break}default:if(f(e.body),e.expression&&m(e.expression),e.init&&m(e.init),e.test&&m(e.test),e.update&&m(e.update),e.consequent&&f(e.consequent),e.alternate&&m(e.alternate),e.argument&&m(e.argument),e.left&&m(e.left),e.right&&m(e.right),e.object&&m(e.object),e.elements)for(const t of e.elements)t&&m(t);if(e.declarations)for(const t of e.declarations)t.init&&m(t.init)}}function f(e){if(e)if(Array.isArray(e))for(const t of e)m(t);else m(e)}return f(p.body),{functions:s,calls:i,errors:l}}