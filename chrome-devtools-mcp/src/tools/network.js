/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{zod as e}from"../third_party/index.js";import{formatInitiator as t}from"../utils/cdp.js";import{getConfig as s}from"../utils/config.js";import{paginate as n}from"../utils/pagination.js";import{ToolCategory as o}from"./categories.js";import{defineTool as r}from"./ToolDefinition.js";function i(e,t,s){const n=e.toLowerCase(),o=t.toLowerCase(),r=n.indexOf(o);if(-1===r)return"";const i=Math.floor((s-t.length)/2),a=Math.max(0,r-i),c=Math.min(e.length,r+t.length+i);let p=e.substring(a,c);a>0&&(p="..."+p),c<e.length&&(p+="...");const u=r-a+(a>0?3:0),d=u+t.length;return p=p.substring(0,u)+"**"+p.substring(u,d)+"**"+p.substring(d),p}function a(e,t,s,n=3){const o=[],r=e.toLowerCase(),i=t.toLowerCase();let a=0;for(;o.length<n;){const n=r.indexOf(i,a);if(-1===n)break;const c=Math.floor((s-t.length)/2),p=Math.max(0,n-c),u=Math.min(e.length,n+t.length+c);let d=e.substring(p,u);p>0&&(d="..."+d),u<e.length&&(d+="...");const l=n-p+(p>0?3:0),h=l+t.length;d=d.substring(0,l)+"**"+d.substring(l,h)+"**"+d.substring(h),o.push(d),a=n+t.length}return o}function c(e){return Object.entries(e).map(([e,t])=>`${e}: ${t}`).join("\n")}const p=["document","stylesheet","image","media","font","script","texttrack","xhr","fetch","prefetch","eventsource","websocket","manifest","signedexchange","ping","cspviolationreport","preflight","fedcm","other"];export const listNetworkRequests=r({name:"list_network_requests",description:"List all requests for the currently selected page since the last navigation.",annotations:{category:o.NETWORK,readOnlyHint:!0},schema:{pageSize:e.number().int().positive().optional().describe("Maximum number of requests to return. When omitted, returns all requests."),pageIdx:e.number().int().min(0).optional().describe("Page number to return (0-based). When omitted, returns the first page."),resourceTypes:e.array(e.enum(p)).optional().describe("Filter requests to only return requests of the specified resource types. When omitted or empty, returns all requests."),includePreservedRequests:e.boolean().default(!1).optional().describe("Set to true to return the preserved requests over the last 3 navigations.")},handler:async(e,t,s)=>{const n=await s.getDevToolsData();t.attachDevToolsData(n);const o=n?.cdpRequestId?s.resolveCdpRequestId(n.cdpRequestId):void 0;t.setIncludeNetworkRequests(!0,{pageSize:e.params.pageSize,pageIdx:e.params.pageIdx,resourceTypes:e.params.resourceTypes,includePreservedRequests:e.params.includePreservedRequests,networkRequestIdInDevToolsUI:o})}});export const getNetworkRequest=r({name:"get_network_request",description:"Gets a network request by an optional reqid, if omitted returns the currently selected request in the DevTools Network panel.",annotations:{category:o.NETWORK,readOnlyHint:!0},schema:{reqid:e.number().optional().describe("The reqid of the network request. If omitted returns the currently selected request in the DevTools Network panel.")},handler:async(e,t,s)=>{if(e.params.reqid)t.attachNetworkRequest(e.params.reqid);else{const e=await s.getDevToolsData();t.attachDevToolsData(e);const n=e?.cdpRequestId?s.resolveCdpRequestId(e.cdpRequestId):void 0;n?t.attachNetworkRequest(n):t.appendResponseLine("Nothing is currently selected in the DevTools Network panel.")}}});export const searchNetworkRequests=r({name:"search_network_requests",description:"Search network requests by URL pattern, HTTP method, status code, content type, or content body. When searchContent is provided, searches in URL, headers, request body, and response body, returning only matching snippets with request IDs (similar to DevTools search). Returns matching requests from the currently selected page.",annotations:{category:o.NETWORK,readOnlyHint:!0},schema:{searchContent:e.string().optional().describe("Search term to find in URL, request/response headers, and request/response bodies. Returns matching snippets with highlighted matches. When provided, other filters still apply but output shows only snippets."),urlPattern:e.string().optional().describe('URL pattern to search for. Supports substring match or regex pattern (e.g., "api/users" or ".*\\.json$").'),method:e.enum(["GET","POST","PUT","DELETE","PATCH","HEAD","OPTIONS"]).optional().describe("Filter by HTTP method."),statusCode:e.number().int().optional().describe("Filter by exact status code (e.g., 200, 404, 500)."),statusCodeMin:e.number().int().optional().describe("Filter by minimum status code (inclusive)."),statusCodeMax:e.number().int().optional().describe("Filter by maximum status code (inclusive)."),contentType:e.string().optional().describe('Filter by response content type. Supports substring match (e.g., "json", "text/html").'),resourceTypes:e.array(e.enum(p)).optional().describe("Filter requests to only return requests of the specified resource types."),includePreservedRequests:e.boolean().default(!1).optional().describe("Set to true to search in preserved requests over the last 3 navigations."),pageSize:e.number().int().positive().optional().describe("Maximum number of matching requests to return. When omitted, uses default page size."),pageIdx:e.number().int().min(0).optional().describe("Page number to return (0-based). When omitted, returns the first page.")},handler:async(e,t,o)=>{const{searchContent:r,urlPattern:p,method:u,statusCode:d,statusCodeMin:h,statusCodeMax:f,contentType:m,resourceTypes:g,includePreservedRequests:y,pageSize:b,pageIdx:w}=e.params,q=s();let v;if(p)try{v=new RegExp(p,"i")}catch{v=new RegExp(p.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i")}if(r){let e=o.getNetworkRequests(y);if(g?.length){const t=new Set(g);e=e.filter(e=>t.has(e.resourceType()))}const s=[],p=r;for(const t of e){if(v&&!v.test(t.url()))continue;if(u&&t.method()!==u)continue;const e=t.response(),n=e?.status();if(void 0!==d&&n!==d)continue;if(void 0!==h&&void 0!==n&&n<h)continue;if(void 0!==f&&void 0!==n&&n>f)continue;if(m&&e){if(!(e.headers()["content-type"]??"").toLowerCase().includes(m.toLowerCase()))continue}const r=[],g=o.getNetworkRequestStableId(t),y=t.url();if(y.toLowerCase().includes(p.toLowerCase())){const e=i(y,p,q.maxSnippetLength);e&&r.push({location:"url",snippet:e})}const b=c(t.headers());if(b.toLowerCase().includes(p.toLowerCase())){const e=a(b,p,q.maxSnippetLength,2);for(const t of e)r.push({location:"request-headers",snippet:t})}try{const e=t.postData?.()??"";if(e&&e.toLowerCase().includes(p.toLowerCase())){const t=a(e,p,q.maxSnippetLength,2);for(const e of t)r.push({location:"request-body",snippet:e})}}catch{}if(e){const t=c(e.headers());if(t.toLowerCase().includes(p.toLowerCase())){const e=a(t,p,q.maxSnippetLength,2);for(const t of e)r.push({location:"response-headers",snippet:t})}try{if(l(e.headers()["content-type"]??"")){const t=await e.text();if(t&&t.toLowerCase().includes(p.toLowerCase())){const e=a(t,p,q.maxSnippetLength,3);for(const t of e)r.push({location:"response-body",snippet:t})}}}catch{}}if(r.length>0){const n=e?`${e.status()}`:t.failure()?`failed: ${t.failure()?.errorText}`:"pending";s.push({reqid:g,method:t.method(),url:t.url(),status:n,matches:r})}}const R=n(s,{pageSize:b,pageIdx:w});t.appendResponseLine(`## Search results for "${r}" (${s.length} matches)`),R.totalPages>1&&(t.appendResponseLine(`Showing ${R.startIndex+1}-${R.endIndex} of ${s.length} (Page ${R.currentPage+1} of ${R.totalPages})`),R.hasNextPage&&t.appendResponseLine(`Next page: pageIdx=${R.currentPage+1}`)),t.appendResponseLine("");for(const e of R.items){t.appendResponseLine(`**reqid=${e.reqid}** ${e.method} ${e.url} [${e.status}]`);for(const s of e.matches)t.appendResponseLine(`  ${s.location}: ${s.snippet}`);t.appendResponseLine("")}return void(0===s.length&&t.appendResponseLine("No matches found."))}t.setIncludeNetworkRequests(!0,{pageSize:b,pageIdx:w,resourceTypes:g,includePreservedRequests:y,filter:e=>{if(v&&!v.test(e.url()))return!1;if(u&&e.method()!==u)return!1;const t=e.response(),s=t?.status();if(void 0!==d&&s!==d)return!1;if(void 0!==h&&void 0!==s&&s<h)return!1;if(void 0!==f&&void 0!==s&&s>f)return!1;if(m&&t){if(!(t.headers()["content-type"]??"").toLowerCase().includes(m.toLowerCase()))return!1}return!0}})}});function u(e,t,s="response-body"){const n=function(e){if(!e)return".bin";const t=e.toLowerCase();return t.includes("image/png")?".png":t.includes("image/jpeg")||t.includes("image/jpg")?".jpg":t.includes("image/webp")?".webp":t.includes("application/pdf")?".pdf":t.includes("application/zip")?".zip":t.includes("application/gzip")||t.includes("application/x-gzip")?".gz":(t.includes("application/octet-stream")||t.includes("multipart/form-data"),".bin")}(t);return`${e.replace(/\.[^./\\]+$/,"")}.${s}${n}`}function d(e){return Object.entries(e).map(([e,t])=>`${e}: ${t}`)}function l(e){if(!e)return!0;const t=e.toLowerCase();return!!t.startsWith("text/")||(!!t.includes("application/json")||(!!t.includes("application/javascript")||(!!t.includes("application/xml")||(!!t.includes("application/x-www-form-urlencoded")||(!!t.includes("+json")||!!t.includes("+xml"))))))}export const saveNetworkRequest=r({name:"save_network_request",description:"Saves a network request (and response if available) to a local file in raw HTTP format. If the response body is binary, it will be saved to a separate file and referenced from the main file.",annotations:{category:o.NETWORK,readOnlyHint:!1},schema:{reqid:e.number().optional().describe("The reqid of the network request. If omitted, uses the currently selected request in the DevTools Network panel."),filePath:e.string().describe("Absolute or relative file path where the HTTP transaction will be saved."),responseBodyFilePath:e.string().optional().describe("Optional file path to save the response body when it is binary. When omitted, it will be derived from filePath."),saveRequestBody:e.boolean().optional().describe("When true, also saves the request body to a separate file. Useful for binary or encoded request bodies."),requestBodyFilePath:e.string().optional().describe("Optional file path to save the request body. When omitted but saveRequestBody is true, it will be derived from filePath.")},handler:async(e,s,n)=>{let o=e.params.reqid;if(!o){const e=await n.getDevToolsData();s.attachDevToolsData(e),o=e?.cdpRequestId?n.resolveCdpRequestId(e.cdpRequestId):void 0}if(!o)return void s.appendResponseLine("Nothing is currently selected in the DevTools Network panel.");const r=n.getNetworkRequestById(o);let i=null;try{i=new URL(r.url())}catch{i=null}const a=r.method(),c=i?`${i.pathname||"/"}${i.search||""}`:r.url(),p={...r.headers()};!i||"host"in p||"Host"in p||(p.host=i.host);const h=await async function(e){try{if(e?.hasPostData?.()){const t=await(e.fetchPostData?.().catch(()=>{}));if("string"==typeof t)return t;const s=e.postData?.();if("string"==typeof s)return s}}catch{}}(r),f=p["content-type"]??p["Content-Type"];let m;const g=[];if(g.push(`${a} ${c} HTTP/1.1`),g.push(...d(p)),g.push(""),h){g.push(h);if(e.params.saveRequestBody||e.params.requestBodyFilePath){const t=e.params.requestBodyFilePath??u(e.params.filePath,f,"request-body"),s=new TextEncoder;await n.saveFile(s.encode(h),t),m=t}}const y=r.response(),b=[];let w;if(y){const t=y.status(),s=y.statusText?.()??"";b.push(`HTTP/1.1 ${t}${s?` ${s}`:""}`);const o=y.headers();b.push(...d(o)),b.push("");const r=o["content-type"];if(l(r))try{const e=await y.text();e.length&&b.push(e)}catch{b.push("<response body not available anymore>")}else try{const t=await y.buffer(),s=e.params.responseBodyFilePath??u(e.params.filePath,r);await n.saveFile(new Uint8Array(t),s),w=s,b.push(`<binary response body saved to: ${s}>`)}catch{b.push("<response body not available anymore>")}}else b.push("HTTP/1.1 000 <pending/no response>"),b.push("");const q=[],v=n.getNetworkRequestInitiator(o);if(v){q.push("=== Initiator ===");for(const e of t(v))q.push(e)}const R=[...g,"",...b,"",...q].join("\r\n");await n.saveFile((new TextEncoder).encode(R),e.params.filePath),s.appendResponseLine(`Saved network request reqid=${o} to ${e.params.filePath}.`),m&&s.appendResponseLine(`Saved request body to ${m}.`),w&&s.appendResponseLine(`Saved binary response body to ${w}.`)}});function h(e){try{const t=new URL(e),s=t.pathname.split("/").filter(e=>e.length>0);if(s.length>0){return s[s.length-1].split("?")[0]}}catch{}return"resource"}function f(e,t){const s=h(t).match(/\.([a-zA-Z0-9]+)$/);if(s)return"."+s[1];if(!e)return"";const n=e.toLowerCase();return n.includes("javascript")||n.includes("ecmascript")?".js":n.includes("text/css")?".css":n.includes("text/html")?".html":n.includes("application/json")||n.includes("+json")?".json":n.includes("application/xml")||n.includes("text/xml")||n.includes("+xml")?".xml":n.includes("image/png")?".png":n.includes("image/jpeg")||n.includes("image/jpg")?".jpg":n.includes("image/gif")?".gif":n.includes("image/webp")?".webp":n.includes("image/svg")?".svg":n.includes("image/ico")||n.includes("image/x-icon")?".ico":n.includes("font/woff2")?".woff2":n.includes("font/woff")?".woff":n.includes("font/ttf")||n.includes("font/truetype")?".ttf":n.includes("font/otf")||n.includes("font/opentype")?".otf":n.includes("application/pdf")?".pdf":n.includes("text/plain")?".txt":""}export const saveStaticResource=r({name:"save_static_resource",description:"Save a static resource (JS, CSS, image, font, etc.) from a network request to a local file. The file is saved with its response body only (no HTTP headers). File extension is automatically determined from content-type or URL.",annotations:{category:o.NETWORK,readOnlyHint:!1},schema:{reqid:e.number().describe("The reqid of the network request containing the resource to save."),filePath:e.string().describe('Path to save the file. Can be a full file path (e.g., "/path/to/file.js") or a directory path (e.g., "/path/to/dir/"). If a directory, filename is derived from the URL.')},handler:async(e,t,s)=>{const{reqid:n,filePath:o}=e.params,r=s.getNetworkRequestById(n);if(!r)return void t.appendResponseLine(`Error: Request with reqid=${n} not found.`);const i=r.response();if(!i)return void t.appendResponseLine(`Error: Request reqid=${n} has no response yet (pending or failed).`);const a=r.url(),c=i.headers()["content-type"];let p=o;if(o.endsWith("/")||o.endsWith("\\")){let e=h(a);if(!e.includes(".")){const t=f(c,a);t&&(e+=t)}p=o+e}else if(!p.match(/\.[a-zA-Z0-9]+$/)){const e=f(c,a);e&&(p+=e)}try{if(l(c)){const e=await i.text();await s.saveFile((new TextEncoder).encode(e),p)}else{const e=await i.buffer();await s.saveFile(new Uint8Array(e),p)}t.appendResponseLine(`Saved static resource from reqid=${n} to ${p}`),t.appendResponseLine(`Source URL: ${a}`),c&&t.appendResponseLine(`Content-Type: ${c}`)}catch(e){t.appendResponseLine(`Error saving resource: ${e instanceof Error?e.message:String(e)}`)}}});