/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{zod as e}from"../third_party/index.js";import{truncateUrl as t}from"../formatters/networkFormatter.js";import{formatInitiator as s}from"../utils/cdp.js";import{getConfig as n}from"../utils/config.js";import{paginate as o}from"../utils/pagination.js";import{ToolCategory as r}from"./categories.js";import{defineTool as i}from"./ToolDefinition.js";function a(e,t,s){const n=e.toLowerCase(),o=t.toLowerCase(),r=n.indexOf(o);if(-1===r)return"";const i=Math.floor((s-t.length)/2),a=Math.max(0,r-i),c=Math.min(e.length,r+t.length+i);let p=e.substring(a,c);a>0&&(p="..."+p),c<e.length&&(p+="...");const u=r-a+(a>0?3:0),d=u+t.length;return p=p.substring(0,u)+"**"+p.substring(u,d)+"**"+p.substring(d),p}function c(e,t,s,n=3){const o=[],r=e.toLowerCase(),i=t.toLowerCase();let a=0;for(;o.length<n;){const n=r.indexOf(i,a);if(-1===n)break;const c=Math.floor((s-t.length)/2),p=Math.max(0,n-c),u=Math.min(e.length,n+t.length+c);let d=e.substring(p,u);p>0&&(d="..."+d),u<e.length&&(d+="...");const l=n-p+(p>0?3:0),h=l+t.length;d=d.substring(0,l)+"**"+d.substring(l,h)+"**"+d.substring(h),o.push(d),a=n+t.length}return o}function p(e){return Object.entries(e).map(([e,t])=>`${e}: ${t}`).join("\n")}const u=["document","stylesheet","image","media","font","script","texttrack","xhr","fetch","prefetch","eventsource","websocket","manifest","signedexchange","ping","cspviolationreport","preflight","fedcm","other"];export const listNetworkRequests=i({name:"list_network_requests",description:"List all requests for the currently selected page since the last navigation.",annotations:{category:r.NETWORK,readOnlyHint:!0},schema:{pageSize:e.number().int().positive().optional().describe("Maximum number of requests to return. When omitted, returns all requests."),pageIdx:e.number().int().min(0).optional().describe("Page number to return (0-based). When omitted, returns the first page."),resourceTypes:e.array(e.enum(u)).optional().describe("Filter requests to only return requests of the specified resource types. When omitted or empty, returns all requests."),includePreservedRequests:e.boolean().default(!1).optional().describe("Set to true to return the preserved requests over the last 3 navigations.")},handler:async(e,t,s)=>{const n=await s.getDevToolsData();t.attachDevToolsData(n);const o=n?.cdpRequestId?s.resolveCdpRequestId(n.cdpRequestId):void 0;t.setIncludeNetworkRequests(!0,{pageSize:e.params.pageSize,pageIdx:e.params.pageIdx,resourceTypes:e.params.resourceTypes,includePreservedRequests:e.params.includePreservedRequests,networkRequestIdInDevToolsUI:o})}});export const getNetworkRequest=i({name:"get_network_request",description:"Get a network request by reqid, or the currently selected request in DevTools if omitted.",annotations:{category:r.NETWORK,readOnlyHint:!0},schema:{reqid:e.number().optional().describe("The reqid of the network request. If omitted returns the currently selected request in the DevTools Network panel.")},handler:async(e,t,s)=>{if(e.params.reqid)t.attachNetworkRequest(e.params.reqid);else{const e=await s.getDevToolsData();t.attachDevToolsData(e);const n=e?.cdpRequestId?s.resolveCdpRequestId(e.cdpRequestId):void 0;n?t.attachNetworkRequest(n):t.appendResponseLine("Nothing is currently selected in the DevTools Network panel.")}}});export const searchNetworkRequests=i({name:"search_network_requests",description:"Search network requests by URL pattern, HTTP method, status code, content type, or content body.",annotations:{category:r.NETWORK,readOnlyHint:!0},schema:{searchContent:e.string().optional().describe("Search term to find in URL, request/response headers, and request/response bodies. Returns matching snippets with highlighted matches. When provided, other filters still apply but output shows only snippets."),urlPattern:e.string().optional().describe('URL pattern to search for. Supports substring match or regex pattern (e.g., "api/users" or ".*\\.json$").'),method:e.enum(["GET","POST","PUT","DELETE","PATCH","HEAD","OPTIONS"]).optional().describe("Filter by HTTP method."),statusCode:e.number().int().optional().describe("Filter by exact status code (e.g., 200, 404, 500)."),statusCodeMin:e.number().int().optional().describe("Filter by minimum status code (inclusive)."),statusCodeMax:e.number().int().optional().describe("Filter by maximum status code (inclusive)."),contentType:e.string().optional().describe('Filter by response content type. Supports substring match (e.g., "json", "text/html").'),resourceTypes:e.array(e.enum(u)).optional().describe("Filter requests to only return requests of the specified resource types."),includePreservedRequests:e.boolean().default(!1).optional().describe("Set to true to search in preserved requests over the last 3 navigations."),pageSize:e.number().int().positive().optional().describe("Maximum number of matching requests to return. When omitted, uses default page size."),pageIdx:e.number().int().min(0).optional().describe("Page number to return (0-based). When omitted, returns the first page.")},handler:async(e,s,r)=>{const{searchContent:i,urlPattern:u,method:d,statusCode:l,statusCodeMin:f,statusCodeMax:m,contentType:g,resourceTypes:y,includePreservedRequests:b,pageSize:w,pageIdx:q}=e.params,v=n();let R;if(u)try{R=new RegExp(u,"i")}catch{R=new RegExp(u.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i")}if(i){let e=r.getNetworkRequests(b);if(y?.length){const t=new Set(y);e=e.filter(e=>t.has(e.resourceType()))}const n=[],u=i;for(const t of e){if(R&&!R.test(t.url()))continue;if(d&&t.method()!==d)continue;const e=t.response(),s=e?.status();if(void 0!==l&&s!==l)continue;if(void 0!==f&&void 0!==s&&s<f)continue;if(void 0!==m&&void 0!==s&&s>m)continue;if(g&&e){if(!(e.headers()["content-type"]??"").toLowerCase().includes(g.toLowerCase()))continue}const o=[],i=r.getNetworkRequestStableId(t),y=t.url();if(y.toLowerCase().includes(u.toLowerCase())){const e=a(y,u,v.maxSnippetLength);e&&o.push({location:"url",snippet:e})}const b=p(t.headers());if(b.toLowerCase().includes(u.toLowerCase())){const e=c(b,u,v.maxSnippetLength,2);for(const t of e)o.push({location:"request-headers",snippet:t})}try{const e=t.postData?.()??"";if(e&&e.toLowerCase().includes(u.toLowerCase())){const t=c(e,u,v.maxSnippetLength,2);for(const e of t)o.push({location:"request-body",snippet:e})}}catch{}if(e){const t=p(e.headers());if(t.toLowerCase().includes(u.toLowerCase())){const e=c(t,u,v.maxSnippetLength,2);for(const t of e)o.push({location:"response-headers",snippet:t})}try{if(h(e.headers()["content-type"]??"")){const t=await e.text();if(t&&t.toLowerCase().includes(u.toLowerCase())){const e=c(t,u,v.maxSnippetLength,3);for(const t of e)o.push({location:"response-body",snippet:t})}}}catch{}}if(o.length>0){const s=e?`${e.status()}`:t.failure()?`failed: ${t.failure()?.errorText}`:"pending";n.push({reqid:i,method:t.method(),url:t.url(),status:s,matches:o})}}const x=o(n,{pageSize:w,pageIdx:q});s.appendResponseLine(`## Search results for "${i}" (${n.length} matches)`),x.totalPages>1&&(s.appendResponseLine(`Showing ${x.startIndex+1}-${x.endIndex} of ${n.length} (Page ${x.currentPage+1} of ${x.totalPages})`),x.hasNextPage&&s.appendResponseLine(`Next page: pageIdx=${x.currentPage+1}`)),s.appendResponseLine("");for(const e of x.items){const n=t(e.url,v.maxUrlLength);s.appendResponseLine(`**reqid=${e.reqid}** ${e.method} ${n} [${e.status}]`);for(const t of e.matches)s.appendResponseLine(`  ${t.location}: ${t.snippet}`);s.appendResponseLine("")}return void(0===n.length&&s.appendResponseLine("No matches found."))}s.setIncludeNetworkRequests(!0,{pageSize:w,pageIdx:q,resourceTypes:y,includePreservedRequests:b,filter:e=>{if(R&&!R.test(e.url()))return!1;if(d&&e.method()!==d)return!1;const t=e.response(),s=t?.status();if(void 0!==l&&s!==l)return!1;if(void 0!==f&&void 0!==s&&s<f)return!1;if(void 0!==m&&void 0!==s&&s>m)return!1;if(g&&t){if(!(t.headers()["content-type"]??"").toLowerCase().includes(g.toLowerCase()))return!1}return!0}})}});function d(e,t,s="response-body"){const n=function(e){if(!e)return".bin";const t=e.toLowerCase();return t.includes("image/png")?".png":t.includes("image/jpeg")||t.includes("image/jpg")?".jpg":t.includes("image/webp")?".webp":t.includes("application/pdf")?".pdf":t.includes("application/zip")?".zip":t.includes("application/gzip")||t.includes("application/x-gzip")?".gz":(t.includes("application/octet-stream")||t.includes("multipart/form-data"),".bin")}(t);return`${e.replace(/\.[^./\\]+$/,"")}.${s}${n}`}function l(e){return Object.entries(e).map(([e,t])=>`${e}: ${t}`)}function h(e){if(!e)return!0;const t=e.toLowerCase();return!!t.startsWith("text/")||(!!t.includes("application/json")||(!!t.includes("application/javascript")||(!!t.includes("application/xml")||(!!t.includes("application/x-www-form-urlencoded")||(!!t.includes("+json")||!!t.includes("+xml"))))))}export const saveNetworkRequest=i({name:"save_network_request",description:"Save a network request and response to a local file in raw HTTP format.",annotations:{category:r.NETWORK,readOnlyHint:!1},schema:{reqid:e.number().optional().describe("The reqid of the network request. If omitted, uses the currently selected request in the DevTools Network panel."),filePath:e.string().describe("Absolute or relative file path where the HTTP transaction will be saved."),responseBodyFilePath:e.string().optional().describe("Optional file path to save the response body when it is binary. When omitted, it will be derived from filePath."),saveRequestBody:e.boolean().optional().describe("When true, also saves the request body to a separate file. Useful for binary or encoded request bodies."),requestBodyFilePath:e.string().optional().describe("Optional file path to save the request body. When omitted but saveRequestBody is true, it will be derived from filePath.")},handler:async(e,t,n)=>{let o=e.params.reqid;if(!o){const e=await n.getDevToolsData();t.attachDevToolsData(e),o=e?.cdpRequestId?n.resolveCdpRequestId(e.cdpRequestId):void 0}if(!o)return void t.appendResponseLine("Nothing is currently selected in the DevTools Network panel.");const r=n.getNetworkRequestById(o);let i=null;try{i=new URL(r.url())}catch{i=null}const a=r.method(),c=i?`${i.pathname||"/"}${i.search||""}`:r.url(),p={...r.headers()};!i||"host"in p||"Host"in p||(p.host=i.host);const u=await async function(e){try{if(e?.hasPostData?.()){const t=await(e.fetchPostData?.().catch(()=>{}));if("string"==typeof t)return t;const s=e.postData?.();if("string"==typeof s)return s}}catch{}}(r),f=p["content-type"]??p["Content-Type"];let m;const g=[];if(g.push(`${a} ${c} HTTP/1.1`),g.push(...l(p)),g.push(""),u){g.push(u);if(e.params.saveRequestBody||e.params.requestBodyFilePath){const t=e.params.requestBodyFilePath??d(e.params.filePath,f,"request-body"),s=new TextEncoder;await n.saveFile(s.encode(u),t),m=t}}const y=r.response(),b=[];let w;if(y){const t=y.status(),s=y.statusText?.()??"";b.push(`HTTP/1.1 ${t}${s?` ${s}`:""}`);const o=y.headers();b.push(...l(o)),b.push("");const r=o["content-type"];if(h(r))try{const e=await y.text();e.length&&b.push(e)}catch{b.push("<response body not available anymore>")}else try{const t=await y.buffer(),s=e.params.responseBodyFilePath??d(e.params.filePath,r);await n.saveFile(new Uint8Array(t),s),w=s,b.push(`<binary response body saved to: ${s}>`)}catch{b.push("<response body not available anymore>")}}else b.push("HTTP/1.1 000 <pending/no response>"),b.push("");const q=[],v=n.getNetworkRequestInitiator(o);if(v){q.push("=== Initiator ===");for(const e of s(v))q.push(e)}const R=[...g,"",...b,"",...q].join("\r\n");await n.saveFile((new TextEncoder).encode(R),e.params.filePath),t.appendResponseLine(`Saved network request reqid=${o} to ${e.params.filePath}.`),m&&t.appendResponseLine(`Saved request body to ${m}.`),w&&t.appendResponseLine(`Saved binary response body to ${w}.`)}});function f(e){try{const t=new URL(e),s=t.pathname.split("/").filter(e=>e.length>0);if(s.length>0){return s[s.length-1].split("?")[0]}}catch{}return"resource"}function m(e,t){const s=f(t).match(/\.([a-zA-Z0-9]+)$/);if(s)return"."+s[1];if(!e)return"";const n=e.toLowerCase();return n.includes("javascript")||n.includes("ecmascript")?".js":n.includes("text/css")?".css":n.includes("text/html")?".html":n.includes("application/json")||n.includes("+json")?".json":n.includes("application/xml")||n.includes("text/xml")||n.includes("+xml")?".xml":n.includes("image/png")?".png":n.includes("image/jpeg")||n.includes("image/jpg")?".jpg":n.includes("image/gif")?".gif":n.includes("image/webp")?".webp":n.includes("image/svg")?".svg":n.includes("image/ico")||n.includes("image/x-icon")?".ico":n.includes("font/woff2")?".woff2":n.includes("font/woff")?".woff":n.includes("font/ttf")||n.includes("font/truetype")?".ttf":n.includes("font/otf")||n.includes("font/opentype")?".otf":n.includes("application/pdf")?".pdf":n.includes("text/plain")?".txt":""}export const saveStaticResource=i({name:"save_static_resource",description:"Save a static resource from a network request to a local file. File extension is automatically determined.",annotations:{category:r.NETWORK,readOnlyHint:!1},schema:{reqid:e.number().describe("The reqid of the network request containing the resource to save."),filePath:e.string().describe('Path to save the file. Can be a full file path (e.g., "/path/to/file.js") or a directory path (e.g., "/path/to/dir/"). If a directory, filename is derived from the URL.')},handler:async(e,t,s)=>{const{reqid:n,filePath:o}=e.params,r=s.getNetworkRequestById(n);if(!r)return void t.appendResponseLine(`Error: Request with reqid=${n} not found.`);const i=r.response();if(!i)return void t.appendResponseLine(`Error: Request reqid=${n} has no response yet (pending or failed).`);const a=r.url(),c=i.headers()["content-type"];let p=o;if(o.endsWith("/")||o.endsWith("\\")){let e=f(a);if(!e.includes(".")){const t=m(c,a);t&&(e+=t)}p=o+e}else if(!p.match(/\.[a-zA-Z0-9]+$/)){const e=m(c,a);e&&(p+=e)}try{if(h(c)){const e=await i.text();await s.saveFile((new TextEncoder).encode(e),p)}else{const e=await i.buffer();await s.saveFile(new Uint8Array(e),p)}t.appendResponseLine(`Saved static resource from reqid=${n} to ${p}`),t.appendResponseLine(`Source URL: ${a}`),c&&t.appendResponseLine(`Content-Type: ${c}`)}catch(e){t.appendResponseLine(`Error saving resource: ${e instanceof Error?e.message:String(e)}`)}}});