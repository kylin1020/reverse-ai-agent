/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{zod as e}from"../third_party/index.js";import{parseKey as t}from"../utils/keyboard.js";import{ToolCategory as a}from"./categories.js";import{defineTool as o}from"./ToolDefinition.js";export const click=o({name:"click",description:"Clicks on the provided element",annotations:{category:a.INPUT,readOnlyHint:!1},schema:{uid:e.string().describe("The uid of an element on the page from the page content snapshot"),dblClick:e.boolean().optional().describe("Set to true for double clicks. Default is false.")},handler:async(e,t,a)=>{const o=e.params.uid,n=await a.getElementByUid(o);try{await a.waitForEventsAfterAction(async()=>{await n.asLocator().click({count:e.params.dblClick?2:1})}),t.appendResponseLine(e.params.dblClick?"Successfully double clicked on the element":"Successfully clicked on the element"),t.includeSnapshot()}finally{n.dispose()}}});export const hover=o({name:"hover",description:"Hover over the provided element",annotations:{category:a.INPUT,readOnlyHint:!1},schema:{uid:e.string().describe("The uid of an element on the page from the page content snapshot")},handler:async(e,t,a)=>{const o=e.params.uid,n=await a.getElementByUid(o);try{await a.waitForEventsAfterAction(async()=>{await n.asLocator().hover()}),t.appendResponseLine("Successfully hovered over the element"),t.includeSnapshot()}finally{n.dispose()}}});async function n(e,t,a){const o=await a.getElementByUid(e);try{const n=a.getAXNodeByUid(e);n&&"combobox"===n.role?await async function(e,t,a){let o=!1;for(const n of t.children)if("option"===n.role&&n.name===a&&n.value){o=!0;const t=await n.elementHandle();if(t)try{const a=await t.getProperty("value");try{const t=await a.jsonValue();t&&await e.asLocator().fill(t.toString())}finally{a.dispose()}break}finally{t.dispose()}}if(!o)throw new Error(`Could not find option with text "${a}"`)}(o,n,t):await o.asLocator().fill(t)}finally{o.dispose()}}export const fill=o({name:"fill",description:"Type text into a input, text area or select an option from a <select> element.",annotations:{category:a.INPUT,readOnlyHint:!1},schema:{uid:e.string().describe("The uid of an element on the page from the page content snapshot"),value:e.string().describe("The value to fill in")},handler:async(e,t,a)=>{await a.waitForEventsAfterAction(async()=>{await n(e.params.uid,e.params.value,a)}),t.appendResponseLine("Successfully filled out the element"),t.includeSnapshot()}});export const drag=o({name:"drag",description:"Drag an element onto another element",annotations:{category:a.INPUT,readOnlyHint:!1},schema:{from_uid:e.string().describe("The uid of the element to drag"),to_uid:e.string().describe("The uid of the element to drop into")},handler:async(e,t,a)=>{const o=await a.getElementByUid(e.params.from_uid),n=await a.getElementByUid(e.params.to_uid);try{await a.waitForEventsAfterAction(async()=>{await o.drag(n),await new Promise(e=>setTimeout(e,50)),await n.drop(o)}),t.appendResponseLine("Successfully dragged an element"),t.includeSnapshot()}finally{o.dispose(),n.dispose()}}});export const fillForm=o({name:"fill_form",description:"Fill out multiple form elements at once",annotations:{category:a.INPUT,readOnlyHint:!1},schema:{elements:e.array(e.object({uid:e.string().describe("The uid of the element to fill out"),value:e.string().describe("Value for the element")})).describe("Elements from snapshot to fill out.")},handler:async(e,t,a)=>{for(const t of e.params.elements)await a.waitForEventsAfterAction(async()=>{await n(t.uid,t.value,a)});t.appendResponseLine("Successfully filled out the form"),t.includeSnapshot()}});export const uploadFile=o({name:"upload_file",description:"Upload a file through a provided element.",annotations:{category:a.INPUT,readOnlyHint:!1},schema:{uid:e.string().describe("The uid of the file input element or an element that will open file chooser on the page from the page content snapshot"),filePath:e.string().describe("The local path of the file to upload")},handler:async(e,t,a)=>{const{uid:o,filePath:n}=e.params,i=await a.getElementByUid(o);try{try{await i.uploadFile(n)}catch{try{const e=a.getSelectedPage(),[t]=await Promise.all([e.waitForFileChooser({timeout:3e3}),i.asLocator().click()]);await t.accept([n])}catch{throw new Error("Failed to upload file. The element could not accept the file directly, and clicking it did not trigger a file chooser.")}}t.includeSnapshot(),t.appendResponseLine(`File uploaded from ${n}.`)}finally{i.dispose()}}});export const pressKey=o({name:"press_key",description:"Press a key or key combination for keyboard shortcuts and navigation keys.",annotations:{category:a.INPUT,readOnlyHint:!1},schema:{key:e.string().describe('A key or a combination (e.g., "Enter", "Control+A", "Control++", "Control+Shift+R"). Modifiers: Control, Shift, Alt, Meta')},handler:async(e,a,o)=>{const n=o.getSelectedPage(),i=t(e.params.key),[s,...r]=i;await o.waitForEventsAfterAction(async()=>{for(const e of r)await n.keyboard.down(e);await n.keyboard.press(s);for(const e of r.toReversed())await n.keyboard.up(e)}),a.appendResponseLine(`Successfully pressed key: ${e.params.key}`),a.includeSnapshot()}});