/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{zod as e}from"../third_party/index.js";import{parseKey as t}from"../utils/keyboard.js";import{ToolCategory as o}from"./categories.js";import{defineTool as a}from"./ToolDefinition.js";export const click=a({name:"click",description:"Clicks on the provided element",annotations:{category:o.INPUT,readOnlyHint:!1},schema:{uid:e.string().describe("The uid of an element on the page from the page content snapshot"),dblClick:e.boolean().optional().describe("Set to true for double clicks. Default is false.")},handler:async(e,t,o)=>{const a=e.params.uid,n=await o.getElementByUid(a);try{await o.waitForEventsAfterAction(async()=>{await n.asLocator().click({count:e.params.dblClick?2:1})}),t.appendResponseLine(e.params.dblClick?"Successfully double clicked on the element":"Successfully clicked on the element"),t.includeSnapshot()}finally{n.dispose()}}});export const hover=a({name:"hover",description:"Hover over the provided element",annotations:{category:o.INPUT,readOnlyHint:!1},schema:{uid:e.string().describe("The uid of an element on the page from the page content snapshot")},handler:async(e,t,o)=>{const a=e.params.uid,n=await o.getElementByUid(a);try{await o.waitForEventsAfterAction(async()=>{await n.asLocator().hover()}),t.appendResponseLine("Successfully hovered over the element"),t.includeSnapshot()}finally{n.dispose()}}});async function n(e,t,o){const a=await o.getElementByUid(e);try{const n=o.getAXNodeByUid(e);n&&"combobox"===n.role?await async function(e,t,o){let a=!1;for(const n of t.children)if("option"===n.role&&n.name===o&&n.value){a=!0;const t=await n.elementHandle();if(t)try{const o=await t.getProperty("value");try{const t=await o.jsonValue();t&&await e.asLocator().fill(t.toString())}finally{o.dispose()}break}finally{t.dispose()}}if(!a)throw new Error(`Could not find option with text "${o}"`)}(a,n,t):await a.asLocator().fill(t)}finally{a.dispose()}}export const fill=a({name:"fill",description:"Type text into a input, text area or select an option from a <select> element.",annotations:{category:o.INPUT,readOnlyHint:!1},schema:{uid:e.string().describe("The uid of an element on the page from the page content snapshot"),value:e.string().describe("The value to fill in")},handler:async(e,t,o)=>{await o.waitForEventsAfterAction(async()=>{await n(e.params.uid,e.params.value,o)}),t.appendResponseLine("Successfully filled out the element"),t.includeSnapshot()}});export const drag=a({name:"drag",description:"Drag an element onto another element",annotations:{category:o.INPUT,readOnlyHint:!1},schema:{from_uid:e.string().describe("The uid of the element to drag"),to_uid:e.string().describe("The uid of the element to drop into")},handler:async(e,t,o)=>{const a=await o.getElementByUid(e.params.from_uid),n=await o.getElementByUid(e.params.to_uid);try{await o.waitForEventsAfterAction(async()=>{await a.drag(n),await new Promise(e=>setTimeout(e,50)),await n.drop(a)}),t.appendResponseLine("Successfully dragged an element"),t.includeSnapshot()}finally{a.dispose(),n.dispose()}}});export const fillForm=a({name:"fill_form",description:"Fill out multiple form elements at once",annotations:{category:o.INPUT,readOnlyHint:!1},schema:{elements:e.array(e.object({uid:e.string().describe("The uid of the element to fill out"),value:e.string().describe("Value for the element")})).describe("Elements from snapshot to fill out.")},handler:async(e,t,o)=>{for(const t of e.params.elements)await o.waitForEventsAfterAction(async()=>{await n(t.uid,t.value,o)});t.appendResponseLine("Successfully filled out the form"),t.includeSnapshot()}});export const uploadFile=a({name:"upload_file",description:"Upload a file through a provided element.",annotations:{category:o.INPUT,readOnlyHint:!1},schema:{uid:e.string().describe("The uid of the file input element or an element that will open file chooser on the page from the page content snapshot"),filePath:e.string().describe("The local path of the file to upload")},handler:async(e,t,o)=>{const{uid:a,filePath:n}=e.params,i=await o.getElementByUid(a);try{try{await i.uploadFile(n)}catch{try{const e=o.getSelectedPage(),[t]=await Promise.all([e.waitForFileChooser({timeout:3e3}),i.asLocator().click()]);await t.accept([n])}catch{throw new Error("Failed to upload file. The element could not accept the file directly, and clicking it did not trigger a file chooser.")}}t.includeSnapshot(),t.appendResponseLine(`File uploaded from ${n}.`)}finally{i.dispose()}}});export const pressKey=a({name:"press_key",description:"Press a key or key combination. Use this when other input methods like fill() cannot be used (e.g., keyboard shortcuts, navigation keys, or special key combinations).",annotations:{category:o.INPUT,readOnlyHint:!1},schema:{key:e.string().describe('A key or a combination (e.g., "Enter", "Control+A", "Control++", "Control+Shift+R"). Modifiers: Control, Shift, Alt, Meta')},handler:async(e,o,a)=>{const n=a.getSelectedPage(),i=t(e.params.key),[s,...r]=i;await a.waitForEventsAfterAction(async()=>{for(const e of r)await n.keyboard.down(e);await n.keyboard.press(s);for(const e of r.toReversed())await n.keyboard.up(e)}),o.appendResponseLine(`Successfully pressed key: ${e.params.key}`),o.includeSnapshot()}});