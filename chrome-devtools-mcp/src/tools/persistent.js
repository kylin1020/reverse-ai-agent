/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{zod as e}from"../third_party/index.js";import*as s from"../utils/persistentScripts.js";import{ToolCategory as n}from"./categories.js";import{defineTool as t}from"./ToolDefinition.js";export const addPersistentScript=t({name:"add_persistent_script",description:"Register a JavaScript script to execute automatically on every page load.\n\nThis is useful for persistent hooks (like XHR interceptors, fetch interceptors, etc.) that need to survive page refreshes.\nThe script will execute before any other scripts on the page, making it ideal for:\n- Intercepting network requests (XMLHttpRequest, fetch)\n- Modifying global objects or prototypes\n- Setting up debugging hooks\n\nReturns a unique identifier that can be used to remove the script later.",annotations:{category:n.DEBUGGING,readOnlyHint:!1},schema:{function:e.string().describe("A JavaScript function or code to execute on every page load.\nExample: `() => {\n  const originalFetch = window.fetch;\n  window.fetch = function(...args) {\n    console.log('Fetch intercepted:', args[0]);\n    return originalFetch.apply(this, args);\n  };\n}`"),name:e.string().optional().describe("An optional name for the script to help identify it when listing scripts.")},handler:async(e,n,t)=>{const{function:i,name:p}=e.params,r=t.getSelectedPage();try{const e=await s.addScript(r,i,p);n.appendResponseLine("âœ… Persistent script registered successfully."),n.appendResponseLine(""),n.appendResponseLine(`**Identifier:** \`${e.identifier}\``),p&&n.appendResponseLine(`**Name:** ${p}`),n.appendResponseLine(""),n.appendResponseLine("The script will execute automatically before any other scripts on subsequent page loads."),n.appendResponseLine("Use `remove_persistent_script` with the identifier to remove it."),n.appendResponseLine("Use `list_persistent_scripts` to see all registered scripts.")}catch(e){const s=e instanceof Error?e.message:String(e);n.appendResponseLine("âŒ Failed to register persistent script:"),n.appendResponseLine("```"),n.appendResponseLine(s),n.appendResponseLine("```")}}});export const removePersistentScript=t({name:"remove_persistent_script",description:"Remove a previously registered persistent script by its identifier.\n\nAfter removal, the script will no longer execute on subsequent page loads.\nUse `list_persistent_scripts` to see all registered scripts and their identifiers.",annotations:{category:n.DEBUGGING,readOnlyHint:!1},schema:{identifier:e.string().describe("The unique identifier of the script to remove. This is returned when adding a script with `add_persistent_script`.")},handler:async(e,n,t)=>{const{identifier:i}=e.params,p=t.getSelectedPage();try{await s.removeScript(p,i)?(n.appendResponseLine("âœ… Persistent script removed successfully."),n.appendResponseLine(""),n.appendResponseLine(`**Identifier:** \`${i}\``),n.appendResponseLine(""),n.appendResponseLine("The script will no longer execute on subsequent page loads.")):(n.appendResponseLine("âŒ Script not found."),n.appendResponseLine(""),n.appendResponseLine(`No persistent script with identifier \`${i}\` was found.`),n.appendResponseLine(""),n.appendResponseLine("Use `list_persistent_scripts` to see all registered scripts and their identifiers."))}catch(e){const s=e instanceof Error?e.message:String(e);n.appendResponseLine("âŒ Failed to remove persistent script:"),n.appendResponseLine("```"),n.appendResponseLine(s),n.appendResponseLine("```")}}});export const listPersistentScripts=t({name:"list_persistent_scripts",description:"List all registered persistent scripts for the current page.\n\nShows each script's identifier, name (if provided), and a preview of the source code.\nUse this to see what hooks are currently active and to get identifiers for removal.",annotations:{category:n.DEBUGGING,readOnlyHint:!0},schema:{previewLength:e.number().int().positive().optional().describe('Maximum length for script source preview. Defaults to 100 characters. Longer scripts will be truncated with "...".')},handler:async(e,n,t)=>{const{previewLength:i=100}=e.params,p=t.getSelectedPage(),r=s.listScripts(p);if(0===r.length)return n.appendResponseLine("ğŸ“‹ No persistent scripts registered."),n.appendResponseLine(""),void n.appendResponseLine("Use `add_persistent_script` to register a script that executes on every page load.");n.appendResponseLine(`ğŸ“‹ **${r.length} persistent script${1===r.length?"":"s"} registered:**`),n.appendResponseLine("");for(const e of r)n.appendResponseLine("---"),n.appendResponseLine(`**Identifier:** \`${e.identifier}\``),e.name&&n.appendResponseLine(`**Name:** ${e.name}`),n.appendResponseLine(`**Created:** ${new Date(e.createdAt).toISOString()}`),n.appendResponseLine("**Source preview:**"),n.appendResponseLine("```javascript"),n.appendResponseLine(s.truncateSource(e.source,i)),n.appendResponseLine("```"),n.appendResponseLine("");n.appendResponseLine("---"),n.appendResponseLine("Use `remove_persistent_script` with an identifier to remove a specific script."),n.appendResponseLine("Use `clear_persistent_scripts` to remove all scripts at once.")}});export const clearPersistentScripts=t({name:"clear_persistent_scripts",description:"Remove all registered persistent scripts for the current page at once.\n\nThis is useful for quickly resetting to a clean state without having to remove scripts individually.\nReturns the count of scripts that were removed.",annotations:{category:n.DEBUGGING,readOnlyHint:!1},schema:{},handler:async(e,n,t)=>{const i=t.getSelectedPage();try{const e=await s.clearScripts(i);0===e?(n.appendResponseLine("ğŸ“‹ No persistent scripts to clear."),n.appendResponseLine(""),n.appendResponseLine("Use `add_persistent_script` to register a script that executes on every page load.")):(n.appendResponseLine("âœ… Cleared all persistent scripts."),n.appendResponseLine(""),n.appendResponseLine(`**Scripts removed:** ${e}`),n.appendResponseLine(""),n.appendResponseLine("No scripts will execute on subsequent page loads."),n.appendResponseLine("Use `add_persistent_script` to register new scripts."))}catch(e){const s=e instanceof Error?e.message:String(e);n.appendResponseLine("âŒ Failed to clear persistent scripts:"),n.appendResponseLine("```"),n.appendResponseLine(s),n.appendResponseLine("```")}}});