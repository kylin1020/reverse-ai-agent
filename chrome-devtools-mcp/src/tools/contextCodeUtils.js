/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
export function isMinified(e){if(!e||e.length<100)return!1;const t=e.split("\n").filter(e=>e.trim().length>0);if(0===t.length)return!1;if(t.reduce((e,t)=>e+t.length,0)/t.length>500)return!0;return e.length/t.length>500&&t.length<=5}import*as e from"acorn";export function formatMinifiedCode(t){const a=[];let r;try{r=e.parse(t,{ecmaVersion:"latest",sourceType:"module",allowHashBang:!0,allowAwaitOutsideFunction:!0,allowImportExportEverywhere:!0,allowReserved:!0,locations:!0})}catch(e){return{formattedCode:t,mappings:[],success:!1,error:`AST parsing failed: ${e.message||String(e)}`}}let n="",o=1,s=0,i=0;function l(e){const r=function(e){let a=1,r=-1;for(let n=0;n<e&&n<t.length;n++)"\n"===t[n]&&(a++,r=n);return{line:a,column:e-r-1}}(e);a.push({original:r,formatted:{line:o,column:s}})}function c(e){n+=e;for(const t of e)"\n"===t?(o++,s=0):s++}function p(){c("\n"),c("  ".repeat(i))}function u(e){if(e)switch(l(e.start),e.type){case"Program":f(e.body);break;case"BlockStatement":c("{"),i++,Array.isArray(e.body)&&e.body.length>0&&(p(),f(e.body)),i--,p(),c("}");break;case"ExpressionStatement":u(e.expression),c(";");break;case"VariableDeclaration":if(c(e.kind||"var"),c(" "),e.declarations)for(let t=0;t<e.declarations.length;t++){t>0&&c(", ");const a=e.declarations[t];l(a.start),u(a.id),a.init&&(c(" = "),u(a.init))}c(";");break;case"FunctionDeclaration":case"FunctionExpression":e.async&&c("async "),c("function"),e.generator&&c("*"),e.id&&(c(" "),u(e.id)),c("("),m(e.params),c(") "),u(e.body);break;case"ArrowFunctionExpression":e.async&&c("async "),1===e.params?.length&&"Identifier"===e.params[0].type?u(e.params[0]):(c("("),m(e.params),c(")")),c(" => "),u(e.body);break;case"ReturnStatement":c("return"),e.argument&&(c(" "),u(e.argument)),c(";");break;case"IfStatement":c("if ("),u(e.test),c(") "),u(e.consequent),e.alternate&&(c(" else "),u(e.alternate));break;case"ForStatement":c("for ("),u(e.init),c(" "),u(e.test),c("; "),u(e.update),c(") "),u(e.body);break;case"WhileStatement":c("while ("),u(e.test),c(") "),u(e.body);break;case"DoWhileStatement":c("do "),u(e.body),c(" while ("),u(e.test),c(");");break;case"SwitchStatement":if(c("switch ("),u(e.discriminant),c(") {"),i++,e.cases)for(const t of e.cases)p(),u(t);i--,p(),c("}");break;case"SwitchCase":if(e.test?(c("case "),u(e.test),c(":")):c("default:"),i++,e.consequent&&Array.isArray(e.consequent))for(const t of e.consequent)p(),u(t);i--;break;case"TryStatement":c("try "),u(e.block),e.handler&&(c(" catch"),e.handler.param&&(c(" ("),u(e.handler.param),c(")")),c(" "),u(e.handler.body)),e.finalizer&&(c(" finally "),u(e.finalizer));break;case"ThrowStatement":c("throw "),u(e.argument),c(";");break;case"BreakStatement":c("break"),e.label&&(c(" "),u(e.label)),c(";");break;case"ContinueStatement":c("continue"),e.label&&(c(" "),u(e.label)),c(";");break;case"CallExpression":u(e.callee),c("("),d(e.arguments),c(")");break;case"NewExpression":c("new "),u(e.callee),c("("),d(e.arguments),c(")");break;case"MemberExpression":u(e.object),e.computed?(c("["),u(e.property),c("]")):(c("."),u(e.property));break;case"BinaryExpression":case"LogicalExpression":case"AssignmentExpression":u(e.left),c(` ${e.operator} `),u(e.right);break;case"UpdateExpression":e.prefix?(c(e.operator||""),u(e.argument)):(u(e.argument),c(e.operator||""));break;case"UnaryExpression":c(e.operator||""),e.operator&&e.operator.length>1&&c(" "),u(e.argument);break;case"ConditionalExpression":u(e.test),c(" ? "),u(e.consequent),c(" : "),u(e.alternate);break;case"ObjectExpression":if(e.properties&&0!==e.properties.length){c("{"),i++;for(let t=0;t<e.properties.length;t++)p(),u(e.properties[t]),t<e.properties.length-1&&c(",");i--,p(),c("}")}else c("{}");break;case"Property":e.method?(e.value?.async&&c("async "),e.value?.generator&&c("*"),u(e.key),c("("),m(e.value?.params),c(") "),u(e.value?.body)):e.shorthand?u(e.key):(e.computed?(c("["),u(e.key),c("]")):u(e.key),c(": "),u(e.value));break;case"ArrayExpression":if(c("["),e.elements)for(let t=0;t<e.elements.length;t++)t>0&&c(", "),e.elements[t]&&u(e.elements[t]);c("]");break;case"Identifier":c(e.name||"");break;case"Literal":c(e.raw||String(e.value));break;case"TemplateLiteral":if(c("`"),e.quasis&&e.expressions)for(let t=0;t<e.quasis.length;t++)c(e.quasis[t].value?.raw||""),t<e.expressions.length&&(c("${"),u(e.expressions[t]),c("}"));c("`");break;case"ThisExpression":c("this");break;case"SequenceExpression":if(e.expressions)for(let t=0;t<e.expressions.length;t++)t>0&&c(", "),u(e.expressions[t]);break;case"ClassDeclaration":case"ClassExpression":c("class"),e.id&&(c(" "),u(e.id)),e.superClass&&(c(" extends "),u(e.superClass)),c(" "),u(e.body);break;case"ClassBody":if(c("{"),i++,e.body&&Array.isArray(e.body))for(const t of e.body)p(),u(t);i--,p(),c("}");break;case"MethodDefinition":e.static&&c("static "),"get"===e.kind&&c("get "),"set"===e.kind&&c("set "),e.value?.async&&c("async "),e.value?.generator&&c("*"),e.computed?(c("["),u(e.key),c("]")):u(e.key),c("("),m(e.value?.params),c(") "),u(e.value?.body);break;case"ImportDeclaration":if(c("import "),e.specifiers&&e.specifiers.length>0){const t=e.specifiers.find(e=>"ImportDefaultSpecifier"===e.type),a=e.specifiers.find(e=>"ImportNamespaceSpecifier"===e.type),r=e.specifiers.filter(e=>"ImportSpecifier"===e.type);if(t&&(u(t.local),(a||r.length>0)&&c(", ")),a&&(c("* as "),u(a.local)),r.length>0){c("{");for(let e=0;e<r.length;e++){e>0&&c(", ");const t=r[e];u(t.imported),t.local?.name!==t.imported?.name&&(c(" as "),u(t.local))}c("}")}c(" from ")}u(e.source),c(";");break;case"ExportNamedDeclaration":if(c("export "),e.declaration)u(e.declaration);else if(e.specifiers&&e.specifiers.length>0){c("{");for(let t=0;t<e.specifiers.length;t++){t>0&&c(", ");const a=e.specifiers[t];u(a.local),a.exported?.name!==a.local?.name&&(c(" as "),u(a.exported))}c("}"),e.source&&(c(" from "),u(e.source)),c(";")}break;case"ExportDefaultDeclaration":c("export default "),u(e.declaration),"FunctionDeclaration"!==e.declaration?.type&&"ClassDeclaration"!==e.declaration?.type&&c(";");break;case"ExportAllDeclaration":c("export * from "),u(e.source),c(";");break;case"AwaitExpression":c("await "),u(e.argument);break;case"YieldExpression":c("yield"),e.delegate&&c("*"),e.argument&&(c(" "),u(e.argument));break;case"SpreadElement":case"RestElement":c("..."),u(e.argument);break;case"ForInStatement":c("for ("),u(e.left),c(" in "),u(e.right),c(") "),u(e.body);break;case"ForOfStatement":c("for "),e.await&&c("await "),c("("),u(e.left),c(" of "),u(e.right),c(") "),u(e.body);break;case"EmptyStatement":c(";");break;case"DebuggerStatement":c("debugger;");break;case"LabeledStatement":u(e.label),c(": "),u(e.body);break;case"WithStatement":c("with ("),u(e.object),c(") "),u(e.body);break;default:c(t.slice(e.start,e.end))}}function f(e){for(let t=0;t<e.length;t++)t>0&&p(),u(e[t])}function m(e){if(e)for(let t=0;t<e.length;t++)t>0&&c(", "),u(e[t])}function d(e){if(e)for(let t=0;t<e.length;t++)t>0&&c(", "),u(e[t])}return u(r),{formattedCode:n,mappings:a,success:!0}}export function mapOriginalToFormatted(e,t,a){if(0===e.length)return null;let r=0,n=e.length-1,o=null;for(;r<=n;){const s=Math.floor((r+n)/2),i=e[s],l=i.original.line,c=i.original.column;if(l===t&&c===a)return i.formatted;l<t||l===t&&c<a?(o=i,r=s+1):n=s-1}return o?o.formatted:e[0].formatted}export function mapFormattedToOriginal(e,t,a){if(0===e.length)return null;let r=0,n=e.length-1,o=null;for(;r<=n;){const s=Math.floor((r+n)/2),i=e[s],l=i.formatted.line,c=i.formatted.column;if(l===t&&c===a)return i.original;l<t||l===t&&c<a?(o=i,r=s+1):n=s-1}return o?o.original:e[0].original}export function extractContextCode(e,t){const{lineNumber:a,columnNumber:r,contextLines:n,formatMinified:o}=t,s=[];let i=!1;if(!e||0===e.length)return{lines:[],wasFormatted:!1,warnings:["Script has no source content"]};let l=e,c=[],p=a,u=r;if(o&&isMinified(e)){const t=formatMinifiedCode(e);if(t.success){l=t.formattedCode,c=t.mappings,i=!0;const e=mapOriginalToFormatted(c,a,r);e&&(p=e.line,u=e.column)}else s.push(t.error||"AST formatting failed, showing raw source")}const f=l.split("\n"),m=f.length,d=Math.max(0,p-1-n),b=Math.min(m-1,p-1+n),g=[];for(let e=d;e<=b;e++){const t=e+1,a=t===p;let r=t;if(i&&c.length>0){const e=mapFormattedToOriginal(c,t,0);e&&(r=e.line)}g.push({displayLineNumber:t,originalLineNumber:r,content:f[e],isCurrentLine:a,annotations:[]})}return{lines:g,wasFormatted:i,warnings:s}}export function formatContextCodeOutput(e,t,a,r,n){if(0===e.lines.length)return e.warnings.length>0?`âš ï¸ ${e.warnings.join(", ")}`:"No context code available";const o=[],s=n?` (${n})`:"";o.push(`ðŸ“ Code Context${s}:`),r&&o.push(`   Script: ${r}`),o.push(`   Original position: line ${t}, column ${a}`),e.wasFormatted&&o.push("   â„¹ï¸ Code was formatted from minified source");for(const t of e.warnings)o.push(`   âš ï¸ ${t}`);o.push(""),o.push("   "+"â”€".repeat(50));const i=Math.max(...e.lines.map(e=>e.displayLineNumber)),l=String(i).length;for(const t of e.lines){const e=t.isCurrentLine?">>>":"   ",a=String(t.displayLineNumber).padStart(l," "),r=`[L:${t.originalLineNumber},C:0]`;let n=`${e}${a}  â”‚ ${t.content}`;const s=Math.max(0,60-n.length);n+=" ".repeat(s)+r,t.isCurrentLine&&(n+=" â—„ current"),o.push(n)}o.push("   "+"â”€".repeat(50));const c=e.lines.find(e=>e.isCurrentLine);return c&&(o.push(""),o.push("   ðŸ’¡ Current position:"),o.push(`      â€¢ [L:${c.originalLineNumber},C:${a}]`)),o.join("\n")}export function generatePositionAnnotations(t,a,r){const n=[];let o;try{o=e.parse(t,{ecmaVersion:"latest",sourceType:"module",allowHashBang:!0,allowAwaitOutsideFunction:!0,allowImportExportEverywhere:!0,allowReserved:!0,locations:!0})}catch{return n}function s(e,o,s){const i=function(e){let a=1,r=-1;for(let n=0;n<e&&n<t.length;n++)"\n"===t[n]&&(a++,r=n);return{line:a,column:e-r-1}}(e.start);i.line>=a&&i.line<=r&&n.push({originalColumn:i.column,formattedColumn:i.column,type:o,name:s})}function i(e){if(e)switch(e.type){case"FunctionDeclaration":case"FunctionExpression":s(e,"function",e.id?.name||"<anonymous>"),l(e.body);break;case"ArrowFunctionExpression":s(e,"function","<arrow>"),l(e.body);break;case"CallExpression":"Identifier"===e.callee?.type&&e.callee.name?s(e,"call",e.callee.name):"MemberExpression"===e.callee?.type&&e.callee.property?.name&&s(e,"call",e.callee.property.name),i(e.callee);for(const t of e.arguments||[])i(t);break;case"VariableDeclaration":s(e,"statement");for(const t of e.declarations||[])t.init&&i(t.init);break;case"ReturnStatement":s(e,"statement"),i(e.argument);break;case"IfStatement":s(e,"statement"),i(e.test),i(e.consequent),i(e.alternate);break;case"ForStatement":case"WhileStatement":case"DoWhileStatement":s(e,"statement"),i(e.init),i(e.test),i(e.update),l(e.body);break;case"ExpressionStatement":i(e.expression);break;case"BlockStatement":case"Program":l(e.body);break;default:if(e.body&&l(e.body),e.expression&&i(e.expression),e.left&&i(e.left),e.right&&i(e.right),e.argument&&i(e.argument),e.consequent&&l(e.consequent),e.alternate&&i(e.alternate),e.object&&i(e.object),e.property&&i(e.property),e.elements)for(const t of e.elements)t&&i(t);if(e.properties)for(const t of e.properties)i(t)}}function l(e){if(e)if(Array.isArray(e))for(const t of e)i(t);else i(e)}return i(o),n}export function formatPositionAnnotation(e,t){return`[L:${e},C:${t}]`}