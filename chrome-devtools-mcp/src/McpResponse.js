/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{mapIssueToMessageObject as e}from"./DevtoolsUtils.js";import{formatConsoleEventShort as s,formatConsoleEventVerbose as t}from"./formatters/consoleFormatter.js";import{getFormattedHeaderValue as a,getFormattedResponseBody as o,getFormattedRequestBody as n,getShortDescriptionForRequest as i,getStatusFromRequest as r}from"./formatters/networkFormatter.js";import{formatSnapshotNode as h,formatSnapshotWithOptions as p}from"./formatters/snapshotFormatter.js";import{DevTools as u}from"./third_party/index.js";import{handleDialog as g}from"./tools/pages.js";import{formatInitiator as l}from"./utils/cdp.js";import{paginate as c}from"./utils/pagination.js";export class McpResponse{#e=!1;#s;#t;#a;#o=[];#n=[];#i;#r;#h;attachDevToolsData(e){this.#h=e}setIncludePages(e){this.#e=e}includeSnapshot(e){this.#s=e??{verbose:!1}}setIncludeNetworkRequests(e,s){this.#i=e?{include:e,pagination:s?.pageSize||s?.pageIdx?{pageSize:s.pageSize,pageIdx:s.pageIdx}:void 0,resourceTypes:s?.resourceTypes,includePreservedRequests:s?.includePreservedRequests,networkRequestIdInDevToolsUI:s?.networkRequestIdInDevToolsUI,filter:s?.filter}:void 0}setIncludeConsoleData(e,s){this.#r=e?{include:e,pagination:s?.pageSize||s?.pageIdx?{pageSize:s.pageSize,pageIdx:s.pageIdx}:void 0,types:s?.types,includePreservedMessages:s?.includePreservedMessages}:void 0}attachNetworkRequest(e){this.#t=e}attachConsoleMessage(e){this.#a=e}get includePages(){return this.#e}get includeNetworkRequests(){return this.#i?.include??!1}get includeConsoleData(){return this.#r?.include??!1}get attachedNetworkRequestId(){return this.#t}get networkRequestsPageIdx(){return this.#i?.pagination?.pageIdx}get consoleMessagesPageIdx(){return this.#r?.pagination?.pageIdx}get consoleMessagesTypes(){return this.#r?.types}appendResponseLine(e){this.#o.push(e)}attachImage(e){this.#n.push(e)}get responseLines(){return this.#o}get images(){return this.#n}get snapshotParams(){return this.#s}async handle(s,t){let a;if(this.#e&&await t.createPagesSnapshot(),this.#s){await t.createTextSnapshot(this.#s.verbose,this.#h);const e=t.getTextSnapshot();if(e){if(this.#s.search||void 0!==this.#s.pageSize||void 0!==this.#s.pageIdx){const s=p(e.root,e,{search:this.#s.search,pagination:void 0!==this.#s.pageSize||void 0!==this.#s.pageIdx?{pageSize:this.#s.pageSize,pageIdx:this.#s.pageIdx}:void 0}),o=[];if(this.#s.search&&o.push(`Search: "${this.#s.search}" - Found ${s.matchedElements} of ${s.totalElements} elements`),s.totalPages>1&&(o.push(`Page ${s.currentPage+1} of ${s.totalPages}`),s.hasNextPage&&o.push(`Next page: pageIdx=${s.currentPage+1}`),s.hasPreviousPage&&o.push("Previous page: pageIdx="+(s.currentPage-1))),this.#s.filePath){const e=o.length?o.join("\n")+"\n\n"+s.content:s.content;await t.saveFile((new TextEncoder).encode(e),this.#s.filePath),a=`Saved snapshot to ${this.#s.filePath}.`,o.length&&(a+="\n"+o.join("\n"))}else a=o.length?o.join("\n")+"\n\n"+s.content:s.content}else this.#s.filePath?(await t.saveFile((new TextEncoder).encode(h(e.root,e)),this.#s.filePath),a=`Saved snapshot to ${this.#s.filePath}.`):a=h(e.root,e)}}const i={};if(this.#t){const e=t.getNetworkRequestById(this.#t);i.requestBody=await n(e);const s=e.response();s&&(i.responseBody=await o(s))}let r,g;if(this.#a){const s=t.getConsoleMessageById(this.#a),a=this.#a;if("args"in s){const e=s;r={consoleMessageStableId:a,type:e.type(),message:e.text(),args:await Promise.all(e.args().map(async e=>{const s=await e.jsonValue().catch(()=>{});return"object"==typeof s?JSON.stringify(s):String(s)}))}}else if(s instanceof u.AggregatedIssue){const t=e(s);if(!t)throw new Error("Can't provide detals for the msgid "+a);r={consoleMessageStableId:a,...t}}else r={consoleMessageStableId:a,type:"error",message:s.message,args:[]}}if(this.#r?.include){let s=t.getConsoleData(this.#r.includePreservedMessages);if(this.#r.types?.length){const e=new Set(this.#r.types);s=s.filter(s=>"type"in s?e.has(s.type()):s instanceof u.AggregatedIssue?e.has("issue"):e.has("error"))}g=(await Promise.all(s.map(async s=>{const a=t.getConsoleMessageStableId(s);if("args"in s){const e=s;return{consoleMessageStableId:a,type:e.type(),message:e.text(),args:await Promise.all(e.args().map(async e=>{const s=await e.jsonValue().catch(()=>{});return"object"==typeof s?JSON.stringify(s):String(s)}))}}if(s instanceof u.AggregatedIssue){const t=e(s);return t?{consoleMessageStableId:a,...t}:null}return{consoleMessageStableId:a,type:"error",message:s.message,args:[]}}))).filter(e=>null!==e)}return this.format(s,t,{bodies:i,consoleData:r,consoleListData:g,formattedSnapshot:a})}format(e,t,a){const o=[`# ${e} response`];for(const e of this.#o)o.push(e);const n=t.getNetworkConditions();n&&(o.push("## Network emulation"),o.push(`Emulating: ${n}`),o.push(`Default navigation timeout set to ${t.getNavigationTimeout()} ms`));const r=t.getCpuThrottlingRate();r>1&&(o.push("## CPU emulation"),o.push(`Emulating: ${r}x slowdown`));const h=t.getDialog();if(h){const e="prompt"===h.type()?` (default value: "${h.defaultValue()}")`:"";o.push(`# Open dialog\n${h.type()}: ${h.message()}${e}.\nCall ${g.name} to handle it before continuing.`)}if(this.#e){const e=["## Pages"];let s=0;for(const a of t.getPages())e.push(`${s}: ${a.url()}${t.isPageSelected(a)?" [selected]":""}`),s++;o.push(...e)}if(a.formattedSnapshot&&(o.push("## Latest page snapshot"),o.push(a.formattedSnapshot)),o.push(...this.#p(t,a.bodies)),o.push(...this.#u(t,a.consoleData)),this.#i?.include){let e=t.getNetworkRequests(this.#i?.includePreservedRequests);if(this.#i.resourceTypes?.length){const s=new Set(this.#i.resourceTypes);e=e.filter(e=>{const t=e.resourceType();return s.has(t)})}if(this.#i.filter&&(e=e.filter(this.#i.filter)),o.push("## Network requests"),e.length){const s=this.#g(e,this.#i.pagination);o.push(...s.info);for(const e of s.items)o.push(i(e,t.getNetworkRequestStableId(e),t.getNetworkRequestStableId(e)===this.#i?.networkRequestIdInDevToolsUI))}else o.push("No requests found.")}if(this.#r?.include){const e=a.consoleListData??[];if(o.push("## Console messages"),e.length){const t=this.#g(e,this.#r.pagination);o.push(...t.info),o.push(...t.items.map(e=>s(e)))}else o.push("<no console messages found>")}return[{type:"text",text:o.join("\n")},...this.#n.map(e=>({type:"image",...e}))]}#g(e,s){const t=[],a=c(e,s);a.invalidPage&&t.push("Invalid page number provided. Showing first page.");const{startIndex:o,endIndex:n,currentPage:i,totalPages:r}=a;return t.push(`Showing ${o+1}-${n} of ${e.length} (Page ${i+1} of ${r}).`),s&&(a.hasNextPage&&t.push(`Next page: ${i+1}`),a.hasPreviousPage&&t.push("Previous page: "+(i-1))),{info:t,items:a.items}}#u(e,s){const a=[];return s?(a.push(t(s,e)),a):a}#p(e,s){const t=[],o=this.#t;if(!o)return t;const n=e.getNetworkRequestById(o);t.push(`## Request ${n.url()}`),t.push(`Status:  ${r(n)}`),t.push("### Request Headers");for(const e of a(n.headers()))t.push(e);s.requestBody&&(t.push("### Request Body"),t.push(s.requestBody));const h=n.response();if(h){t.push("### Response Headers");for(const e of a(h.headers()))t.push(e)}s.responseBody&&(t.push("### Response Body"),t.push(s.responseBody));const p=n.failure();p&&(t.push("### Request failed with"),t.push(p.errorText));const u=n.redirectChain();if(u.length){t.push("### Redirect chain");let s=0;for(const a of u.reverse())t.push(`${"  ".repeat(s)}${i(a,e.getNetworkRequestStableId(a))}`),s++}try{const s=e.getNetworkRequestInitiator(o);if(s){t.push("### Initiator");for(const e of l(s))t.push(e)}}catch{}return t}resetResponseLineForTesting(){this.#o=[]}}