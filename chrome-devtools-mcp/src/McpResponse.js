/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{mapIssueToMessageObject as e}from"./DevtoolsUtils.js";import{formatConsoleEventShort as s,formatConsoleEventVerbose as t,formatConsoleMessagesForFile as a}from"./formatters/consoleFormatter.js";import{formatUrlForDetail as o,getFormattedHeaderValue as n,getFormattedResponseBody as i,getFormattedRequestBody as r,getShortDescriptionForRequest as h,getStatusFromRequest as p}from"./formatters/networkFormatter.js";import{formatSnapshotNode as u,formatSnapshotWithOptions as l}from"./formatters/snapshotFormatter.js";import{DevTools as g}from"./third_party/index.js";import{handleDialog as c}from"./tools/pages.js";import{formatInitiator as d}from"./utils/cdp.js";import{paginate as m}from"./utils/pagination.js";export class McpResponse{#e=!1;#s;#t;#a;#o=[];#n=[];#i;#r;#h;attachDevToolsData(e){this.#h=e}setIncludePages(e){this.#e=e}includeSnapshot(e){this.#s=e??{verbose:!1}}setIncludeNetworkRequests(e,s){this.#i=e?{include:e,pagination:s?.pageSize||s?.pageIdx?{pageSize:s.pageSize,pageIdx:s.pageIdx}:void 0,resourceTypes:s?.resourceTypes,includePreservedRequests:s?.includePreservedRequests,networkRequestIdInDevToolsUI:s?.networkRequestIdInDevToolsUI,filter:s?.filter}:void 0}setIncludeConsoleData(e,s){this.#r=e?{include:e,pagination:s?.pageSize||s?.pageIdx?{pageSize:s.pageSize,pageIdx:s.pageIdx}:void 0,types:s?.types,includePreservedMessages:s?.includePreservedMessages,savePath:s?.savePath,maxLineLength:s?.maxLineLength}:void 0}attachNetworkRequest(e){this.#t=e}attachConsoleMessage(e){this.#a=e}get includePages(){return this.#e}get includeNetworkRequests(){return this.#i?.include??!1}get includeConsoleData(){return this.#r?.include??!1}get attachedNetworkRequestId(){return this.#t}get networkRequestsPageIdx(){return this.#i?.pagination?.pageIdx}get consoleMessagesPageIdx(){return this.#r?.pagination?.pageIdx}get consoleMessagesTypes(){return this.#r?.types}appendResponseLine(e){this.#o.push(e)}attachImage(e){this.#n.push(e)}get responseLines(){return this.#o}get images(){return this.#n}get snapshotParams(){return this.#s}async handle(s,t){let o;if(this.#e&&await t.createPagesSnapshot(),this.#s){await t.createTextSnapshot(this.#s.verbose,this.#h);const e=t.getTextSnapshot();if(e){if(this.#s.search||void 0!==this.#s.pageSize||void 0!==this.#s.pageIdx){const s=l(e.root,e,{search:this.#s.search,pagination:void 0!==this.#s.pageSize||void 0!==this.#s.pageIdx?{pageSize:this.#s.pageSize,pageIdx:this.#s.pageIdx}:void 0}),a=[];if(this.#s.search&&a.push(`Search: "${this.#s.search}" - Found ${s.matchedElements} of ${s.totalElements} elements`),s.totalPages>1&&(a.push(`Page ${s.currentPage+1} of ${s.totalPages}`),s.hasNextPage&&a.push(`Next page: pageIdx=${s.currentPage+1}`),s.hasPreviousPage&&a.push("Previous page: pageIdx="+(s.currentPage-1))),this.#s.filePath){const e=a.length?a.join("\n")+"\n\n"+s.content:s.content;await t.saveFile((new TextEncoder).encode(e),this.#s.filePath),o=`Saved snapshot to ${this.#s.filePath}.`,a.length&&(o+="\n"+a.join("\n"))}else o=a.length?a.join("\n")+"\n\n"+s.content:s.content}else this.#s.filePath?(await t.saveFile((new TextEncoder).encode(u(e.root,e)),this.#s.filePath),o=`Saved snapshot to ${this.#s.filePath}.`):o=u(e.root,e)}}const n={};if(this.#t){const e=t.getNetworkRequestById(this.#t);n.requestBody=await r(e);const s=e.response();s&&(n.responseBody=await i(s))}let h,p;if(this.#a){const s=t.getConsoleMessageById(this.#a),a=this.#a;if("args"in s){const e=s;h={consoleMessageStableId:a,type:e.type(),message:e.text(),args:await Promise.all(e.args().map(async e=>{const s=await e.jsonValue().catch(()=>{});return"object"==typeof s?JSON.stringify(s):String(s)}))}}else if(s instanceof g.AggregatedIssue){const t=e(s);if(!t)throw new Error("Can't provide detals for the msgid "+a);h={consoleMessageStableId:a,...t}}else h={consoleMessageStableId:a,type:"error",message:s.message,args:[]}}if(this.#r?.include){let s=t.getConsoleData(this.#r.includePreservedMessages);if(this.#r.types?.length){const e=new Set(this.#r.types);s=s.filter(s=>"type"in s?e.has(s.type()):s instanceof g.AggregatedIssue?e.has("issue"):e.has("error"))}if(p=(await Promise.all(s.map(async s=>{const a=t.getConsoleMessageStableId(s);if("args"in s){const e=s;return{consoleMessageStableId:a,type:e.type(),message:e.text(),args:await Promise.all(e.args().map(async e=>{const s=await e.jsonValue().catch(()=>{});return"object"==typeof s?JSON.stringify(s):String(s)}))}}if(s instanceof g.AggregatedIssue){const t=e(s);return t?{consoleMessageStableId:a,...t}:null}return{consoleMessageStableId:a,type:"error",message:s.message,args:[]}}))).filter(e=>null!==e),this.#r.savePath&&p){const e=a(p);await t.saveFile((new TextEncoder).encode(e),this.#r.savePath)}}return this.format(s,t,{bodies:n,consoleData:h,consoleListData:p,formattedSnapshot:o})}format(e,t,a){const o=[`# ${e} response`];for(const e of this.#o)o.push(e);const n=t.getNetworkConditions();n&&(o.push("## Network emulation"),o.push(`Emulating: ${n}`),o.push(`Default navigation timeout set to ${t.getNavigationTimeout()} ms`));const i=t.getCpuThrottlingRate();i>1&&(o.push("## CPU emulation"),o.push(`Emulating: ${i}x slowdown`));const r=t.getDialog();if(r){const e="prompt"===r.type()?` (default value: "${r.defaultValue()}")`:"";o.push(`# Open dialog\n${r.type()}: ${r.message()}${e}.\nCall ${c.name} to handle it before continuing.`)}if(this.#e){const e=["## Pages"];let s=0;for(const a of t.getPages())e.push(`${s}: ${a.url()}${t.isPageSelected(a)?" [selected]":""}`),s++;o.push(...e)}if(a.formattedSnapshot&&(o.push("## Latest page snapshot"),o.push(a.formattedSnapshot)),o.push(...this.#p(t,a.bodies)),o.push(...this.#u(t,a.consoleData)),this.#i?.include){let e=t.getNetworkRequests(this.#i?.includePreservedRequests);if(this.#i.resourceTypes?.length){const s=new Set(this.#i.resourceTypes);e=e.filter(e=>{const t=e.resourceType();return s.has(t)})}if(this.#i.filter&&(e=e.filter(this.#i.filter)),o.push("## Network requests"),e.length){const s=this.#l(e,this.#i.pagination);o.push(...s.info);for(const e of s.items)o.push(h(e,t.getNetworkRequestStableId(e),t.getNetworkRequestStableId(e)===this.#i?.networkRequestIdInDevToolsUI))}else o.push("No requests found.")}if(this.#r?.include){const e=a.consoleListData??[];if(o.push("## Console messages"),this.#r.savePath)o.push(`Saved ${e.length} console messages to ${this.#r.savePath}`);else if(e.length){const t=this.#l(e,this.#r.pagination);o.push(...t.info);const a=this.#r.maxLineLength??500;o.push(...t.items.map(e=>s(e,a)))}else o.push("<no console messages found>")}return[{type:"text",text:o.join("\n")},...this.#n.map(e=>({type:"image",...e}))]}#l(e,s){const t=[],a=m(e,s);a.invalidPage&&t.push("Invalid page number provided. Showing first page.");const{startIndex:o,endIndex:n,currentPage:i,totalPages:r}=a;return t.push(`Showing ${o+1}-${n} of ${e.length} (Page ${i+1} of ${r}).`),s&&(a.hasNextPage&&t.push(`Next page: ${i+1}`),a.hasPreviousPage&&t.push("Previous page: "+(i-1))),{info:t,items:a.items}}#u(e,s){const a=[];return s?(a.push(t(s,e)),a):a}#p(e,s){const t=[],a=this.#t;if(!a)return t;const i=e.getNetworkRequestById(a),r=o(i.url());t.push(`## Request ${r[0]}`);for(let e=1;e<r.length;e++)t.push(r[e]);t.push(`Status:  ${p(i)}`),t.push("### Request Headers");for(const e of n(i.headers()))t.push(e);s.requestBody&&(t.push("### Request Body"),t.push(s.requestBody));const u=i.response();if(u){t.push("### Response Headers");for(const e of n(u.headers()))t.push(e)}s.responseBody&&(t.push("### Response Body"),t.push(s.responseBody));const l=i.failure();l&&(t.push("### Request failed with"),t.push(l.errorText));const g=i.redirectChain();if(g.length){t.push("### Redirect chain");let s=0;for(const a of g.reverse())t.push(`${"  ".repeat(s)}${h(a,e.getNetworkRequestStableId(a))}`),s++}try{const s=e.getNetworkRequestInitiator(a);if(s){t.push("### Initiator");for(const e of d(s))t.push(e)}}catch{}return t}resetResponseLineForTesting(){this.#o=[]}}