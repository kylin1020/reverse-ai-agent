/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import e from"node:fs/promises";import t from"node:os";import o from"node:path";import{extractUrlLikeFromDevToolsTitle as s,urlsEqual as r}from"./DevtoolsUtils.js";import{NetworkCollector as i,ConsoleCollector as a}from"./PageCollector.js";import{Locator as n}from"./third_party/index.js";import{ensureDebuggerEnabledForPage as l}from"./tools/debugger.js";import{initializeDebuggerForPage as g}from"./tools/debuggerUtils.js";import{listPages as c}from"./tools/pages.js";import{takeSnapshot as h}from"./tools/snapshot.js";import{CLOSE_PAGE_ERROR as d}from"./tools/ToolDefinition.js";import{getNetworkInitiator as p}from"./utils/cdp.js";import{WaitForHelper as u}from"./WaitForHelper.js";function w(e){switch(e){case"Fast 4G":return 1;case"Slow 4G":return 2.5;case"Fast 3G":return 5;case"Slow 3G":return 10}return 1}export class McpContext{browser;logger;#e=[];#t=new Map;#o;#s=null;#r;#i;#a=new WeakMap;#n=new WeakMap;#l=new WeakMap;#g;#c=1;#h;#d;constructor(e,t,o,s){this.browser=e,this.logger=t,this.#h=s,this.#d=o,this.#r=new i(this.browser),this.#i=new a(this.browser,e=>({console:t=>{e(t)},pageerror:t=>{if(t instanceof Error)e(t);else{const o=new Error(`${t}`);o.stack=void 0,e(o)}},issue:t=>{e(t)}}))}async#p(){const e=await this.createPagesSnapshot();if(this.#d.proxyAuth)for(const t of e)await this.#u(t);await this.#r.init(e),await this.#i.init(e)}async#u(e){this.#d.proxyAuth&&await e.authenticate({username:this.#d.proxyAuth.username,password:this.#d.proxyAuth.password})}dispose(){this.#r.dispose(),this.#i.dispose()}static async from(e,t,o,s=n){const r=new McpContext(e,t,o,s);return await r.#p(),r}resolveCdpRequestId(e){const t=this.getSelectedPage();if(!e)return void this.logger("no network request");const o=this.#r.find(t,t=>t.id===e);if(o)return this.#r.getIdForResource(o);this.logger("no network request for "+e)}resolveCdpElementId(e){if(!e)return void this.logger("no cdpBackendNodeId");if(null===this.#s)return void this.logger("no text snapshot");const t=[this.#s.root];for(;t.length;){const o=t.pop();if(o.backendNodeId===e)return o.id;for(const e of o.children)t.push(e)}}getNetworkRequests(e){const t=this.getSelectedPage();return this.#r.getData(t,e)}getConsoleData(e){const t=this.getSelectedPage();return this.#i.getData(t,e)}getConsoleMessageStableId(e){return this.#i.getIdForResource(e)}getConsoleMessageById(e){return this.#i.getById(this.getSelectedPage(),e)}async newPage(){const e=await this.browser.newPage();return await this.#u(e),await l(e).catch(e=>{this.logger("Error enabling debugger for new page",e)}),await this.createPagesSnapshot(),this.selectPage(e),this.#r.addPage(e),this.#i.addPage(e),e}async closePage(e){if(1===this.#e.length)throw new Error(d);const t=this.getPageByIdx(e);await t.close({runBeforeUnload:!1})}getNetworkRequestById(e){return this.#r.getById(this.getSelectedPage(),e)}setNetworkConditions(e){const t=this.getSelectedPage();null===e?this.#a.delete(t):this.#a.set(t,e),this.#w()}getNetworkConditions(){const e=this.getSelectedPage();return this.#a.get(e)??null}setCpuThrottlingRate(e){const t=this.getSelectedPage();this.#n.set(t,e),this.#w()}getCpuThrottlingRate(){const e=this.getSelectedPage();return this.#n.get(e)??1}setGeolocation(e){const t=this.getSelectedPage();null===e?this.#l.delete(t):this.#l.set(t,e)}getGeolocation(){const e=this.getSelectedPage();return this.#l.get(e)??null}getDialog(){return this.#g}clearDialog(){this.#g=void 0}getSelectedPage(){const e=this.#o;if(!e)throw new Error("No page selected");if(e.isClosed())throw new Error(`The selected page has been closed. Call ${c.name} to see open pages.`);return e}getPageByIdx(e){const t=this.#e[e];if(!t)throw new Error("No page found");return t}#f=e=>{this.#g=e};isPageSelected(e){return this.#o===e}selectPage(e){const t=this.#o;t&&(t.off("dialog",this.#f),t.emulateFocusedPage(!1).catch(e=>{this.logger("Error turning off focused page emulation",e)})),this.#o=e,e.on("dialog",this.#f),this.#w(),e.emulateFocusedPage(!0).catch(e=>{this.logger("Error turning on focused page emulation",e)}),g(e).catch(e=>{this.logger("Error initializing debugger for page",e)})}#w(){const e=this.getSelectedPage(),t=this.getCpuThrottlingRate();e.setDefaultTimeout(5e3*t);const o=w(this.getNetworkConditions());e.setDefaultNavigationTimeout(1e4*o)}getNavigationTimeout(){return this.getSelectedPage().getDefaultNavigationTimeout()}getAXNodeByUid(e){return this.#s?.idToNode.get(e)}async getElementByUid(e){if(!this.#s?.idToNode.size)throw new Error(`No snapshot found. Use ${h.name} to capture one.`);const[t]=e.split("_");if(this.#s.snapshotId!==t)throw new Error("This uid is coming from a stale snapshot. Call take_snapshot to get a fresh snapshot.");const o=this.#s?.idToNode.get(e);if(!o)throw new Error("No such element found in the snapshot");const s=await o.elementHandle();if(!s)throw new Error("No such element found in the snapshot");return s}async createPagesSnapshot(){const e=await this.browser.pages(this.#d.experimentalIncludeAllPages);return this.#e=e.filter(e=>this.#d.experimentalDevToolsDebugging||!e.url().startsWith("devtools://")),this.#o&&-1!==this.#e.indexOf(this.#o)||!this.#e[0]||this.selectPage(this.#e[0]),await this.detectOpenDevToolsWindows(),this.#e}async detectOpenDevToolsWindows(){this.logger("Detecting open DevTools windows");const e=await this.browser.pages(this.#d.experimentalIncludeAllPages);this.#t=new Map;for(const t of e)if(t.url().startsWith("devtools://"))try{this.logger("Calling getTargetInfo for "+t.url());const e=(await t._client().send("Target.getTargetInfo")).targetInfo.title,o=s(e);if(!o)continue;for(const e of this.#e)r(e.url(),o)&&this.#t.set(e,t)}catch(e){this.logger("Issue occurred while trying to find DevTools",e)}}getPages(){return this.#e}getDevToolsPage(e){return this.#t.get(e)}async getDevToolsData(){try{this.logger("Getting DevTools UI data");const e=this.getSelectedPage(),t=this.getDevToolsPage(e);if(!t)return this.logger("No DevTools page detected"),{};const{cdpRequestId:o,cdpBackendNodeId:s}=await t.evaluate(async()=>{const e=await import("/bundled/ui/legacy/legacy.js"),t=await import("/bundled/core/sdk/sdk.js"),o=e.Context.Context.instance().flavor(t.NetworkRequest.NetworkRequest),s=e.Context.Context.instance().flavor(t.DOMModel.DOMNode);return{cdpRequestId:o?.requestId(),cdpBackendNodeId:s?.backendNodeId()}});return{cdpBackendNodeId:s,cdpRequestId:o}}catch(e){this.logger("error getting devtools data",e)}return{}}async createTextSnapshot(e=!1,t=void 0){const o=this.getSelectedPage(),s=await o.accessibility.snapshot({includeIframes:!0,interestingOnly:!e});if(!s)return;const r=this.#c++;let i=0;const a=new Map,n=e=>{const t={...e,id:`${r}_${i++}`,children:e.children?e.children.map(e=>n(e)):[]};if("option"===e.role){const o=e.name;o&&(t.value=o.toString())}return a.set(t.id,t),t},l=n(s);this.#s={root:l,snapshotId:String(r),idToNode:a,hasSelectedElement:!1,verbose:e};const g=t??await this.getDevToolsData();g?.cdpBackendNodeId&&(this.#s.hasSelectedElement=!0,this.#s.selectedElementUid=this.resolveCdpElementId(g?.cdpBackendNodeId))}getTextSnapshot(){return this.#s}async saveTemporaryFile(s,r){try{const i=await e.mkdtemp(o.join(t.tmpdir(),"chrome-devtools-mcp-")),a=o.join(i,`screenshot.${function(e){switch(e){case"image/png":return"png";case"image/jpeg":return"jpeg";case"image/webp":return"webp"}throw new Error(`No mapping for Mime type ${e}.`)}(r)}`);return await e.writeFile(a,s),{filename:a}}catch(e){throw this.logger(e),new Error("Could not save a screenshot to a file",{cause:e})}}async saveFile(t,s){try{const r=o.resolve(s);return await e.writeFile(r,t),{filename:s}}catch(e){throw this.logger(e),new Error("Could not save a screenshot to a file",{cause:e})}}getWaitForHelper(e,t,o){return new u(e,t,o)}waitForEventsAfterAction(e){const t=this.getSelectedPage(),o=this.getCpuThrottlingRate(),s=w(this.getNetworkConditions());return this.getWaitForHelper(t,o,s).waitForEventsAfterAction(e)}getNetworkRequestStableId(e){return this.#r.getIdForResource(e)}getNetworkRequestInitiator(e){const t=this.getSelectedPage(),o=this.#r.getById(t,e).id;if(o)return p(t,o)}waitForTextOnPage(e,t){const o=this.getSelectedPage().frames();let s=this.#h.race(o.flatMap(t=>[t.locator(`aria/${e}`),t.locator(`text/${e}`)]));return t&&(s=s.setTimeout(t)),s.wait()}async setUpNetworkCollectorForTesting(){this.#r=new i(this.browser,e=>({request:t=>{t.url().includes("favicon.ico")||e(t)}})),await this.#r.init(await this.browser.pages())}}