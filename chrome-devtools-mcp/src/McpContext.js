/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import e from"node:fs/promises";import t from"node:os";import o from"node:path";import{launch as s}from"./browser.js";import{extractUrlLikeFromDevToolsTitle as r,urlsEqual as a}from"./DevtoolsUtils.js";import{NetworkCollector as i,ConsoleCollector as n}from"./PageCollector.js";import{Locator as l}from"./third_party/index.js";import{listPages as c}from"./tools/pages.js";import{takeSnapshot as g}from"./tools/snapshot.js";import{CLOSE_PAGE_ERROR as h}from"./tools/ToolDefinition.js";import{disposeCdpSession as d,getNetworkInitiator as p}from"./utils/cdp.js";import{initializeDebuggerForPage as u}from"./utils/debuggerUtils.js";import{WaitForHelper as w}from"./WaitForHelper.js";function f(e){switch(e){case"Fast 4G":return 1;case"Slow 4G":return 2.5;case"Fast 3G":return 5;case"Slow 3G":return 10}return 1}export class McpContext{browser;logger;#e=new Set;#t=[];#o=new Map;#s;#r=null;#a;#i;#n=new WeakMap;#l=new WeakMap;#c=new WeakMap;#g;#h=1;#d;#p;constructor(e,t,o,s){this.browser=e,this.#e.add(e),this.logger=t,this.#d=s,this.#p=o,this.#a=new i(this.browser),this.#i=new n(this.browser,e=>({console:t=>{e(t)},pageerror:t=>{if(t instanceof Error)e(t);else{const o=new Error(`${t}`);o.stack=void 0,e(o)}},issue:t=>{e(t)}}))}async#u(){const e=await this.createPagesSnapshot();for(const t of e)this.#p.proxyAuth&&await this.#w(t),await u(t).catch(e=>{this.logger("Error enabling debugger for existing page during init",e)});await this.#a.init(e),await this.#i.init(e),this.browser.on("targetcreated",this.#f)}#f=async e=>{try{const t=await e.page();if(!t)return;await u(t).catch(e=>{this.logger("Error enabling debugger for externally created page",e)})}catch(e){this.logger("Error handling targetcreated event",e)}};async#w(e){this.#p.proxyAuth&&await e.authenticate({username:this.#p.proxyAuth.username,password:this.#p.proxyAuth.password})}dispose(){this.#a.dispose(),this.#i.dispose();for(const e of this.#e)e.off("targetcreated",this.#f);for(const e of this.#t)d(e)}static async from(e,t,o,s=l){const r=new McpContext(e,t,o,s);return await r.#u(),r}resolveCdpRequestId(e){const t=this.getSelectedPage();if(!e)return void this.logger("no network request");const o=this.#a.find(t,t=>t.id===e);if(o)return this.#a.getIdForResource(o);this.logger("no network request for "+e)}resolveCdpElementId(e){if(!e)return void this.logger("no cdpBackendNodeId");if(null===this.#r)return void this.logger("no text snapshot");const t=[this.#r.root];for(;t.length;){const o=t.pop();if(o.backendNodeId===e)return o.id;for(const e of o.children)t.push(e)}}getNetworkRequests(e){const t=this.getSelectedPage();return this.#a.getData(t,e)}getConsoleData(e){const t=this.getSelectedPage();return this.#i.getData(t,e)}getConsoleMessageStableId(e){return this.#i.getIdForResource(e)}getConsoleMessageById(e){return this.#i.getById(this.getSelectedPage(),e)}async newPage(e){let t;if(e?.userDataDir){if(!this.#p.launchOptions)throw new Error("Launch options are required to start a new browser instance with userDataDir");const o=await s({...this.#p.launchOptions,userDataDir:e.userDataDir,isolated:!0});this.#e.add(o),this.#a.addBrowser(o),this.#i.addBrowser(o),o.on("targetcreated",this.#f);t=(await o.pages())[0]||await o.newPage()}else if(e?.incognito||e?.newWindow){const e=await this.browser.createBrowserContext();t=await e.newPage()}else t=await this.browser.newPage();return await this.#w(t),await u(t).catch(e=>{this.logger("Error enabling debugger for new page",e)}),await this.createPagesSnapshot(),this.selectPage(t),this.#a.addPage(t),this.#i.addPage(t),t}async closePage(e){if(1===this.#t.length)throw new Error(h);const t=this.getPageByIdx(e);await d(t),await t.close({runBeforeUnload:!1})}getNetworkRequestById(e){return this.#a.getById(this.getSelectedPage(),e)}setNetworkConditions(e){const t=this.getSelectedPage();null===e?this.#n.delete(t):this.#n.set(t,e),this.#m()}getNetworkConditions(){const e=this.getSelectedPage();return this.#n.get(e)??null}setCpuThrottlingRate(e){const t=this.getSelectedPage();this.#l.set(t,e),this.#m()}getCpuThrottlingRate(){const e=this.getSelectedPage();return this.#l.get(e)??1}setGeolocation(e){const t=this.getSelectedPage();null===e?this.#c.delete(t):this.#c.set(t,e)}getGeolocation(){const e=this.getSelectedPage();return this.#c.get(e)??null}getDialog(){return this.#g}clearDialog(){this.#g=void 0}getSelectedPage(){const e=this.#s;if(!e)throw new Error("No page selected");if(e.isClosed())throw new Error(`The selected page has been closed. Call ${c.name} to see open pages.`);return e}getPageByIdx(e){const t=this.#t[e];if(!t)throw new Error("No page found");return t}#C=e=>{this.#g=e};isPageSelected(e){return this.#s===e}selectPage(e){const t=this.#s;t&&(t.off("dialog",this.#C),t.emulateFocusedPage(!1).catch(e=>{this.logger("Error turning off focused page emulation",e)})),this.#s=e,e.on("dialog",this.#C),this.#m(),e.emulateFocusedPage(!0).catch(e=>{this.logger("Error turning on focused page emulation",e)}),u(e).catch(e=>{this.logger("Error initializing debugger for page",e)})}#m(){const e=this.getSelectedPage(),t=this.getCpuThrottlingRate();e.setDefaultTimeout(5e3*t);const o=f(this.getNetworkConditions());e.setDefaultNavigationTimeout(1e4*o)}getNavigationTimeout(){return this.getSelectedPage().getDefaultNavigationTimeout()}getAXNodeByUid(e){return this.#r?.idToNode.get(e)}async getElementByUid(e){if(!this.#r?.idToNode.size)throw new Error(`No snapshot found. Use ${g.name} to capture one.`);const[t]=e.split("_");if(this.#r.snapshotId!==t)throw new Error("This uid is coming from a stale snapshot. Call take_snapshot to get a fresh snapshot.");const o=this.#r?.idToNode.get(e);if(!o)throw new Error("No such element found in the snapshot");const s=await o.elementHandle();if(!s)throw new Error("No such element found in the snapshot");return s}async createPagesSnapshot(){const e=[];for(const t of this.#e){const o=await t.pages(this.#p.experimentalIncludeAllPages);e.push(...o)}return this.#t=e.filter(e=>this.#p.experimentalDevToolsDebugging||!e.url().startsWith("devtools://")),this.#s&&-1!==this.#t.indexOf(this.#s)||!this.#t[0]||this.selectPage(this.#t[0]),await this.detectOpenDevToolsWindows(),this.#t}async detectOpenDevToolsWindows(){this.logger("Detecting open DevTools windows");const e=[];for(const t of this.#e){const o=await t.pages(this.#p.experimentalIncludeAllPages);e.push(...o)}this.#o=new Map;for(const t of e)if(t.url().startsWith("devtools://"))try{this.logger("Calling getTargetInfo for "+t.url());const e=(await t._client().send("Target.getTargetInfo")).targetInfo.title,o=r(e);if(!o)continue;for(const e of this.#t)a(e.url(),o)&&this.#o.set(e,t)}catch(e){this.logger("Issue occurred while trying to find DevTools",e)}}getPages(){return this.#t}getDevToolsPage(e){return this.#o.get(e)}async getDevToolsData(){try{this.logger("Getting DevTools UI data");const e=this.getSelectedPage(),t=this.getDevToolsPage(e);if(!t)return this.logger("No DevTools page detected"),{};const{cdpRequestId:o,cdpBackendNodeId:s}=await t.evaluate(async()=>{const e=await import("/bundled/ui/legacy/legacy.js"),t=await import("/bundled/core/sdk/sdk.js"),o=e.Context.Context.instance().flavor(t.NetworkRequest.NetworkRequest),s=e.Context.Context.instance().flavor(t.DOMModel.DOMNode);return{cdpRequestId:o?.requestId(),cdpBackendNodeId:s?.backendNodeId()}});return{cdpBackendNodeId:s,cdpRequestId:o}}catch(e){this.logger("error getting devtools data",e)}return{}}async createTextSnapshot(e=!1,t=void 0){const o=this.getSelectedPage(),s=await o.accessibility.snapshot({includeIframes:!0,interestingOnly:!e});if(!s)return;const r=this.#h++;let a=0;const i=new Map,n=e=>{const t={...e,id:`${r}_${a++}`,children:e.children?e.children.map(e=>n(e)):[]};if("option"===e.role){const o=e.name;o&&(t.value=o.toString())}return i.set(t.id,t),t},l=n(s);this.#r={root:l,snapshotId:String(r),idToNode:i,hasSelectedElement:!1,verbose:e};const c=t??await this.getDevToolsData();c?.cdpBackendNodeId&&(this.#r.hasSelectedElement=!0,this.#r.selectedElementUid=this.resolveCdpElementId(c?.cdpBackendNodeId))}getTextSnapshot(){return this.#r}async saveTemporaryFile(s,r){try{const a=await e.mkdtemp(o.join(t.tmpdir(),"chrome-devtools-mcp-")),i=o.join(a,`screenshot.${function(e){switch(e){case"image/png":return"png";case"image/jpeg":return"jpeg";case"image/webp":return"webp"}throw new Error(`No mapping for Mime type ${e}.`)}(r)}`);return await e.writeFile(i,s),{filename:i}}catch(e){throw this.logger(e),new Error("Could not save a screenshot to a file",{cause:e})}}async saveFile(t,s){try{const r=o.isAbsolute(s)?s:o.join(process.cwd(),s);return await e.mkdir(o.dirname(r),{recursive:!0}),await e.writeFile(r,t),{filename:r}}catch(e){throw this.logger(e),new Error(`Could not save to file ${s}`,{cause:e})}}getWaitForHelper(e,t,o){return new w(e,t,o)}waitForEventsAfterAction(e){const t=this.getSelectedPage(),o=this.getCpuThrottlingRate(),s=f(this.getNetworkConditions());return this.getWaitForHelper(t,o,s).waitForEventsAfterAction(e)}getNetworkRequestStableId(e){return this.#a.getIdForResource(e)}getNetworkRequestInitiator(e){const t=this.getSelectedPage(),o=this.#a.getById(t,e).id;if(o)return p(t,o)}waitForTextOnPage(e,t){const o=this.getSelectedPage().frames();let s=this.#d.race(o.flatMap(t=>[t.locator(`aria/${e}`),t.locator(`text/${e}`)]));return t&&(s=s.setTimeout(t)),s.wait()}async setUpNetworkCollectorForTesting(){this.#a=new i(this.browser,e=>({request:t=>{t.url().includes("favicon.ico")||e(t)}})),await this.#a.init(await this.browser.pages())}}